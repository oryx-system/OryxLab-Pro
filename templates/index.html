{% extends "base.html" %}

{% block content %}
<!-- Floating Notice Banner -->
<div class="notice-banner">
    <div class="d-flex align-items-center w-100">
        <!-- Secret Admin Entrance: Click 5 times in 10s -->
        <div id="noticeIcon" class="rounded-circle bg-primary bg-opacity-10 p-3 me-3 text-primary"
            style="cursor: pointer; transition: transform 0.1s;">
            <i class="fas fa-bullhorn fa-lg"></i>
        </div>
        <div>
            <h5 class="mb-1 fw-bold">공지사항</h5>
            <p class="mb-0 opacity-75">{{ notice }}</p>
        </div>
    </div>
</div>

<!-- Floating Feedback Button -->
<button class="btn btn-dark rounded-circle shadow-lg position-fixed bottom-0 end-0 m-4"
    style="width: 60px; height: 60px; z-index: 1050;" title="버그 제보 및 건의사항" data-bs-toggle="modal"
    data-bs-target="#feedbackModal">
    <i class="fas fa-comment-dots fa-lg"></i>
</button>


<div class="row gx-5">
    <!-- Full Width Calendar -->
    <div class="col-lg-12">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-body p-0">
                <div id="calendar" class="p-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Reservation Modal -->
<div class="modal fade" id="reserveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold text-white">
                    <i class="fas fa-calendar-check me-2"></i>예약하기
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="reservationForm">
                    <!-- Date & Time -->
                    <div class="bg-light rounded-3 p-3 mb-4 text-center">
                        <h4 class="fw-bold text-primary mb-3" id="displayDate"></h4>
                        <input type="hidden" id="resDate">
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <select class="form-select form-select-lg fw-bold text-center border-0 shadow-sm"
                                id="resStartTime" style="width: 120px;"></select>
                            <span class="text-muted">~</span>
                            <select class="form-select form-select-lg fw-bold text-center border-0 shadow-sm"
                                id="resEndTime" style="width: 120px;"></select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">이름</label>
                        <input type="text" class="form-control" id="resName" required placeholder="예: 홍길동">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">전화번호</label>
                        <input type="tel" class="form-control" id="resPhone" required placeholder="예: 01012345678">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">비밀번호</label>
                        <input type="password" class="form-control" id="resPassword" required placeholder="숫자 4자리"
                            inputmode="numeric" pattern="[0-9]*" maxlength="4">
                        <div class="form-text small" style="color: #6c757d;">
                            ※ 나중에 예약을 확인하거나 취소할 때 사용됩니다.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">사용 목적</label>
                        <input type="text" class="form-control" id="resPurpose" required
                            placeholder="예: 독서 모임, 코딩 수업, 인문학 강의 등">
                    </div>

                    <!-- Collapsible Optional Fields Section -->
                    <div class="mb-3">
                        <a class="text-decoration-none small" data-bs-toggle="collapse" href="#optionalFields"
                            role="button" aria-expanded="false" aria-controls="optionalFields">
                            <i class="fas fa-chevron-down me-1"></i>추가 정보 입력 <span class="text-muted">(선택사항)</span>
                        </a>
                        <div class="collapse mt-2" id="optionalFields">
                            <div class="card card-body bg-light border-0 py-3">
                                <!-- Applicant Type -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold small mb-1">신청자 유형</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="applicantType"
                                                id="typePersonal" value="개인" checked onchange="toggleOrgName()">
                                            <label class="form-check-label small" for="typePersonal">개인</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="applicantType"
                                                id="typeGroup" value="단체" onchange="toggleOrgName()">
                                            <label class="form-check-label small" for="typeGroup">단체</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Org Name (shows when 단체 selected) -->
                                <div class="mb-3" id="orgNameField" style="display: none;">
                                    <label class="form-label fw-bold small mb-1">단체명</label>
                                    <input type="text" class="form-control form-control-sm" id="resOrgName"
                                        placeholder="예: ○○독서모임">
                                </div>

                                <!-- Facilities -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold small mb-1">사용시설</label>
                                    <div>
                                        <div class="mb-1">
                                            <span class="small text-muted">기본:</span>
                                            <label class="small ms-1 me-2"><input type="checkbox" id="facLib"
                                                    value="자료실" class="me-1">자료실</label>
                                            <label class="small me-2"><input type="checkbox" id="facCulture"
                                                    value="문화강좌실" class="me-1">문화강좌실</label>
                                            <label class="small"><input type="checkbox" id="facCook" value="조리실"
                                                    class="me-1">조리실</label>
                                        </div>
                                        <div>
                                            <span class="small text-muted">부대:</span>
                                            <label class="small ms-1 me-2"><input type="checkbox" id="facBeam"
                                                    value="빔프로젝트" class="me-1">빔프로젝트</label>
                                            <label class="small"><input type="checkbox" id="facScreen" value="스크린"
                                                    class="me-1">스크린</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Expected Count with default value -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold small mb-1">이용예정인원</label>
                                    <input type="number" class="form-control form-control-sm" id="resExpectedCount"
                                        min="0" max="100" value="0" style="width: 100px;">
                                </div>

                                <!-- Birth Date & Email Row -->
                                <div class="row">
                                    <div class="col-6 mb-2">
                                        <label class="form-label fw-bold small mb-1">생년월일</label>
                                        <input type="text" class="form-control form-control-sm" id="resBirthDate"
                                            placeholder="1990-01-01">
                                    </div>
                                    <div class="col-6 mb-2">
                                        <label class="form-label fw-bold small mb-1">이메일</label>
                                        <input type="email" class="form-control form-control-sm" id="resEmail"
                                            placeholder="example@mail.com">
                                    </div>
                                </div>

                                <!-- Address -->
                                <div>
                                    <label class="form-label fw-bold small mb-1">주소</label>
                                    <input type="text" class="form-control form-control-sm" id="resAddress"
                                        placeholder="충남 금산군...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recurring Reservation -->
                    <div class="mb-4 p-3 bg-light rounded shadow-sm">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="checkRecurring">
                            <label class="form-check-label fw-bold" for="checkRecurring">
                                정기 예약 설정 <span class="badge bg-success ms-1">New</span>
                            </label>
                            <small class="d-block text-muted">매주 같은 시간에 반복해서 예약합니다.</small>
                        </div>
                        <div class="mt-3 ps-2" id="recurringOptions" style="display: none;">
                            <label class="form-label small fw-bold mb-1">총 반복 횟수 (이번 주 포함)</label>
                            <select class="form-select form-select-sm" id="repeatCount">
                                <option value="2">2주 (2회)</option>
                                <option value="3">3주 (3회)</option>
                                <option value="4">4주 (4회)</option>
                            </select>
                            <div class="form-text small text-info">
                                <i class="fas fa-info-circle me-1"></i>선택한 날짜부터 <strong>매주 1회씩</strong> 자동 예약됩니다.<br>
                                (예: 4주 선택 시 오늘, 다음 주, 다다음 주, 3주 후 예약)
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="rememberMe" checked>
                        <label class="form-check-label" for="rememberMe">내 정보 기억하기</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">이용 약관</label>
                        <div class="terms-box" id="termsBox">
                            {{ privacy_policy | safe if privacy_policy else '<p class="text-center py-5 text-muted">등록된
                                약관이 없습니다.</p>' | safe }}
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" disabled>
                            <label class="form-check-label" for="agreeTerms">위 약관에 동의합니다.</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">전자 서명 (필수)</label>

                        <!-- Signature Preview Area -->
                        <div id="signaturePreview" class="border rounded bg-white text-center p-3 mb-2"
                            style="display: none; background-color: #f8f9fa;">
                            <img id="sigImage" src="" class="img-fluid" style="max-height: 100px;">
                        </div>

                        <!-- Open Modal Button -->
                        <button type="button" class="btn btn-outline-dark w-100 py-3 border-2 border-dashed"
                            id="btnOpenSignModal">
                            <i class="fas fa-signature me-2"></i>서명하기 (터치)
                        </button>
                    </div>


                </form>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary rounded-pill px-5" id="btnSubmit">예약 신청</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center overflow-hidden border-0">
            <div class="modal-body p-5">
                <div class="mb-4 text-success rubberBand animated">
                    <i class="fas fa-check-circle fa-6x"
                        style="filter: drop-shadow(0 5px 15px rgba(25, 135, 84, 0.4));"></i>
                </div>
                <h3 class="fw-bold mb-2">예약 완료!</h3>
                <p class="text-muted mb-4">입실 시 <strong>QR 체크인</strong>을 꼭 진행해주세요.</p>
                <div class="d-grid gap-3">
                    <a href="#" class="btn btn-primary btn-lg shadow" id="btnDownloadIcs">
                        <i class="fas fa-calendar-alt me-2"></i> 내 캘린더에 저장 (.ics)
                    </a>
                    <button type="button" class="btn btn-outline-secondary rounded-pill"
                        data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold text-white"><i class="fas fa-comment-dots me-2"></i>기능 제안 및 버그 신고</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">서비스 이용 중 불편한 점이나 추가되었으면 하는 기능이 있다면 자유롭게 남겨주세요.</p>
                <textarea class="form-control" id="feedbackMsg" rows="5" placeholder="내용을 입력해주세요..."></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-dark rounded-pill px-4" id="btnSendFeedback">보내기</button>
            </div>
        </div>
    </div>
</div>

<!-- Full Screen Signature Modal -->
<!-- Full Screen Signature Modal -->
<div class="modal fade" id="signatureModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content border-0">
            <div class="modal-body p-0 position-relative bg-light d-flex align-items-center justify-content-center"
                style="touch-action: none; overflow: hidden;">

                <!-- Full Screen Canvas -->
                <canvas id="fsSignaturePad"
                    style="background: white; cursor: crosshair; touch-action: none; width: 100%; height: 100%; display: block;"></canvas>

                <!-- Floating Controls -->
                <!-- Close Button (Top Right) -->
                <button type="button"
                    class="btn btn-dark btn-sm rounded-circle shadow position-absolute top-0 end-0 m-3"
                    id="btnCloseSignModal" style="width: 40px; height: 40px; z-index: 100;">
                    <i class="fas fa-times"></i>
                </button>

                <!-- Helper Text (Top Center) -->
                <div
                    class="position-absolute top-0 start-50 translate-middle-x mt-3 text-muted small opacity-50 user-select-none pointer-events-none">
                    <i class="fas fa-pen-nib me-1"></i>화면 전체를 사용하여 서명해주세요.
                </div>

                <!-- Floating Action Buttons (Bottom Center) -->
                <div class="position-absolute bottom-0 start-50 translate-middle-x mb-4 d-flex gap-2"
                    style="z-index: 100;">
                    <button type="button" class="btn btn-secondary rounded-pill px-3 py-2 shadow-lg btn-sm"
                        id="btnSignClear" style="min-width: 80px;">
                        <i class="fas fa-redo me-1"></i>지우기
                    </button>
                    <button type="button" class="btn btn-primary rounded-pill px-4 py-2 shadow-lg fw-bold btn-sm"
                        id="btnSignConfirm" style="min-width: 100px;">
                        <i class="fas fa-check me-2"></i>완료
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>
</div>


{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var reserveModal = new bootstrap.Modal(document.getElementById('reserveModal'));
        var successModal = new bootstrap.Modal(document.getElementById('successModal'));
        let selectedDate = null;

        // Secret Admin Access (5 clicks in 10s)
        let clickCount = 0;
        let clickTimer = null;
        const noticeIcon = document.getElementById('noticeIcon');

        if (noticeIcon) {
            noticeIcon.addEventListener('click', function () {
                clickCount++;

                if (clickCount === 1) {
                    // Start 10s timer on first click
                    clickTimer = setTimeout(() => {
                        clickCount = 0; // Reset after 10s
                    }, 10000);
                }

                if (clickCount >= 5) {
                    clearTimeout(clickTimer);
                    clickCount = 0;
                    // Stealth Redirect
                    window.location.href = '/dev-login';
                }
            });
        }

        // Populate Time Dropdowns (09:00 to 22:00)
        function populateTimeOptions() {
            const startSelect = document.getElementById('resStartTime');
            const endSelect = document.getElementById('resEndTime');
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';

            for (let i = 9; i <= 21; i++) {
                const hour = i.toString().padStart(2, '0');
                // 1시간 단위로 변경
                startSelect.innerHTML += `<option value="${hour}:00">${hour}:00</option>`;

                // End time (1시간 단위)
                const endHour = (i + 1).toString().padStart(2, '0');
                endSelect.innerHTML += `<option value="${endHour}:00">${endHour}:00</option>`;
            }
        }
        populateTimeOptions();

        // Update end time options based on start time
        document.getElementById('resStartTime').addEventListener('change', function () {
            const startValue = this.value;
            const endSelect = document.getElementById('resEndTime');

            Array.from(endSelect.options).forEach(option => {
                // Disable options that are <= start time
                if (option.value <= startValue) {
                    option.disabled = true;
                    option.style.color = '#ccc';
                } else {
                    option.disabled = false;
                    option.style.color = '';
                }
            });

            // If current selection is invalid, select first valid option
            if (endSelect.value <= startValue) {
                const firstValid = Array.from(endSelect.options).find(opt => opt.value > startValue);
                if (firstValid) {
                    endSelect.value = firstValid.value;
                }
            }
        });

        // Load Remembered Info (including optional fields)
        document.getElementById('rememberMe').checked = true;
        document.getElementById('resName').value = localStorage.getItem('userName') || '';
        document.getElementById('resPhone').value = localStorage.getItem('userPhone') || '';
        document.getElementById('resPassword').value = localStorage.getItem('userPassword') || '';
        // Optional fields auto-load
        document.getElementById('resAddress').value = localStorage.getItem('userAddress') || '';
        document.getElementById('resEmail').value = localStorage.getItem('userEmail') || '';
        document.getElementById('resBirthDate').value = localStorage.getItem('userBirthDate') || '';



        // Terms Scroll
        const termsBox = document.getElementById('termsBox');
        termsBox.addEventListener('scroll', function () {
            if (termsBox.scrollTop + termsBox.clientHeight >= termsBox.scrollHeight - 5) {
                document.getElementById('agreeTerms').disabled = false;
            }
        });

        // --- Full Screen Signature Logic ---
        const btnOpenSign = document.getElementById('btnOpenSignModal');
        const signModalEl = document.getElementById('signatureModal');
        const signModal = new bootstrap.Modal(signModalEl);
        const btnCloseSign = document.getElementById('btnCloseSignModal');

        const fsCanvas = document.getElementById('fsSignaturePad');
        const fsCtx = fsCanvas.getContext('2d');
        let isDrawing = false;
        let hasSignature = false; // Tracks if current session has drawing
        let finalSignatureData = null; // Stores confirmed signature

        // Resize Full Screen Canvas
        function resizeFsCanvas() {
            const isLandscape = window.innerWidth > window.innerHeight;

            if (isLandscape) {
                // Landscape: Full Screen
                fsCanvas.width = window.innerWidth;
                fsCanvas.height = window.innerHeight;

                // CRITICAL: Reset explicit styles so attribute-based tokens work 1:1
                fsCanvas.style.width = '';
                fsCanvas.style.height = '';

                fsCanvas.style.borderRadius = "0";
                fsCanvas.style.boxShadow = "none";
            } else {
                // Portrait: Boxed Mode
                // 90% of width, Aspect Ratio 1.6:1
                const width = window.innerWidth * 0.95;
                const height = width / 1.6;

                fsCanvas.width = width;
                fsCanvas.height = height;

                // Add visual frame for "Box" feel
                fsCanvas.style.width = `${width}px`;
                fsCanvas.style.height = `${height}px`;
                fsCanvas.style.borderRadius = "12px";
                fsCanvas.style.boxShadow = "0 10px 30px rgba(0,0,0,0.2)";
            }

            fsCtx.lineWidth = 3;
            fsCtx.lineCap = 'round';
            fsCtx.strokeStyle = '#000';
        }

        // Listen to resize to adapt dynamically
        window.addEventListener('resize', resizeFsCanvas);

        // Open Modal
        btnOpenSign.addEventListener('click', function () {
            signModal.show();
        });

        // When Modal Shows
        signModalEl.addEventListener('shown.bs.modal', function () {
            resizeFsCanvas();
            fsCtx.clearRect(0, 0, fsCanvas.width, fsCanvas.height);
            hasSignature = false; // Reset current drawing state
        });

        // Drawing Events (Touch & Mouse)
        function getFsPos(e) {
            const rect = fsCanvas.getBoundingClientRect();
            let x, y;
            if (e.touches && e.touches.length > 0) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return { x, y };
        }

        function fsStart(e) {
            isDrawing = true;
            hasSignature = true;
            const { x, y } = getFsPos(e);
            fsCtx.beginPath();
            fsCtx.moveTo(x, y);
            e.preventDefault();
        }

        function fsDraw(e) {
            if (!isDrawing) return;
            const { x, y } = getFsPos(e);
            fsCtx.lineTo(x, y);
            fsCtx.stroke();
            e.preventDefault();
        }

        function fsStop() {
            isDrawing = false;
            fsCtx.beginPath();
        }

        fsCanvas.addEventListener('mousedown', fsStart);
        fsCanvas.addEventListener('mousemove', fsDraw);
        fsCanvas.addEventListener('mouseup', fsStop);
        fsCanvas.addEventListener('mouseout', fsStop);

        fsCanvas.addEventListener('touchstart', fsStart, { passive: false });
        fsCanvas.addEventListener('touchmove', fsDraw, { passive: false });
        fsCanvas.addEventListener('touchend', fsStop);

        // Clear Button (In Modal)
        document.getElementById('btnSignClear').addEventListener('click', function () {
            fsCtx.clearRect(0, 0, fsCanvas.width, fsCanvas.height);
            hasSignature = false;
        });

        // Helper: Trim Canvas Whitespace & Scale to High Res
        function trimCanvas(c) {
            const ctx = c.getContext('2d');
            const w = c.width;
            const h = c.height;
            const pix = { x: [], y: [] };
            const imageData = ctx.getImageData(0, 0, w, h);
            const data = imageData.data;

            // 1. Scan for non-transparent/non-white pixels
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const idx = (y * w + x) * 4;
                    // Check alpha > 0 (data[idx+3]) and not white (r,g,b < 255)
                    // Since we draw black on transparent/white...
                    // Check if alpha is high enough
                    if (data[idx + 3] > 0) {
                        pix.x.push(x);
                        pix.y.push(y);
                    }
                }
            }

            if (pix.x.length === 0) return null; // Empty

            // 2. Determine Bounding Box
            pix.x.sort((a, b) => a - b);
            pix.y.sort((a, b) => a - b);
            const n = pix.x.length;
            const minX = pix.x[0];
            const minY = pix.y[0];
            const maxX = pix.x[n - 1];
            const maxY = pix.y[n - 1];

            // Add padding
            const padding = 10;
            const cw = maxX - minX + (padding * 2);
            const ch = maxY - minY + (padding * 2);

            // 3. Create Trimmed Canvas
            const trimmed = document.createElement('canvas');
            trimmed.width = cw;
            trimmed.height = ch;
            const tCtx = trimmed.getContext('2d');

            // Draw cropped area
            tCtx.drawImage(c, minX - padding, minY - padding, cw, ch, 0, 0, cw, ch);

            // 4. High-Res Scaling (Target Width ~ 600px for 200 DPI look)
            const targetWidth = 600;
            if (cw < targetWidth) {
                const scale = targetWidth / cw;
                const scaled = document.createElement('canvas');
                scaled.width = targetWidth;
                scaled.height = ch * scale;
                const sCtx = scaled.getContext('2d');
                sCtx.scale(scale, scale);
                sCtx.drawImage(trimmed, 0, 0);
                return scaled;
            }

            return trimmed;
        }

        // Toggle Org Name field based on applicant type (global function for inline handler)
        window.toggleOrgName = function () {
            const isGroup = document.getElementById('typeGroup').checked;
            const orgField = document.getElementById('orgNameField');
            if (orgField) {
                orgField.style.display = isGroup ? 'block' : 'none';
            }
        }

        // Confirm Button
        document.getElementById('btnSignConfirm').addEventListener('click', function () {
            if (!hasSignature) {
                showAlert('서명을 해주세요.');
                return;
            }

            // Generate Optimized Signature
            const optimizedCanvas = trimCanvas(fsCanvas);

            if (!optimizedCanvas) {
                showAlert('서명이 너무 흐릿하거나 비어있습니다.');
                return;
            }

            // Save Valid Signature
            finalSignatureData = optimizedCanvas.toDataURL('image/png');

            // Update Preview (CSS ensures it fits visually, but data is Hi-Res)
            document.getElementById('sigImage').src = finalSignatureData;
            document.getElementById('signaturePreview').style.display = 'block';

            // Change Button Text
            btnOpenSign.innerHTML = '<i class="fas fa-pen me-2"></i>서명 다시 하기';
            btnOpenSign.classList.remove('btn-outline-dark');
            btnOpenSign.classList.add('btn-outline-secondary');

            signModal.hide();
        });

        // Close Button (Reset or Keep?)
        // If they click 'X', we just close. If they confirmed before, old sig remains.
        btnCloseSign.addEventListener('click', function () {
            signModal.hide();
        });

        // --- Restored Calendar Logic ---
        var calendar = null;
        var currentMode = getMode(); // 'mobile' or 'pc'

        function getMode() {
            const isLandscape = window.matchMedia("(orientation: landscape) and (max-height: 500px)").matches;
            if (isLandscape) return 'landscape';
            return window.innerWidth < 768 ? 'mobile' : 'pc';
        }

        function initCalendar() {
            var mode = getMode();
            var isMobile = (mode === 'mobile');
            var isLandscape = (mode === 'landscape');

            if (calendar) {
                calendar.destroy();
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                // Always auto height to prevent internal scrollbars (use browser scroll)
                height: 'auto',
                aspectRatio: isMobile ? 1.2 : 2.2,
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'dayGridMonth,listMonth today'
                },
                buttonText: {
                    listMonth: '목록',
                    dayGridMonth: '달력',
                    today: '오늘'
                },
                selectable: true,
                // Limit events only on Mobile Portrait (to avoid huge height)
                // PC & Landscape: Show All (as requested)
                dayMaxEvents: (mode === 'mobile') ? true : false,
                events: '/api/reservations',
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false, hour12: false },
                // Force block display to remove the "dot" for timed events
                eventDisplay: 'block',
                eventContent: isMobile ? function (arg) {
                    if (arg.view.type === 'listMonth') {
                        return { html: `<div class="p-1"><span class="fw-bold">${arg.event.title}</span></div>` };
                    }

                    if (arg.event.title.startsWith('⛔')) {
                        return { html: `<div class="text-center fw-bold text-truncate" style="font-size:0.7rem; color:white;">${arg.event.title}</div>` };
                    }

                    const start = arg.event.start;
                    const timeLabel = `${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')}`;

                    return {
                        html: `
                        <div class="d-flex justify-content-center align-items-center w-100 h-100" style="font-size:0.75rem; color:white;">
                            <span class="fw-bold">${timeLabel}</span>
                        </div>
                    `};
                } : undefined,
                dayCellContent: function (info) {
                    var number = info.dayNumberText.replace('일', '');
                    return { html: number };
                },
                dateClick: function (info) {
                    selectedDate = info.dateStr;
                    openReserveModal(selectedDate);
                },
                select: function (info) {
                    selectedDate = info.startStr;
                    openReserveModal(selectedDate);
                }
            });
            calendar.render();
            currentMode = mode;
        }

        initCalendar();

        window.addEventListener('resize', function () {
            var newMode = getMode();
            if (newMode !== currentMode) {
                initCalendar();
            }
        });

        function openReserveModal(dateStr) {
            const selected = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selected < today) {
                showAlert('지난 날짜는 예약할 수 없습니다.');
                return;
            }

            document.getElementById('resDate').value = dateStr;
            const items = dateStr.split('-');

            document.getElementById('displayDate').innerText = `${items[0]}년 ${items[1]}월 ${items[2]}일`;

            // Reset Recurring
            document.getElementById('checkRecurring').checked = false;
            document.getElementById('recurringOptions').style.display = 'none';
            document.getElementById('repeatCount').value = '2';

            reserveModal.show();

        }

        // Toggle Recurring Options
        document.getElementById('checkRecurring').addEventListener('change', function () {
            const options = document.getElementById('recurringOptions');
            if (this.checked) {
                options.style.display = 'block';
            } else {
                options.style.display = 'none';
            }
        });

        // Submit Logic
        document.getElementById('btnSubmit').addEventListener('click', function () {
            const name = document.getElementById('resName').value;
            const phone = document.getElementById('resPhone').value;
            const password = document.getElementById('resPassword').value;
            const purpose = document.getElementById('resPurpose').value;
            const startTime = document.getElementById('resStartTime').value;
            const endTime = document.getElementById('resEndTime').value;

            const agreed = document.getElementById('agreeTerms').checked;

            if (!name || !phone || !password || !purpose) { showAlert('필수 정보를 모두 입력해주세요.'); return; }
            if (password.length !== 4 || isNaN(password)) { showAlert('비밀번호는 숫자 4자리여야 합니다.'); return; }
            if (startTime >= endTime) { showAlert('종료 시간은 시작 시간보다 뒤여야 합니다.'); return; }
            if (!agreed) { showAlert('약관에 동의해주세요.'); return; }


            // Signature Validation (Updated)
            if (!finalSignatureData) {
                showAlert('전자 서명이 필요합니다. 서명하기 버튼을 눌러주세요.');
                return;
            }

            // Save Info
            if (document.getElementById('rememberMe').checked) {
                localStorage.setItem('rememberMe', 'true');
                localStorage.setItem('userName', name);
                localStorage.setItem('userPhone', phone);
                localStorage.setItem('userPassword', password);
            } else {
                localStorage.removeItem('rememberMe');
            }

            // Use Confirmed Signature Data
            const signatureData = finalSignatureData;

            const payload = {
                name: name,
                phone: phone,
                password: password,
                purpose: purpose,
                start: `${selectedDate}T${startTime}:00`,
                end: `${selectedDate}T${endTime}:00`,
                signature: signatureData,
                repeat_type: document.getElementById('checkRecurring').checked ? 'weekly' : null,
                repeat_count: document.getElementById('checkRecurring').checked ? parseInt(document.getElementById('repeatCount').value) : 1,
                // New Fields
                applicant_type: document.querySelector('input[name="applicantType"]:checked')?.value || '개인',
                org_name: document.getElementById('resOrgName')?.value || '',
                facility_basic: [...document.querySelectorAll('#facLib:checked, #facCulture:checked, #facCook:checked')].map(c => c.value).join(','),
                facility_extra: [...document.querySelectorAll('#facBeam:checked, #facScreen:checked')].map(c => c.value).join(','),
                expected_count: document.getElementById('resExpectedCount').value || null,
                birth_date: document.getElementById('resBirthDate').value || '',
                address: document.getElementById('resAddress').value || '',
                email: document.getElementById('resEmail').value || ''
            };

            fetch('/api/reservations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json().then(data => ({ status: res.status, body: data })))
                .then(res => {
                    if (res.status === 201) {
                        reserveModal.hide();
                        calendar.refetchEvents();

                        // Reset Form & Signature
                        // Save optional info before reset
                        localStorage.setItem('userAddress', document.getElementById('resAddress').value || '');
                        localStorage.setItem('userEmail', document.getElementById('resEmail').value || '');
                        localStorage.setItem('userBirthDate', document.getElementById('resBirthDate').value || '');
                        document.getElementById('reservationForm').reset();
                        finalSignatureData = null;
                        document.getElementById('sigImage').src = "";
                        document.getElementById('signaturePreview').style.display = 'none';
                        btnOpenSign.innerHTML = '<i class="fas fa-signature me-2"></i>서명하기 (터치)';
                        btnOpenSign.classList.remove('btn-outline-secondary');
                        btnOpenSign.classList.add('btn-outline-dark');

                        const downloadBtn = document.getElementById('btnDownloadIcs');
                        downloadBtn.href = `/api/reservations/${res.body.id}/download_ics`;

                        successModal.show();
                    } else {
                        showAlert('예약 실패: ' + res.body.error);
                    }
                })
                .catch(err => {
                    console.error(err);
                    showAlert('서버 통신 오류');
                });
        });

        // Feedback Logic
        document.getElementById('btnSendFeedback').addEventListener('click', function () {
            const msg = document.getElementById('feedbackMsg').value;
            if (!msg.trim()) { showAlert('내용을 입력해주세요.'); return; }

            // Disable button
            this.disabled = true;

            fetch('/api/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            })
                .then(res => res.json())
                .then(data => {
                    this.disabled = false;
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                        modal.hide();
                        document.getElementById('feedbackMsg').value = '';
                        showAlert('소중한 의견 감사합니다!');
                    } else {
                        showAlert('전송 실패: ' + data.error);
                    }
                })
                .catch(() => {
                    this.disabled = false;
                    showAlert('서버 통신 오류');
                });
        });
    });
</script>
{% endblock %}