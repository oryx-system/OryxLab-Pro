{% extends "base.html" %}

{% block content %}
<!-- Floating Notice Banner -->
<div class="notice-banner">
    <div class="d-flex align-items-center w-100">
        <!-- Secret Admin Entrance: Click 5 times in 10s -->
        <div id="noticeIcon" class="rounded-circle bg-primary bg-opacity-10 p-3 me-3 text-primary"
            style="cursor: pointer; transition: transform 0.1s;">
            <i class="fas fa-bullhorn fa-lg"></i>
        </div>
        <div>
            <h5 class="mb-1 fw-bold">ê³µì§€ì‚¬í•­</h5>
            <p class="mb-0 opacity-75">{{ notice }}</p>
        </div>
    </div>
</div>

<!-- Floating Feedback Button -->
<button
    class="btn btn-primary rounded-circle shadow-lg position-fixed bottom-0 end-0 m-4 d-flex align-items-center justify-content-center"
    style="width: 60px; height: 60px; z-index: 1050;" title="ë²„ê·¸ ì œë³´ ë° ê±´ì˜ì‚¬í•­" data-bs-toggle="modal"
    data-bs-target="#feedbackModal">
    <i class="fas fa-comment-dots fa-lg"></i>
</button>


<div class="row gx-5">
    <!-- Full Width Calendar -->
    <div class="col-lg-12">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-body p-0">
                <div id="calendar" class="p-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Display Section -->
<div class="row mt-4">
    <div class="col-lg-12">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-comments me-2 text-primary"></i>
                    ì‚¬ìš©ì í”¼ë“œë°±
                </h5>
                <small class="text-muted">ì—¬ëŸ¬ë¶„ì˜ ì†Œì¤‘í•œ ì˜ê²¬ì„ ê³µìœ í•©ë‹ˆë‹¤</small>
            </div>
            <div class="card-body p-0">
                {% if feedbacks %}
                <div class="list-group list-group-flush">
                    {% for fb in feedbacks %}
                    <div class="list-group-item py-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-grow-1">
                                <p class="mb-2">{{ fb.action }}</p>
                                <small class="text-muted">
                                    <i class="far fa-clock me-1"></i>
                                    {{ fb.timestamp.strftime('%Y-%m-%d %H:%M') }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
                    <p class="mb-0">ì•„ì§ ë“±ë¡ëœ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <small>ì²« ë²ˆì§¸ í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Reservation Modal -->
<div class="modal fade" id="reserveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold text-white">
                    <i class="fas fa-calendar-check me-2"></i>ì˜ˆì•½í•˜ê¸°
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="reservationForm">
                    <!-- Date & Time -->
                    <div class="bg-light rounded-3 p-3 mb-4 text-center">
                        <h4 class="fw-bold text-primary mb-3" id="displayDate"></h4>
                        <input type="hidden" id="resDate">
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <select class="form-select form-select-lg fw-bold text-center border-0 shadow-sm"
                                id="resStartTime" style="width: 120px;"></select>
                            <span class="text-muted">~</span>
                            <select class="form-select form-select-lg fw-bold text-center border-0 shadow-sm"
                                id="resEndTime" style="width: 120px;"></select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ì´ë¦„</label>
                        <input type="text" class="form-control" id="resName" required placeholder="ì˜ˆ: í™ê¸¸ë™">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" class="form-control" id="resPhone" required placeholder="ì˜ˆ: 01012345678">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" id="resPassword" required placeholder="ìˆ«ì 4ìë¦¬"
                            inputmode="numeric" pattern="[0-9]*" maxlength="4">
                        <div class="form-text small" style="color: #6c757d;">
                            â€» ë‚˜ì¤‘ì— ì˜ˆì•½ì„ í™•ì¸í•˜ê±°ë‚˜ ì·¨ì†Œí•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ì‚¬ìš© ëª©ì </label>
                        <input type="text" class="form-control" id="resPurpose" required
                            placeholder="ì˜ˆ: ë…ì„œ ëª¨ì„, ì½”ë”© ìˆ˜ì—…, ì¸ë¬¸í•™ ê°•ì˜ ë“±">
                    </div>

                    <!-- Collapsible Optional Fields Section -->
                    <div class="mb-3">
                        <a class="text-decoration-none small" data-bs-toggle="collapse" href="#optionalFields"
                            role="button" aria-expanded="false" aria-controls="optionalFields">
                            <i class="fas fa-chevron-down me-1"></i>ì¶”ê°€ ì •ë³´ ì…ë ¥ <span class="text-muted">(ì„ íƒì‚¬í•­)</span>
                        </a>
                        <div class="collapse mt-2" id="optionalFields">
                            <div class="card card-body bg-light border-0 py-3">
                                <!-- Applicant Type -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold small mb-1">ì‹ ì²­ì ìœ í˜•</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="applicantType"
                                                id="typePersonal" value="ê°œì¸" checked onchange="toggleOrgName()">
                                            <label class="form-check-label small" for="typePersonal">ê°œì¸</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="applicantType"
                                                id="typeGroup" value="ë‹¨ì²´" onchange="toggleOrgName()">
                                            <label class="form-check-label small" for="typeGroup">ë‹¨ì²´</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Org Name (shows when ë‹¨ì²´ selected) -->
                                <div class="mb-3" id="orgNameField" style="display: none;">
                                    <label class="form-label fw-bold small mb-1">ë‹¨ì²´ëª…</label>
                                    <input type="text" class="form-control form-control-sm" id="resOrgName"
                                        placeholder="ì˜ˆ: â—‹â—‹ë…ì„œëª¨ì„">
                                </div>

                                <!-- Facilities -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold small mb-1">ì‚¬ìš©ì‹œì„¤</label>
                                    <div>
                                        <div class="mb-1">
                                            <span class="small text-muted">ê¸°ë³¸:</span>
                                            <label class="small ms-1 me-2"><input type="checkbox" id="facLib"
                                                    value="ìë£Œì‹¤" class="me-1">ìë£Œì‹¤</label>
                                            <label class="small me-2"><input type="checkbox" id="facCulture"
                                                    value="ë¬¸í™”ê°•ì¢Œì‹¤" class="me-1">ë¬¸í™”ê°•ì¢Œì‹¤</label>
                                            <label class="small"><input type="checkbox" id="facCook" value="ì¡°ë¦¬ì‹¤"
                                                    class="me-1">ì¡°ë¦¬ì‹¤</label>
                                        </div>
                                        <div>
                                            <span class="small text-muted">ë¶€ëŒ€:</span>
                                            <label class="small ms-1 me-2"><input type="checkbox" id="facBeam"
                                                    value="ë¹”í”„ë¡œì íŠ¸" class="me-1">ë¹”í”„ë¡œì íŠ¸</label>
                                            <label class="small"><input type="checkbox" id="facScreen" value="ìŠ¤í¬ë¦°"
                                                    class="me-1">ìŠ¤í¬ë¦°</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Expected Count with default value -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold small mb-1">ì´ìš©ì˜ˆì •ì¸ì›</label>
                                    <input type="number" class="form-control form-control-sm" id="resExpectedCount"
                                        min="0" max="100" value="0" style="width: 100px;">
                                </div>

                                <!-- Birth Date & Email Row -->
                                <div class="row">
                                    <div class="col-6 mb-2">
                                        <label class="form-label fw-bold small mb-1">ìƒë…„ì›”ì¼</label>
                                        <input type="date" class="form-control form-control-sm" id="resBirthDate"
                                            min="1970-01-01">
                                    </div>
                                    <div class="col-6 mb-2">
                                        <label class="form-label fw-bold small mb-1">ì´ë©”ì¼</label>
                                        <input type="email" class="form-control form-control-sm" id="resEmail"
                                            placeholder="example@mail.com">
                                    </div>
                                </div>

                                <!-- Address -->
                                <div>
                                    <label class="form-label fw-bold small mb-1">ì£¼ì†Œ</label>
                                    <input type="text" class="form-control form-control-sm" id="resAddress"
                                        placeholder="ì¶©ë‚¨ ê¸ˆì‚°êµ°...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recurring Reservation -->
                    <div class="mb-4 p-3 bg-light rounded shadow-sm">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="checkRecurring">
                            <label class="form-check-label fw-bold" for="checkRecurring">
                                ì—°ì† ì˜ˆì•½ <span class="badge bg-success ms-1">New</span>
                            </label>
                            <small class="d-block text-muted">ì„ íƒí•œ ë‚ ì§œë¶€í„° ì—°ì†ìœ¼ë¡œ ê°™ì€ ì‹œê°„ì— ì˜ˆì•½í•©ë‹ˆë‹¤.</small>
                        </div>
                        <div class="mt-3 ps-2" id="recurringOptions" style="display: none;">
                            <!-- Repeat Mode Selection -->
                            <div class="mb-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="repeatMode" id="modeDaily"
                                        value="daily" checked>
                                    <label class="form-check-label small" for="modeDaily">ë§¤ì¼ (ì—°ì†)</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="repeatMode" id="modeWeekly"
                                        value="weekly">
                                    <label class="form-check-label small" for="modeWeekly">ë§¤ì£¼ (ê°™ì€ ìš”ì¼)</label>
                                </div>
                            </div>

                            <!-- Options for Daily (Consecutive) -->
                            <div id="dailyOptions">
                                <label class="form-label small fw-bold mb-1">ì—°ì† ì˜ˆì•½ ì¼ìˆ˜</label>
                                <select class="form-select form-select-sm" id="recurringDays" style="width: 150px;">
                                    <option value="2">2ì¼ ì—°ì†</option>
                                    <option value="3">3ì¼ ì—°ì†</option>
                                    <option value="4">4ì¼ ì—°ì†</option>
                                    <option value="5">5ì¼ ì—°ì†</option>
                                    <option value="6">6ì¼ ì—°ì†</option>
                                    <option value="7" selected>7ì¼ ì—°ì† (1ì£¼ì¼)</option>
                                </select>
                            </div>

                            <!-- Options for Weekly -->
                            <div id="weeklyOptions" style="display: none;">
                                <label class="form-label small fw-bold mb-1">ë°˜ë³µ ì£¼ìˆ˜</label>
                                <select class="form-select form-select-sm" id="recurringWeeks" style="width: 150px;">
                                    <option value="2">2ì£¼</option>
                                    <option value="3">3ì£¼</option>
                                    <option value="4" selected>4ì£¼</option>
                                </select>
                            </div>

                            <!-- Preview for both -->
                            <div class="mt-2" id="recurringPreview">
                                <div class="alert alert-info py-2 small mb-0">
                                    <i class="fas fa-calendar-week me-1"></i>
                                    <strong>ì˜ˆì•½ ìƒì„¸:</strong> <span id="recurringDates">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="rememberMe" checked>
                        <label class="form-check-label" for="rememberMe">ë‚´ ì •ë³´ ê¸°ì–µí•˜ê¸°</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ì´ìš© ì•½ê´€</label>
                        <div class="terms-box" id="termsBox">
                            {{ privacy_policy | safe if privacy_policy else '<p class="text-center py-5 text-muted">ë“±ë¡ëœ
                                ì•½ê´€ì´ ì—†ìŠµë‹ˆë‹¤.</p>' | safe }}
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" disabled>
                            <label class="form-check-label" for="agreeTerms">ìœ„ ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ì „ì ì„œëª… (í•„ìˆ˜)</label>

                        <!-- Signature Preview Area -->
                        <div id="signaturePreview" class="border rounded bg-white text-center p-3 mb-2"
                            style="display: none; background-color: #f8f9fa;">
                            <img id="sigImage" src="" class="img-fluid" style="max-height: 100px;">
                        </div>

                        <!-- Open Modal Button -->
                        <button type="button" class="btn btn-outline-dark w-100 py-3 border-2 border-dashed"
                            id="btnOpenSignModal">
                            <i class="fas fa-signature me-2"></i>ì„œëª…í•˜ê¸° (í„°ì¹˜)
                        </button>
                    </div>


                </form>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary rounded-pill px-5" id="btnSubmit">ì˜ˆì•½ ì‹ ì²­</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center overflow-hidden border-0">
            <div class="modal-body p-5">
                <div class="mb-4 text-success rubberBand animated">
                    <i class="fas fa-check-circle fa-6x"
                        style="filter: drop-shadow(0 5px 15px rgba(25, 135, 84, 0.4));"></i>
                </div>
                <h3 class="fw-bold mb-2">ì˜ˆì•½ ì™„ë£Œ!</h3>
                <p class="text-muted mb-4">ì…ì‹¤ ì‹œ <strong>QR ì²´í¬ì¸</strong>ì„ ê¼­ ì§„í–‰í•´ì£¼ì„¸ìš”.</p>
                <div class="d-grid gap-3">
                    <a href="#" class="btn btn-primary btn-lg shadow" id="btnDownloadIcs">
                        <i class="fas fa-calendar-alt me-2"></i> ë‚´ ìº˜ë¦°ë”ì— ì €ì¥ (.ics)
                    </a>
                    <button type="button" class="btn btn-outline-secondary rounded-pill"
                        data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold text-white"><i class="fas fa-comment-dots me-2"></i>ê¸°ëŠ¥ ì œì•ˆ ë° ë²„ê·¸ ì‹ ê³ </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-success border-0 py-2 mb-3">
                    <i class="fas fa-user-secret me-2"></i>
                    <strong>ìµëª…ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</strong> ê°œì¸ì •ë³´ëŠ” ìˆ˜ì§‘ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </div>
                <p class="text-muted small mb-3">ì„œë¹„ìŠ¤ ì´ìš© ì¤‘ ë¶ˆí¸í•œ ì ì´ë‚˜ ì¶”ê°€ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤ë©´ ììœ ë¡­ê²Œ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
                <textarea class="form-control" id="feedbackMsg" rows="5" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..."></textarea>
                <div class="text-end mt-2">
                    <small class="text-muted" id="charCount">0 / 500ì</small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" id="btnSendFeedback">ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- Full Screen Signature Modal -->
<!-- Full Screen Signature Modal -->
<div class="modal fade" id="signatureModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content border-0">
            <div class="modal-body p-0 position-relative bg-light d-flex align-items-center justify-content-center"
                style="touch-action: none; overflow: hidden;">

                <!-- Full Screen Canvas -->
                <canvas id="fsSignaturePad"
                    style="background: white; cursor: crosshair; touch-action: none; width: 100%; height: 100%; display: block;"></canvas>

                <!-- Floating Controls -->
                <!-- Close Button (Top Right) -->
                <button type="button"
                    class="btn btn-dark btn-sm rounded-circle shadow position-absolute top-0 end-0 m-3"
                    id="btnCloseSignModal" style="width: 40px; height: 40px; z-index: 100;">
                    <i class="fas fa-times"></i>
                </button>

                <!-- Helper Text (Top Center) -->
                <div
                    class="position-absolute top-0 start-50 translate-middle-x mt-3 text-muted small opacity-50 user-select-none pointer-events-none">
                    <i class="fas fa-pen-nib me-1"></i>í™”ë©´ ì „ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œëª…í•´ì£¼ì„¸ìš”.
                </div>

                <!-- Floating Action Buttons (Bottom Center) -->
                <div class="position-absolute bottom-0 start-50 translate-middle-x mb-4 d-flex gap-2"
                    style="z-index: 100;">
                    <button type="button" class="btn btn-secondary rounded-pill px-3 py-2 shadow-lg btn-sm text-nowrap"
                        id="btnSignClear">
                        <i class="fas fa-redo me-1"></i>ì§€ìš°ê¸°
                    </button>
                    <button type="button" class="btn btn-primary rounded-pill px-4 py-2 shadow-lg fw-bold btn-sm"
                        id="btnSignConfirm" style="min-width: 100px;">
                        <i class="fas fa-check me-2"></i>ì™„ë£Œ
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>
</div>


{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var reserveModal = new bootstrap.Modal(document.getElementById('reserveModal'));
        var successModal = new bootstrap.Modal(document.getElementById('successModal'));
        let selectedDate = null;

        // Secret Admin Access (5 clicks in 10s)
        let clickCount = 0;
        let clickTimer = null;
        const noticeIcon = document.getElementById('noticeIcon');

        if (noticeIcon) {
            noticeIcon.addEventListener('click', function () {
                clickCount++;

                if (clickCount === 1) {
                    // Start 10s timer on first click
                    clickTimer = setTimeout(() => {
                        clickCount = 0; // Reset after 10s
                    }, 10000);
                }

                if (clickCount >= 5) {
                    clearTimeout(clickTimer);
                    clickCount = 0;
                    // Stealth Redirect
                    window.location.href = '/dev-login';
                }
            });
        }

        // Populate Time Dropdowns (09:00 to 22:00)
        function populateTimeOptions() {
            const startSelect = document.getElementById('resStartTime');
            const endSelect = document.getElementById('resEndTime');
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';

            for (let i = 9; i <= 21; i++) {
                const hour = i.toString().padStart(2, '0');
                // 1ì‹œê°„ ë‹¨ìœ„ë¡œ ë³€ê²½
                startSelect.innerHTML += `<option value="${hour}:00">${hour}:00</option>`;

                // End time (1ì‹œê°„ ë‹¨ìœ„)
                const endHour = (i + 1).toString().padStart(2, '0');
                endSelect.innerHTML += `<option value="${endHour}:00">${endHour}:00</option>`;
            }
        }
        populateTimeOptions();

        // Update end time options based on start time
        document.getElementById('resStartTime').addEventListener('change', function () {
            const startValue = this.value;
            const endSelect = document.getElementById('resEndTime');

            Array.from(endSelect.options).forEach(option => {
                // Disable options that are <= start time
                if (option.value <= startValue) {
                    option.disabled = true;
                    option.style.color = '#ccc';
                } else {
                    option.disabled = false;
                    option.style.color = '';
                }
            });

            // If current selection is invalid, select first valid option
            if (endSelect.value <= startValue) {
                const firstValid = Array.from(endSelect.options).find(opt => opt.value > startValue);
                if (firstValid) {
                    endSelect.value = firstValid.value;
                }
            }

            // Check time limit warning
            checkTimeLimitWarning();
        });

        // End time change - check 4 hour limit
        document.getElementById('resEndTime').addEventListener('change', checkTimeLimitWarning);

        function checkTimeLimitWarning() {
            const startHour = parseInt(document.getElementById('resStartTime').value.split(':')[0]);
            const endHour = parseInt(document.getElementById('resEndTime').value.split(':')[0]);
            const diff = endHour - startHour;

            // Remove existing warning
            const existingWarning = document.getElementById('timeLimitWarning');
            if (existingWarning) existingWarning.remove();

            // Show warning if more than 4 hours
            if (diff > 4) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'timeLimitWarning';
                warningDiv.className = 'alert alert-warning py-2 mt-2 small';
                warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>ì•ˆë‚´:</strong> 1íšŒ ìµœëŒ€ ì˜ˆì•½ ì‹œê°„ì€ <strong>4ì‹œê°„</strong>ì…ë‹ˆë‹¤.';

                const timeContainer = document.getElementById('resEndTime').closest('.bg-light');
                if (timeContainer) {
                    timeContainer.appendChild(warningDiv);
                }
            }
        }

        // Load Remembered Info (including optional fields)
        document.getElementById('rememberMe').checked = true;
        document.getElementById('resName').value = localStorage.getItem('userName') || '';
        document.getElementById('resPhone').value = localStorage.getItem('userPhone') || '';
        document.getElementById('resPassword').value = localStorage.getItem('userPassword') || '';
        // Optional fields auto-load
        document.getElementById('resAddress').value = localStorage.getItem('userAddress') || '';
        document.getElementById('resEmail').value = localStorage.getItem('userEmail') || '';
        // Set default birth date to 1990 so picker starts near reasonable year
        const savedBirthDate = localStorage.getItem('userBirthDate') || '';
        if (savedBirthDate) {
            document.getElementById('resBirthDate').value = savedBirthDate;
        } else {
            document.getElementById('resBirthDate').value = '1990-01-01';
        }



        // Terms Scroll
        const termsBox = document.getElementById('termsBox');
        termsBox.addEventListener('scroll', function () {
            if (termsBox.scrollTop + termsBox.clientHeight >= termsBox.scrollHeight - 5) {
                document.getElementById('agreeTerms').disabled = false;
            }
        });

        // --- Full Screen Signature Logic ---
        const btnOpenSign = document.getElementById('btnOpenSignModal');
        const signModalEl = document.getElementById('signatureModal');
        const signModal = new bootstrap.Modal(signModalEl);
        const btnCloseSign = document.getElementById('btnCloseSignModal');

        const fsCanvas = document.getElementById('fsSignaturePad');
        const fsCtx = fsCanvas.getContext('2d');
        let isDrawing = false;
        let hasSignature = false; // Tracks if current session has drawing
        let finalSignatureData = null; // Stores confirmed signature

        // Resize Full Screen Canvas
        function resizeFsCanvas() {
            const isLandscape = window.innerWidth > window.innerHeight;

            if (isLandscape) {
                // Landscape: Full Screen
                fsCanvas.width = window.innerWidth;
                fsCanvas.height = window.innerHeight;

                // CRITICAL: Reset explicit styles so attribute-based tokens work 1:1
                fsCanvas.style.width = '';
                fsCanvas.style.height = '';

                fsCanvas.style.borderRadius = "0";
                fsCanvas.style.boxShadow = "none";
            } else {
                // Portrait: Boxed Mode
                // 90% of width, Aspect Ratio 1.6:1
                const width = window.innerWidth * 0.95;
                const height = width / 1.6;

                fsCanvas.width = width;
                fsCanvas.height = height;

                // Add visual frame for "Box" feel
                fsCanvas.style.width = `${width}px`;
                fsCanvas.style.height = `${height}px`;
                fsCanvas.style.borderRadius = "12px";
                fsCanvas.style.boxShadow = "0 10px 30px rgba(0,0,0,0.2)";
            }

            fsCtx.lineWidth = 3;
            fsCtx.lineCap = 'round';
            fsCtx.strokeStyle = '#000';
        }

        // Listen to resize to adapt dynamically
        window.addEventListener('resize', resizeFsCanvas);

        // Open Modal
        btnOpenSign.addEventListener('click', function () {
            signModal.show();
        });

        // When Modal Shows
        signModalEl.addEventListener('shown.bs.modal', function () {
            resizeFsCanvas();
            fsCtx.clearRect(0, 0, fsCanvas.width, fsCanvas.height);
            hasSignature = false; // Reset current drawing state
        });

        // Drawing Events (Touch & Mouse)
        function getFsPos(e) {
            const rect = fsCanvas.getBoundingClientRect();
            let x, y;
            if (e.touches && e.touches.length > 0) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return { x, y };
        }

        function fsStart(e) {
            isDrawing = true;
            hasSignature = true;
            const { x, y } = getFsPos(e);
            fsCtx.beginPath();
            fsCtx.moveTo(x, y);
            e.preventDefault();
        }

        function fsDraw(e) {
            if (!isDrawing) return;
            const { x, y } = getFsPos(e);
            fsCtx.lineTo(x, y);
            fsCtx.stroke();
            e.preventDefault();
        }

        function fsStop() {
            isDrawing = false;
            fsCtx.beginPath();
        }

        fsCanvas.addEventListener('mousedown', fsStart);
        fsCanvas.addEventListener('mousemove', fsDraw);
        fsCanvas.addEventListener('mouseup', fsStop);
        fsCanvas.addEventListener('mouseout', fsStop);

        fsCanvas.addEventListener('touchstart', fsStart, { passive: false });
        fsCanvas.addEventListener('touchmove', fsDraw, { passive: false });
        fsCanvas.addEventListener('touchend', fsStop);

        // Clear Button (In Modal)
        document.getElementById('btnSignClear').addEventListener('click', function () {
            fsCtx.clearRect(0, 0, fsCanvas.width, fsCanvas.height);
            hasSignature = false;
        });

        // Helper: Trim Canvas Whitespace & Scale to High Res
        function trimCanvas(c) {
            const ctx = c.getContext('2d');
            const w = c.width;
            const h = c.height;
            const pix = { x: [], y: [] };
            const imageData = ctx.getImageData(0, 0, w, h);
            const data = imageData.data;

            // 1. Scan for non-transparent/non-white pixels
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const idx = (y * w + x) * 4;
                    // Check alpha > 0 (data[idx+3]) and not white (r,g,b < 255)
                    // Since we draw black on transparent/white...
                    // Check if alpha is high enough
                    if (data[idx + 3] > 0) {
                        pix.x.push(x);
                        pix.y.push(y);
                    }
                }
            }

            if (pix.x.length === 0) return null; // Empty

            // 2. Determine Bounding Box
            pix.x.sort((a, b) => a - b);
            pix.y.sort((a, b) => a - b);
            const n = pix.x.length;
            const minX = pix.x[0];
            const minY = pix.y[0];
            const maxX = pix.x[n - 1];
            const maxY = pix.y[n - 1];

            // Add padding
            const padding = 10;
            const cw = maxX - minX + (padding * 2);
            const ch = maxY - minY + (padding * 2);

            // 3. Create Trimmed Canvas
            const trimmed = document.createElement('canvas');
            trimmed.width = cw;
            trimmed.height = ch;
            const tCtx = trimmed.getContext('2d');

            // Draw cropped area
            tCtx.drawImage(c, minX - padding, minY - padding, cw, ch, 0, 0, cw, ch);

            // 4. High-Res Scaling (Target Width ~ 600px for 200 DPI look)
            const targetWidth = 600;
            if (cw < targetWidth) {
                const scale = targetWidth / cw;
                const scaled = document.createElement('canvas');
                scaled.width = targetWidth;
                scaled.height = ch * scale;
                const sCtx = scaled.getContext('2d');
                sCtx.scale(scale, scale);
                sCtx.drawImage(trimmed, 0, 0);
                return scaled;
            }

            return trimmed;
        }

        // Toggle Org Name field based on applicant type (global function for inline handler)
        window.toggleOrgName = function () {
            const isGroup = document.getElementById('typeGroup').checked;
            const orgField = document.getElementById('orgNameField');
            if (orgField) {
                orgField.style.display = isGroup ? 'block' : 'none';
            }
        }

        // Confirm Button
        document.getElementById('btnSignConfirm').addEventListener('click', function () {
            if (!hasSignature) {
                showAlert('ì„œëª…ì„ í•´ì£¼ì„¸ìš”.');
                return;
            }

            // Generate Optimized Signature
            const optimizedCanvas = trimCanvas(fsCanvas);

            if (!optimizedCanvas) {
                showAlert('ì„œëª…ì´ ë„ˆë¬´ íë¦¿í•˜ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            // Save Valid Signature
            finalSignatureData = optimizedCanvas.toDataURL('image/png');

            // Update Preview (CSS ensures it fits visually, but data is Hi-Res)
            document.getElementById('sigImage').src = finalSignatureData;
            document.getElementById('signaturePreview').style.display = 'block';

            // Change Button Text
            btnOpenSign.innerHTML = '<i class="fas fa-pen me-2"></i>ì„œëª… ë‹¤ì‹œ í•˜ê¸°';
            btnOpenSign.classList.remove('btn-outline-dark');
            btnOpenSign.classList.add('btn-outline-secondary');

            signModal.hide();

            // ì˜ˆì•½ ëª¨ë‹¬ ë§¨ ì•„ë˜ë¡œ ìë™ ìŠ¤í¬ë¡¤
            setTimeout(() => {
                const modal = document.getElementById('reserveModal');
                if (modal) {
                    modal.scrollTop = modal.scrollHeight;
                }
            }, 100);
        });

        // Close Button (Reset or Keep?)
        // If they click 'X', we just close. If they confirmed before, old sig remains.
        btnCloseSign.addEventListener('click', function () {
            signModal.hide();
        });

        // --- Restored Calendar Logic ---
        var calendar = null;
        var currentMode = getMode(); // 'mobile' or 'pc'

        function getMode() {
            const isLandscape = window.matchMedia("(orientation: landscape) and (max-height: 500px)").matches;
            if (isLandscape) return 'landscape';
            return window.innerWidth < 768 ? 'mobile' : 'pc';
        }

        function initCalendar() {
            var mode = getMode();
            var isMobile = (mode === 'mobile');
            var isLandscape = (mode === 'landscape');

            if (calendar) {
                calendar.destroy();
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                // Always auto height to prevent internal scrollbars (use browser scroll)
                height: 'auto',
                aspectRatio: isMobile ? 1.2 : 2.2,
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'dayGridMonth,listMonth today'
                },
                buttonText: {
                    listMonth: 'ëª©ë¡',
                    dayGridMonth: 'ë‹¬ë ¥',
                    today: 'ì˜¤ëŠ˜'
                },
                selectable: true,
                // Limit events only on Mobile Portrait (to avoid huge height)
                // PC & Landscape: Show All (as requested)
                dayMaxEvents: (mode === 'mobile') ? true : false,
                events: '/api/reservations',
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false, hour12: false },
                // Force block display to remove the "dot" for timed events
                eventDisplay: 'block',
                eventContent: isMobile ? function (arg) {
                    if (arg.view.type === 'listMonth') {
                        return { html: `<div class="p-1"><span class="fw-bold">${arg.event.title}</span></div>` };
                    }

                    if (arg.event.title.startsWith('â›”')) {
                        return { html: `<div class="text-center fw-bold text-truncate" style="font-size:0.7rem; color:white;">${arg.event.title}</div>` };
                    }

                    const start = arg.event.start;
                    const timeLabel = `${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')}`;

                    return {
                        html: `
                        <div class="d-flex justify-content-center align-items-center w-100 h-100" style="font-size:0.75rem; color:white;">
                            <span class="fw-bold">${timeLabel}</span>
                        </div>
                    `};
                } : undefined,
                dayCellContent: function (info) {
                    var number = info.dayNumberText.replace('ì¼', '');
                    return { html: number };
                },
                dateClick: function (info) {
                    selectedDate = info.dateStr;
                    openReserveModal(selectedDate);
                },
                eventClick: function (info) {
                    const event = info.event;
                    const start = event.start;
                    const end = event.end;
                    const title = event.title;
                    const purpose = event.extendedProps.purpose || '(ëª©ì  ì—†ìŒ)';

                    const startStr = start ? `${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')}` : '';
                    const endStr = end ? `${end.getHours().toString().padStart(2, '0')}:${end.getMinutes().toString().padStart(2, '0')}` : '';

                    // Check if multi-day reservation
                    let dateStr = '';
                    if (start && end) {
                        const startDate = `${start.getFullYear()}-${(start.getMonth() + 1).toString().padStart(2, '0')}-${start.getDate().toString().padStart(2, '0')}`;
                        const endDate = `${end.getFullYear()}-${(end.getMonth() + 1).toString().padStart(2, '0')}-${end.getDate().toString().padStart(2, '0')}`;

                        if (startDate !== endDate) {
                            // Multi-day: show date range
                            dateStr = `${startDate} ~ ${endDate}`;
                        } else {
                            // Single day: show only start date
                            dateStr = startDate;
                        }
                    } else if (start) {
                        dateStr = `${start.getFullYear()}-${(start.getMonth() + 1).toString().padStart(2, '0')}-${start.getDate().toString().padStart(2, '0')}`;
                    }

                    showAlert(`ğŸ“… ${dateStr}\nâ° ${startStr} ~ ${endStr}\nğŸ“ ${purpose}`);
                },
                select: function (info) {
                    selectedDate = info.startStr;
                    openReserveModal(selectedDate);
                }
            });
            calendar.render();
            currentMode = mode;
        }

        initCalendar();

        window.addEventListener('resize', function () {
            var newMode = getMode();
            if (newMode !== currentMode) {
                initCalendar();
            }
        });

        function openReserveModal(dateStr) {
            const selected = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selected < today) {
                showAlert('ì§€ë‚œ ë‚ ì§œëŠ” ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('resDate').value = dateStr;
            const items = dateStr.split('-');

            document.getElementById('displayDate').innerText = `${items[0]}ë…„ ${items[1]}ì›” ${items[2]}ì¼`;

            // Reset Time Selection to 09:00~10:00
            document.getElementById('resStartTime').value = '09:00';
            document.getElementById('resEndTime').value = '10:00';

            // Reset Recurring
            document.getElementById('checkRecurring').checked = false;
            document.getElementById('recurringOptions').style.display = 'none';
            document.getElementById('recurringDays').value = '2';
            document.getElementById('recurringWeeks').value = '2';
            document.getElementById('modeDaily').checked = true;
            document.getElementById('dailyOptions').style.display = 'block';
            document.getElementById('weeklyOptions').style.display = 'none';

            // Reset Signature (ì„œëª… ì´ˆê¸°í™”)
            finalSignatureData = null;
            hasSignature = false;
            document.getElementById('signaturePreview').style.display = 'none';
            document.getElementById('sigImage').src = '';
            btnOpenSign.innerHTML = '<i class="fas fa-signature me-2"></i>ì„œëª…í•˜ê¸° (í„°ì¹˜)';
            btnOpenSign.classList.remove('btn-outline-secondary');
            btnOpenSign.classList.add('btn-outline-dark');

            // Fetch availability and disable booked slots
            fetchAvailability(dateStr);

            reserveModal.show();

        }

        // Fetch and mark booked time slots
        // Fetch and mark booked time slots
        async function fetchAvailability(dateStr) {
            try {
                const res = await fetch(`/api/reservations/availability?date=${dateStr}`);
                const data = await res.json();

                if (data.error) {
                    console.error('Availability Error:', data.error);
                    return;
                }

                const booked = data.booked || [];
                const startSelect = document.getElementById('resStartTime');
                const endSelect = document.getElementById('resEndTime');

                // Reset all options to enabled
                [startSelect, endSelect].forEach(select => {
                    Array.from(select.options).forEach(opt => {
                        opt.disabled = false;
                        opt.style.color = '';
                        opt.style.backgroundColor = '';
                    });
                });

                // Check each time slot against booked slots
                booked.forEach(slot => {
                    const slotStart = slot.start;
                    const slotEnd = slot.end;

                    // Disable start times that fall within booked slot
                    Array.from(startSelect.options).forEach(opt => {
                        if (opt.value >= slotStart && opt.value < slotEnd) {
                            opt.disabled = true;
                            opt.style.color = '#999';
                            opt.style.backgroundColor = '#ffeeee';
                        }
                    });
                });

                // Select first available start time
                const firstAvailable = Array.from(startSelect.options).find(opt => !opt.disabled);
                if (firstAvailable) {
                    startSelect.value = firstAvailable.value;
                    // Trigger change to update end times
                    startSelect.dispatchEvent(new Event('change'));
                }

            } catch (err) {
                console.error('Fetch Check Error:', err);
            }
        }

        // Submit Logic
        document.getElementById('btnSubmit').addEventListener('click', function () {
            const name = document.getElementById('resName').value;
            const phone = document.getElementById('resPhone').value;
            const password = document.getElementById('resPassword').value;
            const purpose = document.getElementById('resPurpose').value;
            const startTime = document.getElementById('resStartTime').value;
            const endTime = document.getElementById('resEndTime').value;

            const agreed = document.getElementById('agreeTerms').checked;

            if (!name || !phone || !password || !purpose) { showAlert('í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (password.length !== 4 || isNaN(password)) { showAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }
            if (startTime >= endTime) { showAlert('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ë’¤ì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }
            if (!agreed) { showAlert('ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.'); return; }


            // Signature Validation (Updated)
            if (!finalSignatureData) {
                showAlert('ì „ì ì„œëª…ì´ í•„ìš”í•©ë‹ˆë‹¤. ì„œëª…í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                return;
            }

            // Save Info
            if (document.getElementById('rememberMe').checked) {
                localStorage.setItem('rememberMe', 'true');
                localStorage.setItem('userName', name);
                localStorage.setItem('userPhone', phone);
                localStorage.setItem('userPassword', password);
            } else {
                localStorage.removeItem('rememberMe');
            }

            // Use Confirmed Signature Data
            const signatureData = finalSignatureData;

            const payload = {
                name: name,
                phone: phone,
                password: password,
                purpose: purpose,
                start: `${selectedDate}T${startTime}:00`,
                end: `${selectedDate}T${endTime}:00`,
                signature: signatureData,
                repeat_type: document.getElementById('checkRecurring').checked ? 'daily' : null,
                repeat_count: document.getElementById('checkRecurring').checked ? parseInt(document.getElementById('recurringDays').value) : 1,
                // New Fields
                applicant_type: document.querySelector('input[name="applicantType"]:checked')?.value || 'ê°œì¸',
                org_name: document.getElementById('resOrgName')?.value || '',
                facility_basic: [...document.querySelectorAll('#facLib:checked, #facCulture:checked, #facCook:checked')].map(c => c.value).join(','),
                facility_extra: [...document.querySelectorAll('#facBeam:checked, #facScreen:checked')].map(c => c.value).join(','),
                expected_count: document.getElementById('resExpectedCount').value || null,
                birth_date: document.getElementById('resBirthDate').value || '',
                address: document.getElementById('resAddress').value || '',
                email: document.getElementById('resEmail').value || ''
            };

            fetch('/api/reservations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json().then(data => ({ status: res.status, body: data })))
                .then(res => {
                    if (res.status === 201) {
                        reserveModal.hide();
                        calendar.refetchEvents();

                        // Reset Form & Signature
                        // Save optional info before reset
                        localStorage.setItem('userAddress', document.getElementById('resAddress').value || '');
                        localStorage.setItem('userEmail', document.getElementById('resEmail').value || '');
                        localStorage.setItem('userBirthDate', document.getElementById('resBirthDate').value || '');
                        document.getElementById('reservationForm').reset();
                        finalSignatureData = null;
                        document.getElementById('sigImage').src = "";
                        document.getElementById('signaturePreview').style.display = 'none';
                        btnOpenSign.innerHTML = '<i class="fas fa-signature me-2"></i>ì„œëª…í•˜ê¸° (í„°ì¹˜)';
                        btnOpenSign.classList.remove('btn-outline-secondary');
                        btnOpenSign.classList.add('btn-outline-dark');

                        const downloadBtn = document.getElementById('btnDownloadIcs');
                        downloadBtn.href = `/api/reservations/${res.body.id}/download_ics`;

                        successModal.show();
                    } else {
                        showAlert('ì˜ˆì•½ ì‹¤íŒ¨: ' + res.body.error);
                    }
                })
                .catch(err => {
                    console.error(err);
                    showAlert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
                });
        });

        // Feedback Logic
        const feedbackMsg = document.getElementById('feedbackMsg');
        const charCount = document.getElementById('charCount');
        const maxChars = 500;

        // Character counter
        feedbackMsg.addEventListener('input', function () {
            const currentLength = this.value.length;
            charCount.textContent = `${currentLength} / ${maxChars}ì`;

            if (currentLength > maxChars) {
                this.value = this.value.substring(0, maxChars);
                charCount.textContent = `${maxChars} / ${maxChars}ì`;
                charCount.classList.add('text-danger');
            } else if (currentLength > maxChars * 0.9) {
                charCount.classList.remove('text-danger');
                charCount.classList.add('text-warning');
            } else {
                charCount.classList.remove('text-danger', 'text-warning');
            }
        });

        document.getElementById('btnSendFeedback').addEventListener('click', function () {
            const msg = feedbackMsg.value;
            if (!msg.trim()) { showAlert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            // Disable button
            this.disabled = true;

            fetch('/api/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            })
                .then(res => res.json())
                .then(data => {
                    this.disabled = false;
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                        modal.hide();
                        feedbackMsg.value = '';
                        charCount.textContent = '0 / 500ì';
                        charCount.classList.remove('text-danger', 'text-warning');
                        showAlert('ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤!');
                    } else {
                        showAlert('ì „ì†¡ ì‹¤íŒ¨: ' + data.error);
                    }
                })
                .catch(() => {
                    this.disabled = false;
                    showAlert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
                });
        });

        // Recurring Reservation Event Handlers
        const checkRecurring = document.getElementById('checkRecurring');
        const optionsDiv = document.getElementById('recurringOptions');
        const dailyOptions = document.getElementById('dailyOptions');
        const weeklyOptions = document.getElementById('weeklyOptions');
        const modeRadios = document.getElementsByName('repeatMode');

        checkRecurring.addEventListener('change', function () {
            if (this.checked) {
                optionsDiv.style.display = 'block';
                updateRecurringPreview();
            } else {
                optionsDiv.style.display = 'none';
            }
        });

        // Toggle inputs based on mode
        modeRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'daily') {
                    dailyOptions.style.display = 'block';
                    weeklyOptions.style.display = 'none';
                } else {
                    dailyOptions.style.display = 'none';
                    weeklyOptions.style.display = 'block';
                }
                updateRecurringPreview();
            });
        });

        document.getElementById('recurringDays').addEventListener('change', updateRecurringPreview);
        document.getElementById('recurringWeeks').addEventListener('change', updateRecurringPreview);

        function updateRecurringPreview() {
            const datesSpan = document.getElementById('recurringDates');
            const mode = document.querySelector('input[name="repeatMode"]:checked').value;

            if (!selectedDate) return;

            const start = new Date(selectedDate);
            const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;

            if (mode === 'daily') {
                const days = parseInt(document.getElementById('recurringDays').value);
                const end = new Date(selectedDate);
                end.setDate(end.getDate() + days - 1);
                datesSpan.textContent = `${formatDate(start)} ~ ${formatDate(end)} (${days}ì¼ ì—°ì†)`;
            } else {
                const weeks = parseInt(document.getElementById('recurringWeeks').value);
                const end = new Date(selectedDate);
                end.setDate(end.getDate() + (weeks - 1) * 7);
                datesSpan.textContent = `${formatDate(start)}ë¶€í„° ${weeks}ì£¼ê°„ ë§¤ì£¼ ê°™ì€ ìš”ì¼ (ì´ ${weeks}íšŒ)`;
            }
        }
    });
</script>
{% endblock %}