{% extends "base.html" %}

{% block content %}
<!-- Floating Notice Banner -->
<div class="notice-banner">
    <div class="d-flex align-items-center w-100">
        <!-- Secret Admin Entrance: Click 5 times in 10s -->
        <div id="noticeIcon" class="rounded-circle bg-primary bg-opacity-10 p-3 me-3 text-primary"
            style="cursor: pointer; transition: transform 0.1s;">
            <i class="fas fa-bullhorn fa-lg"></i>
        </div>
        <div>
            <h5 class="mb-1 fw-bold">공지사항</h5>
            <p class="mb-0 opacity-75">{{ notice }}</p>
        </div>
    </div>
</div>

<!-- Floating Feedback Button -->
<button class="btn btn-dark rounded-circle shadow-lg position-fixed bottom-0 end-0 m-4"
    style="width: 60px; height: 60px; z-index: 1050;" title="버그 제보 및 건의사항" data-bs-toggle="modal"
    data-bs-target="#feedbackModal">
    <i class="fas fa-comment-dots fa-lg"></i>
</button>


<div class="row gx-5">
    <!-- Full Width Calendar -->
    <div class="col-lg-12">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-body p-0">
                <div id="calendar" class="p-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Reservation Modal -->
<div class="modal fade" id="reserveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-calendar-check me-2"></i>예약하기
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="reservationForm">
                    <!-- Date & Time -->
                    <div class="bg-light rounded-3 p-3 mb-4 text-center">
                        <h4 class="fw-bold text-primary mb-3" id="displayDate"></h4>
                        <input type="hidden" id="resDate">
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <select class="form-select form-select-lg fw-bold text-center border-0 shadow-sm"
                                id="resStartTime" style="width: 120px;"></select>
                            <span class="text-muted">~</span>
                            <select class="form-select form-select-lg fw-bold text-center border-0 shadow-sm"
                                id="resEndTime" style="width: 120px;"></select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">이름</label>
                        <input type="text" class="form-control" id="resName" required placeholder="예: 홍길동">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">전화번호</label>
                        <input type="tel" class="form-control" id="resPhone" required placeholder="예: 010-1234-5678">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">비밀번호</label>
                        <input type="password" class="form-control" id="resPassword" required placeholder="숫자 4자리"
                            inputmode="numeric" pattern="[0-9]*" maxlength="4">
                        <div class="form-text small" style="color: #6c757d;">
                            ※ 나중에 예약을 확인하거나 취소할 때 사용됩니다. (숫자 4자리)
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">사용 목적</label>
                        <input type="text" class="form-control" id="resPurpose" required
                            placeholder="예: 독서 모임, 코딩 수업, 인문학 강의 등">
                    </div>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="rememberMe" checked>
                        <label class="form-check-label" for="rememberMe">내 정보 기억하기</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">이용 약관</label>
                        <div class="terms-box" id="termsBox">
                            <p><strong>1. 이용 시간 준수</strong><br>예약 시간 내에 입/퇴실을 완료해야 합니다.</p>
                            <p><strong>2. 정리 정돈</strong><br>퇴실 시 사용한 물품을 제자리에 정리합니다.</p>
                            <p><strong>3. 취소 정책</strong><br>당일 취소 및 노쇼(No-Show) 발생 시 30일간 예약이 제한됩니다.</p>
                            <p><strong>4. 입실 체크</strong><br>입실 시 반드시 QR 체크인(또는 스마트 체크인)을 진행해야 합니다.</p>
                            <p><strong>5. 책임</strong><br>기물 파손 시 배상 책임이 있습니다.</p>
                            <p>스크롤을 끝까지 내려야 동의 버튼이 활성화됩니다.</p>
                            <br><br><br><br>
                            <p class="text-center text-muted"><i class="fas fa-check-circle me-1"></i>약관 확인 완료</p>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" disabled>
                            <label class="form-check-label" for="agreeTerms">위 약관에 동의합니다.</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">자동 예약 방지</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0 fw-bold" id="captchaQuestion">3 + 5 =
                                ?</span>
                            <input type="number" class="form-control" id="captchaAnswer" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary rounded-pill px-5" id="btnSubmit">예약 신청</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center overflow-hidden border-0">
            <div class="modal-body p-5">
                <div class="mb-4 text-success rubberBand animated">
                    <i class="fas fa-check-circle fa-6x"
                        style="filter: drop-shadow(0 5px 15px rgba(25, 135, 84, 0.4));"></i>
                </div>
                <h3 class="fw-bold mb-2">예약 완료!</h3>
                <p class="text-muted mb-4">입실 시 <strong>QR 체크인</strong>을 꼭 진행해주세요.</p>
                <div class="d-grid gap-3">
                    <a href="#" class="btn btn-primary btn-lg shadow" id="btnDownloadIcs">
                        <i class="fas fa-calendar-alt me-2"></i> 내 캘린더에 저장 (.ics)
                    </a>
                    <button type="button" class="btn btn-outline-secondary rounded-pill"
                        data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-comment-dots me-2"></i>기능 제안 및 버그 신고</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">서비스 이용 중 불편한 점이나 추가되었으면 하는 기능이 있다면 자유롭게 남겨주세요.</p>
                <textarea class="form-control" id="feedbackMsg" rows="5" placeholder="내용을 입력해주세요..."></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-dark rounded-pill px-4" id="btnSendFeedback">보내기</button>
            </div>
        </div>
    </div>
</div>
</div>


{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var reserveModal = new bootstrap.Modal(document.getElementById('reserveModal'));
        var successModal = new bootstrap.Modal(document.getElementById('successModal'));
        let selectedDate = null;

        // Secret Admin Access (5 clicks in 10s)
        let clickCount = 0;
        let clickTimer = null;
        const noticeIcon = document.getElementById('noticeIcon');

        if (noticeIcon) {
            noticeIcon.addEventListener('click', function () {
                clickCount++;

                if (clickCount === 1) {
                    // Start 10s timer on first click
                    clickTimer = setTimeout(() => {
                        clickCount = 0; // Reset after 10s
                    }, 10000);
                }

                if (clickCount >= 5) {
                    clearTimeout(clickTimer);
                    clickCount = 0;
                    // Stealth Redirect
                    window.location.href = '/dev-login';
                }
            });
        }

        // Populate Time Dropdowns (09:00 to 22:00)
        function populateTimeOptions() {
            const startSelect = document.getElementById('resStartTime');
            const endSelect = document.getElementById('resEndTime');
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';

            for (let i = 9; i <= 21; i++) {
                const hour = i.toString().padStart(2, '0');
                startSelect.innerHTML += `<option value="${hour}:00">${hour}:00</option>`;
                startSelect.innerHTML += `<option value="${hour}:30">${hour}:30</option>`;

                // End time
                const endHour = (i + 1).toString().padStart(2, '0');
                endSelect.innerHTML += `<option value="${hour}:30">${hour}:30</option>`;
                endSelect.innerHTML += `<option value="${endHour}:00">${endHour}:00</option>`;
            }
        }
        populateTimeOptions();

        // Load Remembered Info
        document.getElementById('rememberMe').checked = true;
        document.getElementById('resName').value = localStorage.getItem('userName') || '';
        document.getElementById('resPhone').value = localStorage.getItem('userPhone') || '';
        document.getElementById('resPassword').value = localStorage.getItem('userPassword') || '';

        // CAPTCHA
        let captchaAns = 0;
        function refreshCaptcha() {
            const a = Math.floor(Math.random() * 10);
            const b = Math.floor(Math.random() * 10);
            captchaAns = a + b;
            document.getElementById('captchaQuestion').innerText = `${a} + ${b} = ?`;
            document.getElementById('captchaAnswer').value = '';
        }

        // Terms Scroll
        const termsBox = document.getElementById('termsBox');
        termsBox.addEventListener('scroll', function () {
            if (termsBox.scrollTop + termsBox.clientHeight >= termsBox.scrollHeight - 5) {
                document.getElementById('agreeTerms').disabled = false;
            }
        });

        // Calendar Init with Dynamic Responsive Logic
        var calendar = null;
        var currentMode = getMode(); // 'mobile' or 'pc'

        function getMode() {
            // Check orientation and width
            const isLandscape = window.matchMedia("(orientation: landscape) and (max-height: 500px)").matches;
            if (isLandscape) return 'landscape';
            return window.innerWidth < 768 ? 'mobile' : 'pc';
        }

        function initCalendar() {
            var mode = getMode();
            var isMobile = (mode === 'mobile');
            var isLandscape = (mode === 'landscape');

            if (calendar) {
                calendar.destroy();
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                // Mobile: 'auto' height for natural flow. PC: Fixed height to 70vh to fit chrome/taskbar.
                height: isMobile ? 'auto' : '70vh',
                // Mobile: 1.2 (Taller, easy to tap), PC: 2.2 (Wide/Short to fit 1080p)
                aspectRatio: isMobile ? 1.2 : 2.2,

                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'dayGridMonth,listMonth today' // Restored buttons
                },
                buttonText: {
                    listMonth: '목록',
                    dayGridMonth: '달력',
                    today: '오늘'
                },
                selectable: true,
                // Disable 'more' popover in landscape/mobile to force showing event
                dayMaxEvents: isLandscape ? false : true,
                events: '/api/reservations',
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false, hour12: false },

                // Conditional Rendering based on Mode
                eventContent: isMobile ? function (arg) {
                    // Mobile List View: Show default (Time + Name)
                    if (arg.view.type === 'listMonth') {
                        return undefined;
                    }

                    // Special Handling for Blocked Events
                    if (arg.event.title.startsWith('⛔')) {
                        return {
                            html: `<div class="text-center fw-bold text-truncate" style="font-size:0.7rem; color:white;">${arg.event.title}</div>`
                        };
                    }

                    // Standard User Reservation: Show "예약" text only on mobile grid
                    return { html: '<div class="text-center fw-bold" style="font-size:0.75rem;">예약</div>' };
                } : undefined,

                dayCellContent: function (info) {
                    var number = info.dayNumberText.replace('일', '');
                    return { html: number };
                },

                dateClick: function (info) {
                    selectedDate = info.dateStr;
                    openReserveModal(selectedDate);
                },
                select: function (info) {
                    selectedDate = info.startStr;
                    openReserveModal(selectedDate);
                }
            });
            calendar.render();
            currentMode = mode;
        }

        initCalendar();

        // Listen for resize to switch modes dynamically
        window.addEventListener('resize', function () {
            var newMode = getMode();
            if (newMode !== currentMode) {
                initCalendar();
            }
        });

        function openReserveModal(dateStr) {
            // Validate Past Date
            const selected = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selected < today) {
                showAlert('지난 날짜는 예약할 수 없습니다.');
                return;
            }

            document.getElementById('resDate').value = dateStr;
            const items = dateStr.split('-');
            document.getElementById('displayDate').innerText = `${items[0]}년 ${items[1]}월 ${items[2]}일`;
            reserveModal.show();
            refreshCaptcha();
        }

        // Submit Logic
        document.getElementById('btnSubmit').addEventListener('click', function () {
            const name = document.getElementById('resName').value;
            const phone = document.getElementById('resPhone').value;
            const password = document.getElementById('resPassword').value;
            const purpose = document.getElementById('resPurpose').value;
            const startTime = document.getElementById('resStartTime').value;
            const endTime = document.getElementById('resEndTime').value;
            const userCaptcha = parseInt(document.getElementById('captchaAnswer').value);
            const agreed = document.getElementById('agreeTerms').checked;

            if (!name || !phone || !password || !purpose) { showAlert('필수 정보를 모두 입력해주세요.'); return; }
            if (password.length !== 4 || isNaN(password)) { showAlert('비밀번호는 숫자 4자리여야 합니다.'); return; }
            if (startTime >= endTime) { showAlert('종료 시간은 시작 시간보다 뒤여야 합니다.'); return; }
            if (!agreed) { showAlert('약관에 동의해주세요.'); return; }
            if (userCaptcha !== captchaAns) { showAlert('자동 예약 방지 정답이 틀렸습니다.'); return; }

            // Save Info
            if (document.getElementById('rememberMe').checked) {
                localStorage.setItem('rememberMe', 'true');
                localStorage.setItem('userName', name);
                localStorage.setItem('userPhone', phone);
                localStorage.setItem('userPassword', password);
            } else {
                localStorage.removeItem('rememberMe');
            }

            const payload = {
                name: name,
                phone: phone,
                password: password,
                purpose: purpose,
                start: `${selectedDate}T${startTime}:00`,
                end: `${selectedDate}T${endTime}:00`
            };

            fetch('/api/reservations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json().then(data => ({ status: res.status, body: data })))
                .then(res => {
                    if (res.status === 201) {
                        reserveModal.hide();
                        calendar.refetchEvents();

                        const downloadBtn = document.getElementById('btnDownloadIcs');
                        downloadBtn.href = `/api/reservations/${res.body.id}/download_ics`;

                        successModal.show();
                    } else {
                        showAlert('예약 실패: ' + res.body.error);
                    }
                })
                .catch(err => {
                    console.error(err);
                    showAlert('서버 통신 오류');
                });
        });

        // Feedback Logic
        document.getElementById('btnSendFeedback').addEventListener('click', function () {
            const msg = document.getElementById('feedbackMsg').value;
            if (!msg.trim()) { showAlert('내용을 입력해주세요.'); return; }

            // Disable button
            this.disabled = true;

            fetch('/api/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            })
                .then(res => res.json())
                .then(data => {
                    this.disabled = false;
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                        modal.hide();
                        document.getElementById('feedbackMsg').value = '';
                        showAlert('소중한 의견 감사합니다!');
                    } else {
                        showAlert('전송 실패: ' + data.error);
                    }
                })
                .catch(() => {
                    this.disabled = false;
                    showAlert('서버 통신 오류');
                });
        });
    });
</script>
{% endblock %}