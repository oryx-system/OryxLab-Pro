{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <h2 class="mb-4 text-center fw-bold">내 예약 관리</h2>

        <!-- Login Card -->
        <div class="card shadow-lg mb-4 border-0" id="loginCard">
            <div class="card-body p-5">
                <div class="text-center mb-4 text-primary">
                    <i class="fas fa-user-circle fa-4x"></i>
                </div>
                <h5 class="card-title fw-bold mb-3 text-center">본인 인증</h5>
                <p class="text-muted text-center mb-4">예약 시 입력한 전화번호로 예약 내역을 조회합니다.</p>
                <div class="form-floating mb-3">
                    <input type="tel" id="myPhone" class="form-control" placeholder="01012345678">
                    <label for="myPhone">전화번호</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" id="myPassword" class="form-control" placeholder="비밀번호" inputmode="numeric"
                        pattern="[0-9]*" maxlength="4">
                    <label for="myPassword">예약 비밀번호 (숫자 4자리)</label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="rememberMe" checked>
                    <label class="form-check-label" for="rememberMe">내 정보 기억하기</label>
                </div>
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" id="btnLookUp">조회하기</button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" style="display:none;">
            <!-- Facility Info Card (Only visible after login) -->
            <div class="card bg-primary text-white mb-4 shadow-lg border-0"
                style="background: linear-gradient(135deg, #00BFA5 0%, #008f7a 100%);">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3"><i class="fas fa-info-circle me-2"></i>시설 이용 정보</h5>
                    <div class="row g-0 bg-white bg-opacity-25 rounded-3 p-3">
                        <div class="col-6 border-end border-white border-opacity-25 text-center">
                            <div class="small opacity-75 text-uppercase fw-bold mb-1">Wi-Fi</div>
                            <div class="fw-bold fs-5" id="wifiInfo">Loading...</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="small opacity-75 text-uppercase fw-bold mb-1">출입문 비밀번호</div>
                            <div class="fw-bold fs-5" id="doorInfo">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold">예약 내역</h4>
                <div>
                    <button class="btn btn-success btn-sm rounded-pill px-3 me-1" id="btnSmartCheckin">
                        <i class="fas fa-qrcode me-1"></i>QR 체크인
                    </button>
                    <button class="btn btn-outline-secondary btn-sm rounded-pill px-3" id="btnLogout">
                        <i class="fas fa-sign-out-alt me-1"></i>로그아웃
                    </button>
                </div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-danger">예약 취소</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="fs-5 mb-3" id="cancelMsg">정말 예약을 취소하시겠습니까?</p>
                <div id="penaltyWarning" class="alert alert-danger d-flex align-items-center" role="alert"
                    style="display: none;">
                    <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                    <div>
                        <div class="fw-bold">위약금(패널티) 안내</div>
                        <div class="small">당일 취소 시 <strong>30일간 예약이 제한</strong>됩니다.</div>
                    </div>
                </div>
                <div class="form-check" id="penaltyCheckArea">
                    <input class="form-check-input" type="checkbox" id="agreePenalty">
                    <label class="form-check-label fw-bold" for="agreePenalty">
                        위 내용을 확인하였으며, 패널티 부과에 동의합니다.
                    </label>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-danger rounded-pill px-4" id="btnConfirmCancel">예약 취소</button>
            </div>
        </div>
    </div>
</div>

<!-- Modify Modal -->
<div class="modal fade" id="modifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-edit me-2"></i>예약 변경</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-3 text-muted">새로운 예약 시간을 선택해주세요.</p>
                <div class="mb-3">
                    <label class="form-label fw-bold">날짜</label>
                    <input type="date" class="form-control" id="modifyDate">
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="form-label fw-bold">시작</label>
                        <select class="form-select" id="modifyStartTime"></select>
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">종료</label>
                        <select class="form-select" id="modifyEndTime"></select>
                    </div>
                </div>
                <div id="modifyAvailabilityMsg" class="mt-2 small"></div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" id="btnConfirmModify">변경하기</button>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-camera me-2"></i>퇴실 인증 (청소 확인)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-3 text-center fs-5">다음 사용자를 위해 자리를 정돈하셨나요?<br>퇴실 처리를 진행합니다.</p>

                <div class="d-grid mt-4">
                    <button type="button" class="btn btn-success btn-lg" id="btnConfirmCheckout">
                        네, 정리했습니다 (퇴실)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPhone = '';
    let targetCancelId = null;
    let isPenalty = false;
    let checkoutModal = null;
    let cancelModal = null;

    // Initialize Modals safely after DOM loaded
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof bootstrap !== 'undefined') {
            checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
            cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
        } else {
            console.error('Bootstrap 5 not found!');
        }
    });

    // Load saved info if exists
    if (localStorage.getItem('myPhone')) {
        document.getElementById('myPhone').value = localStorage.getItem('myPhone');
        document.getElementById('rememberMe').checked = true;
    }
    if (localStorage.getItem('myPassword')) {
        document.getElementById('myPassword').value = localStorage.getItem('myPassword');
    }

    document.getElementById('btnLookUp').addEventListener('click', loadHistory);

    // 엔터 키로 조회
    document.getElementById('myPassword').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            loadHistory();
        }
    });
    document.getElementById('myPhone').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            loadHistory();
        }
    });

    function loadHistory() {
        const phone = document.getElementById('myPhone').value;
        const password = document.getElementById('myPassword').value;

        if (!phone || !password) {
            showAlert('전화번호와 비밀번호를 모두 입력해주세요.');
            return;
        }

        // Save to local storage if checked
        if (document.getElementById('rememberMe').checked) {
            localStorage.setItem('myPhone', phone);
            localStorage.setItem('myPassword', password);
        } else {
            localStorage.removeItem('myPhone');
            localStorage.removeItem('myPassword');
        }

        const btn = document.getElementById('btnLookUp');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>조회 중...';

        fetch('/api/my_history', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, password: password })
        })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '조회하기';

                if (data.success) {
                    currentPhone = phone;
                    document.getElementById('loginCard').style.display = 'none';
                    document.getElementById('historySection').style.display = 'block';

                    document.getElementById('wifiInfo').innerText = data.wifi_info || '-';
                    document.getElementById('doorInfo').innerText = data.door_pw || '-';

                    renderList(data.reservations);
                } else {
                    showAlert('조회 실패: ' + data.error);
                }
            })
            .catch(() => {
                btn.disabled = false;
                btn.innerHTML = '조회하기';
                showAlert('서버 통신 오류');
            });
    }

    document.getElementById('btnLogout').addEventListener('click', function () {
        currentPhone = '';
        document.getElementById('loginCard').style.display = 'block';
        document.getElementById('historySection').style.display = 'none';
        document.getElementById('myPassword').value = '';
    });

    document.getElementById('btnSmartCheckin').addEventListener('click', function () {
        if (!currentPhone) return;

        // Save info to be picked up by checkin.html
        localStorage.setItem('userPhone', currentPhone);
        const currentPw = document.getElementById('myPassword').value;
        if (currentPw) localStorage.setItem('userPassword', currentPw);

        // Show QR Guide Modal (defined in base.html)
        const qrModal = new bootstrap.Modal(document.getElementById('qrCheckinGuideModal'));
        qrModal.show();
    });

    // Checkout Logic
    const photoInput = document.getElementById('cleanPhoto');
    const fileNameDisplay = document.getElementById('fileName');
    let checkoutPhone = '';

    if (photoInput) {
        photoInput.addEventListener('change', function () {
            if (this.files && this.files[0] && fileNameDisplay) {
                fileNameDisplay.innerText = this.files[0].name;
                fileNameDisplay.classList.add('fw-bold', 'text-success');
            }
        });
    }

    window.openCheckout = function () {
        checkoutPhone = currentPhone;
        if (checkoutModal) checkoutModal.show();
    }

    document.getElementById('btnConfirmCheckout').addEventListener('click', function () {
        // User Request: Remove photo upload requirement, just confirm
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>처리 중...';

        fetch('/api/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: checkoutPhone })
        })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '인증하고 퇴실하기';

                if (data.success) {
                    if (checkoutModal) checkoutModal.hide();
                    showAlert(data.message, function () {
                        loadHistory();
                    });
                } else {
                    showAlert('퇴실 처리 실패: ' + data.error);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = '인증하고 퇴실하기';
                showAlert('서버 통신 오류');
            });
    });

    // Modified renderList to include Checkout Button
    function renderList(list) {
        const container = document.getElementById('historyList');
        container.innerHTML = '';

        if (list.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-calendar-times fa-3x mb-3 opacity-50"></i>
                    <p>예약 내역이 없습니다.</p>
                </div>`;
            document.getElementById('wifiInfo').innerText = '-';
            document.getElementById('doorInfo').innerText = '-';
            return;
        }

        list.forEach(item => {
            const statusMap = {
                'reserved': '<span class="badge bg-primary rounded-pill px-3">예약중</span>',
                'checked_in': '<span class="badge bg-success rounded-pill px-3">사용중</span>',
                'ended': '<span class="badge bg-secondary rounded-pill px-3">종료</span>',
                'cancelled': '<span class="badge bg-warning text-dark rounded-pill px-3">취소됨</span>',
                'noshow_penalty': '<span class="badge bg-danger rounded-pill px-3">노쇼 차단</span>'
            };

            const card = document.createElement('div');
            card.className = 'card mb-3 border-0 shadow-sm';

            let btnHtml = '';
            if (item.status === 'reserved') {
                // Use data attributes and class for delegation
                btnHtml = `<button class="btn btn-sm btn-outline-primary rounded-pill px-3 me-1 btn-modify-reservation" 
                           data-id="${item.id}" data-start="${item.start}" data-end="${item.end}"><i class="fas fa-edit me-1"></i>변경</button>
                           <button class="btn btn-sm btn-outline-danger rounded-pill px-3 btn-cancel-reservation" 
                           data-id="${item.id}" data-start="${item.start}">취소</button>`;
            } else if (item.status === 'checked_in') {
                btnHtml = `<button class="btn btn-sm btn-success rounded-pill px-3 shadow" onclick="openCheckout()"><i class="fas fa-camera me-1"></i>퇴실/청소 인증</button>`;
            }

            // Check if multi-day reservation
            const startDate = item.start.split(' ')[0];
            const startTime = item.start.split(' ')[1];
            const endParts = item.end.split(' ');
            const endDate = endParts.length > 1 ? endParts[0] : startDate;
            const endTime = endParts.length > 1 ? endParts[1] : item.end;

            const isMultiDay = startDate !== endDate;

            let dateDisplay, timeDisplay;
            if (isMultiDay) {
                // Multi-day: Show date range
                dateDisplay = `${startDate} ~ ${endDate}`;
                timeDisplay = `${startTime} ~ ${endTime}`;
            } else {
                // Single day: Show only date
                dateDisplay = startDate;
                timeDisplay = `${startTime} ~ ${endTime}`;
            }

            // Added Name display
            card.innerHTML = `
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="fw-bold mb-1">${dateDisplay}</h5>
                            <div class="text-primary fw-bold">${timeDisplay}</div>
                        </div>
                        ${statusMap[item.status] || item.status}
                    </div>
                    <div class="d-flex align-items-center text-muted small mb-2">
                        <i class="fas fa-user me-2" style="width: 20px; text-align: center;"></i> ${item.name}
                    </div>
                    <div class="d-flex align-items-center text-muted small mb-3">
                        <i class="fas fa-book-open me-2" style="width: 20px; text-align: center;"></i> ${item.purpose || '목적 미기입'}
                    </div>
                    <div class="d-flex flex-column flex-sm-row gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="previewPdf('${item.id}')">
                            <i class="fas fa-file-pdf me-1"></i>신청서 미리보기
                        </button>
                        <div class="flex-grow-1 d-flex align-items-center gap-1">
                            <span class="badge bg-success py-2 flex-grow-1"><i class="fas fa-check me-1"></i>자동 제출됨</span>
                            <button class="btn btn-sm btn-outline-secondary" onclick="resendPdfToAdmin('${item.id}')" title="재전송">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-end border-top pt-3">
                        ${btnHtml}
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // PDF Functions
    function previewPdf(id) {
        const phone = document.getElementById('myPhone').value;
        const password = document.getElementById('myPassword').value;

        fetch(`/api/reservations/${id}/preview_pdf`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, password: password })
        })
            .then(res => {
                if (res.ok) return res.blob();
                return res.json().then(err => { throw new Error(err.error); });
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                window.open(url, '_blank');
            })
            .catch(err => showAlert('오류: ' + err.message));
    }

    function resendPdfToAdmin(id) {
        if (!confirm('신청서를 관리자에게 다시 전송하시겠습니까?')) return;

        const phone = document.getElementById('myPhone').value;
        const password = document.getElementById('myPassword').value;

        fetch(`/api/reservations/${id}/resend_telegram`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, password: password })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert('신청서가 재전송되었습니다.');
                } else {
                    showAlert('전송 실패: ' + data.error);
                }
            })
            .catch(err => showAlert('서버 통신 오류'));
    }

    // Event Delegation for Modify Button
    let modifyModal = null;
    let targetModifyId = null;

    document.addEventListener('DOMContentLoaded', function () {
        if (typeof bootstrap !== 'undefined') {
            modifyModal = new bootstrap.Modal(document.getElementById('modifyModal'));
        }
        // Populate time options
        const startSel = document.getElementById('modifyStartTime');
        const endSel = document.getElementById('modifyEndTime');
        for (let h = 9; h <= 21; h++) {
            const t = h.toString().padStart(2, '0') + ':00';
            startSel.innerHTML += `<option value="${t}">${t}</option>`;
            const endT = (h + 1).toString().padStart(2, '0') + ':00';
            endSel.innerHTML += `<option value="${endT}">${endT}</option>`;
        }
    });

    document.getElementById('historyList').addEventListener('click', function (e) {
        const modBtn = e.target.closest('.btn-modify-reservation');
        if (modBtn) {
            const id = modBtn.getAttribute('data-id');
            const start = modBtn.getAttribute('data-start');
            openModify(id, start);
            return;
        }
        const btn = e.target.closest('.btn-cancel-reservation');
        if (btn) {
            const id = btn.getAttribute('data-id');
            const start = btn.getAttribute('data-start');
            openCancel(id, start);
        }
    });

    function openModify(id, startStr) {
        targetModifyId = id;
        const dateStr = startStr.split(' ')[0];
        const timeStr = startStr.split(' ')[1];

        document.getElementById('modifyDate').value = dateStr;
        document.getElementById('modifyStartTime').value = timeStr;

        // Set min date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('modifyDate').min = today;

        if (modifyModal) modifyModal.show();
    }

    document.getElementById('btnConfirmModify').addEventListener('click', function () {
        if (!targetModifyId) return;

        const newDate = document.getElementById('modifyDate').value;
        const newStart = document.getElementById('modifyStartTime').value;
        const newEnd = document.getElementById('modifyEndTime').value;
        const password = document.getElementById('myPassword').value;

        if (!newDate || !newStart || !newEnd) {
            showAlert('날짜와 시간을 선택해주세요.');
            return;
        }

        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>처리 중...';

        fetch(`/api/reservations/${targetModifyId}/modify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                password: password,
                new_start: `${newDate}T${newStart}:00`,
                new_end: `${newDate}T${newEnd}:00`
            })
        })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '변경하기';

                if (data.success) {
                    if (modifyModal) modifyModal.hide();
                    showAlert('예약이 변경되었습니다.', () => loadHistory());
                } else {
                    showAlert('변경 실패: ' + data.error);
                }
            })
            .catch(() => {
                btn.disabled = false;
                btn.innerHTML = '변경하기';
                showAlert('서버 통신 오류');
            });
    });

    // Open Cancel Modal
    window.openCancel = function (id, startStr) {
        if (!id || !startStr) {
            alert('오류: 예약 정보를 불러올 수 없습니다.');
            return;
        }

        targetCancelId = id;

        // Date Logic (String Comparison for Robustness)
        const resDateStr = startStr.split(' ')[0]; // YYYY-MM-DD

        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;

        isPenalty = (resDateStr === todayStr);

        // Try to show Modal
        try {
            if (!cancelModal) {
                // Try to init if missing?
                if (typeof bootstrap !== 'undefined') {
                    cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
                } else {
                    throw new Error('Bootstrap missing');
                }
            }

            if (isPenalty) {
                document.getElementById('penaltyWarning').style.display = 'flex';
                document.getElementById('penaltyCheckArea').style.display = 'block';
                document.getElementById('cancelMsg').innerText = "당일 취소는 패널티가 부과됩니다.\n정말 취소하시겠습니까?";
                document.getElementById('btnConfirmCancel').disabled = true;
                document.getElementById('agreePenalty').checked = false;
            } else {
                document.getElementById('penaltyWarning').style.display = 'none';
                document.getElementById('penaltyCheckArea').style.display = 'none';
                document.getElementById('cancelMsg').innerText = "정말 예약을 취소하시겠습니까?";
                document.getElementById('btnConfirmCancel').disabled = false;
            }

            cancelModal.show();

        } catch (e) {
            // Fallback to native confirm
            let msg = "정말 예약을 취소하시겠습니까?";
            if (isPenalty) {
                msg = "당일 취소는 30일간 예약이 제한되는 패널티가 부과됩니다.\n동의하고 취소하시겠습니까?";
            }

            if (confirm(msg)) {
                cancelReservationApi(targetCancelId, isPenalty);
            }
        }
    };

    // Helper for API call
    function cancelReservationApi(id, penalty) {
        fetch(`/api/reservations/${id}/cancel`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_penalty: penalty })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (cancelModal) {
                        try { cancelModal.hide(); } catch (e) { }
                    }
                    showAlert('취소되었습니다.', function () {
                        loadHistory();
                    });
                } else {
                    showAlert('오류: ' + data.error);
                }
            })
            .catch(err => {
                showAlert('서버 통신 오류');
            });
    }

    document.getElementById('agreePenalty').addEventListener('change', function () {
        document.getElementById('btnConfirmCancel').disabled = !this.checked;
    });

    document.getElementById('btnConfirmCancel').addEventListener('click', function () {
        if (!targetCancelId) return;
        this.disabled = true;
        cancelReservationApi(targetCancelId, isPenalty);
    });
</script>
{% endblock %}