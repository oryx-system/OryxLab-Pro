{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <h2 class="mb-4 text-center fw-bold">ë‚´ ì˜ˆì•½ ê´€ë¦¬</h2>

        <!-- Login Card -->
        <div class="card shadow-lg mb-4 border-0" id="loginCard">
            <div class="card-body p-5">
                <div class="text-center mb-4 text-primary">
                    <i class="fas fa-user-circle fa-4x"></i>
                </div>
                <h5 class="card-title fw-bold mb-3 text-center">ë³¸ì¸ ì¸ì¦</h5>
                <p class="text-muted text-center mb-4">ì˜ˆì•½ ì‹œ ì…ë ¥í•œ ì „í™”ë²ˆí˜¸ë¡œ ì˜ˆì•½ ë‚´ì—­ì„ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
                <div class="form-floating mb-3">
                    <input type="tel" id="myPhone" class="form-control" placeholder="01012345678">
                    <label for="myPhone">ì „í™”ë²ˆí˜¸</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" id="myPassword" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸" inputmode="numeric"
                        pattern="[0-9]*" maxlength="4">
                    <label for="myPassword">ì˜ˆì•½ ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì 4ìë¦¬)</label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="rememberMe" checked>
                    <label class="form-check-label" for="rememberMe">ë‚´ ì •ë³´ ê¸°ì–µí•˜ê¸°</label>
                </div>
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" id="btnLookUp">ì¡°íšŒí•˜ê¸°</button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" style="display:none;">
            <!-- Facility Info Card (Only visible after login) -->
            <div class="card bg-primary text-white mb-4 shadow-lg border-0"
                style="background: linear-gradient(135deg, #00BFA5 0%, #008f7a 100%);">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3"><i class="fas fa-info-circle me-2"></i>ì‹œì„¤ ì´ìš© ì •ë³´</h5>
                    <div class="row g-0 bg-white bg-opacity-25 rounded-3 p-3">
                        <div class="col-6 border-end border-white border-opacity-25 text-center">
                            <div class="small opacity-75 text-uppercase fw-bold mb-1">Wi-Fi</div>
                            <div class="fw-bold fs-5" id="wifiInfo">Loading...</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="small opacity-75 text-uppercase fw-bold mb-1">ì¶œì…ë¬¸ ë¹„ë°€ë²ˆí˜¸</div>
                            <div class="fw-bold fs-5" id="doorInfo">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold">ì˜ˆì•½ ë‚´ì—­</h4>
                <div>
                    <button class="btn btn-success btn-sm rounded-pill px-3 me-1" id="btnSmartCheckin">
                        <i class="fas fa-qrcode me-1"></i>QR ì²´í¬ì¸
                    </button>
                    <button class="btn btn-outline-secondary btn-sm rounded-pill px-3" id="btnLogout">
                        <i class="fas fa-sign-out-alt me-1"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
            <div id="historyList"></div>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-danger">ì˜ˆì•½ ì·¨ì†Œ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="fs-5 mb-3" id="cancelMsg">ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div id="penaltyWarning" class="alert alert-danger d-flex align-items-center" role="alert"
                    style="display: none;">
                    <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                    <div>
                        <div class="fw-bold">ìœ„ì•½ê¸ˆ(íŒ¨ë„í‹°) ì•ˆë‚´</div>
                        <div class="small">ë‹¹ì¼ ì·¨ì†Œ ì‹œ <strong>30ì¼ê°„ ì˜ˆì•½ì´ ì œí•œ</strong>ë©ë‹ˆë‹¤.</div>
                    </div>
                </div>
                <div class="form-check" id="penaltyCheckArea">
                    <input class="form-check-input" type="checkbox" id="agreePenalty">
                    <label class="form-check-label fw-bold" for="agreePenalty">
                        ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©°, íŒ¨ë„í‹° ë¶€ê³¼ì— ë™ì˜í•©ë‹ˆë‹¤.
                    </label>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-danger rounded-pill px-4" id="btnConfirmCancel">ì˜ˆì•½ ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-camera me-2"></i>í‡´ì‹¤ ì¸ì¦ (ì²­ì†Œ í™•ì¸)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-3">ë‹¤ìŒ ì‚¬ìš©ìë¥¼ ìœ„í•´ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•˜ì…¨ë‚˜ìš”?<br>ì •ë¦¬ëœ ê³µê°„ ì‚¬ì§„ì„ ì°ì–´ ì˜¬ë ¤ì£¼ì„¸ìš”.</p>

                <div class="mb-4 text-center">
                    <label for="cleanPhoto" class="btn btn-outline-success w-100 p-4 border-2 border-dashed"
                        style="border-style: dashed;">
                        <i class="fas fa-camera fa-2x mb-2"></i><br>
                        <span id="fileName">ì‚¬ì§„ ì´¬ì˜ ë˜ëŠ” ì„ íƒ</span>
                    </label>
                    <input type="file" id="cleanPhoto" class="d-none" accept="image/*" capture="environment">
                </div>

                <div class="d-grid">
                    <button type="button" class="btn btn-success btn-lg" id="btnConfirmCheckout">
                        ì¸ì¦í•˜ê³  í‡´ì‹¤í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPhone = '';
    let targetCancelId = null;
    let isPenalty = false;
    let checkoutModal = null;
    let cancelModal = null;

    // Initialize Modals safely after DOM loaded
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof bootstrap !== 'undefined') {
            checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
            cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
        } else {
            console.error('Bootstrap 5 not found!');
        }
    });

    // Load saved info if exists
    if (localStorage.getItem('myPhone')) {
        document.getElementById('myPhone').value = localStorage.getItem('myPhone');
        document.getElementById('rememberMe').checked = true;
    }
    if (localStorage.getItem('myPassword')) {
        document.getElementById('myPassword').value = localStorage.getItem('myPassword');
    }

    document.getElementById('btnLookUp').addEventListener('click', loadHistory);

    function loadHistory() {
        const phone = document.getElementById('myPhone').value;
        const password = document.getElementById('myPassword').value;

        if (!phone || !password) {
            showAlert('ì „í™”ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // Save to local storage if checked
        if (document.getElementById('rememberMe').checked) {
            localStorage.setItem('myPhone', phone);
            localStorage.setItem('myPassword', password);
        } else {
            localStorage.removeItem('myPhone');
            localStorage.removeItem('myPassword');
        }

        const btn = document.getElementById('btnLookUp');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ì¡°íšŒ ì¤‘...';

        fetch('/api/my_history', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, password: password })
        })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = 'ì¡°íšŒí•˜ê¸°';

                if (data.success) {
                    currentPhone = phone;
                    document.getElementById('loginCard').style.display = 'none';
                    document.getElementById('historySection').style.display = 'block';

                    document.getElementById('wifiInfo').innerText = data.wifi_info || '-';
                    document.getElementById('doorInfo').innerText = data.door_pw || '-';

                    renderList(data.reservations);
                } else {
                    showAlert('ì¡°íšŒ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(() => {
                btn.disabled = false;
                btn.innerHTML = 'ì¡°íšŒí•˜ê¸°';
                showAlert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
            });
    }

    document.getElementById('btnLogout').addEventListener('click', function () {
        currentPhone = '';
        document.getElementById('loginCard').style.display = 'block';
        document.getElementById('historySection').style.display = 'none';
        document.getElementById('myPassword').value = '';
    });

    document.getElementById('btnSmartCheckin').addEventListener('click', function () {
        if (!currentPhone) return;

        // Save info to be picked up by checkin.html
        localStorage.setItem('userPhone', currentPhone);
        const currentPw = document.getElementById('myPassword').value;
        if (currentPw) localStorage.setItem('userPassword', currentPw);

        // Show instruction to use native camera
        alert('ğŸ“± QR ì²´í¬ì¸ ë°©ë²•\n\n1. ìŠ¤ë§ˆíŠ¸í° ê¸°ë³¸ ì¹´ë©”ë¼ ì•±ì„ ì—´ì–´ì£¼ì„¸ìš”.\n2. ì¶œì…ë¬¸ì— ë¶€ì°©ëœ QR í¬ìŠ¤í„°ë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”.\n3. ìë™ìœ¼ë¡œ ì²´í¬ì¸ í˜ì´ì§€ê°€ ì—´ë¦½ë‹ˆë‹¤.\n4. "ì…ì‹¤ í™•ì¸" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì™„ë£Œ!');
    });

    // Checkout Logic
    const photoInput = document.getElementById('cleanPhoto');
    const fileNameDisplay = document.getElementById('fileName');
    let checkoutPhone = '';

    photoInput.addEventListener('change', function () {
        if (this.files && this.files[0]) {
            fileNameDisplay.innerText = this.files[0].name;
            fileNameDisplay.classList.add('fw-bold', 'text-success');
        }
    });

    window.openCheckout = function () {
        checkoutPhone = currentPhone;
        if (checkoutModal) checkoutModal.show();
    }

    document.getElementById('btnConfirmCheckout').addEventListener('click', function () {
        const file = photoInput.files[0];
        if (!file) {
            showAlert('ì²­ì†Œ ì¸ì¦ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
            return;
        }

        const formData = new FormData();
        formData.append('photo', file);
        formData.append('phone', checkoutPhone);

        // Loading state
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ì—…ë¡œë“œ ì¤‘...';

        fetch('/api/checkout', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = 'ì¸ì¦í•˜ê³  í‡´ì‹¤í•˜ê¸°';

                if (data.success) {
                    if (checkoutModal) checkoutModal.hide();
                    showAlert(data.message, function () {
                        loadHistory();
                    });
                } else {
                    showAlert('í‡´ì‹¤ ì²˜ë¦¬ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = 'ì¸ì¦í•˜ê³  í‡´ì‹¤í•˜ê¸°';
                showAlert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
            });
    });

    // Modified renderList to include Checkout Button
    function renderList(list) {
        const container = document.getElementById('historyList');
        container.innerHTML = '';

        if (list.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-calendar-times fa-3x mb-3 opacity-50"></i>
                    <p>ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>`;
            document.getElementById('wifiInfo').innerText = '-';
            document.getElementById('doorInfo').innerText = '-';
            return;
        }

        list.forEach(item => {
            const statusMap = {
                'reserved': '<span class="badge bg-primary rounded-pill px-3">ì˜ˆì•½ì¤‘</span>',
                'checked_in': '<span class="badge bg-success rounded-pill px-3">ì‚¬ìš©ì¤‘</span>',
                'ended': '<span class="badge bg-secondary rounded-pill px-3">ì¢…ë£Œ</span>',
                'cancelled': '<span class="badge bg-warning text-dark rounded-pill px-3">ì·¨ì†Œë¨</span>',
                'noshow_penalty': '<span class="badge bg-danger rounded-pill px-3">ë…¸ì‡¼ ì°¨ë‹¨</span>'
            };

            const card = document.createElement('div');
            card.className = 'card mb-3 border-0 shadow-sm';

            let btnHtml = '';
            if (item.status === 'reserved') {
                // Use data attributes and class for delegation
                btnHtml = `<button class="btn btn-sm btn-outline-danger rounded-pill px-3 btn-cancel-reservation" 
                           data-id="${item.id}" data-start="${item.start}">ì˜ˆì•½ ì·¨ì†Œ</button>`;
            } else if (item.status === 'checked_in') {
                btnHtml = `<button class="btn btn-sm btn-success rounded-pill px-3 shadow" onclick="openCheckout()"><i class="fas fa-camera me-1"></i>í‡´ì‹¤/ì²­ì†Œ ì¸ì¦</button>`;
            }

            // Added Name display
            card.innerHTML = `
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="fw-bold mb-1">${item.start.split(' ')[0]}</h5>
                            <div class="text-primary fw-bold">${item.start.split(' ')[1]} ~ ${item.end}</div>
                        </div>
                        ${statusMap[item.status] || item.status}
                    </div>
                    <div class="d-flex align-items-center text-muted small mb-2">
                        <i class="fas fa-user me-2" style="width: 20px; text-align: center;"></i> ${item.name}
                    </div>
                    <div class="d-flex align-items-center text-muted small mb-3">
                        <i class="fas fa-book-open me-2" style="width: 20px; text-align: center;"></i> ${item.purpose || 'ëª©ì  ë¯¸ê¸°ì…'}
                    </div>
                    <div class="d-flex flex-column flex-sm-row gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="previewPdf('${item.id}')">
                            <i class="fas fa-file-pdf me-1"></i>ì‹ ì²­ì„œ ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button class="btn btn-sm btn-outline-dark flex-grow-1" onclick="sendPdfToAdmin('${item.id}')">
                            <i class="fas fa-paper-plane me-1"></i>ê´€ë¦¬ìì—ê²Œ ì œì¶œ
                        </button>
                    </div>
                    <div class="text-end border-top pt-3">
                        ${btnHtml}
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // PDF Functions
    function previewPdf(id) {
        const phone = document.getElementById('myPhone').value;
        const password = document.getElementById('myPassword').value;

        fetch(`/api/reservations/${id}/preview_pdf`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, password: password })
        })
            .then(res => {
                if (res.ok) return res.blob();
                return res.json().then(err => { throw new Error(err.error); });
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                window.open(url, '_blank');
            })
            .catch(err => showAlert('ì˜¤ë¥˜: ' + err.message));
    }

    function sendPdfToAdmin(id) {
        if (!confirm('ì‹œì„¤ ì‚¬ìš© ì‹ ì²­ì„œë¥¼ ê´€ë¦¬ìì—ê²Œ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const phone = document.getElementById('myPhone').value;
        const password = document.getElementById('myPassword').value;

        fetch(`/api/reservations/${id}/send_to_admin`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, password: password })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert('ì‹ ì²­ì„œê°€ ê´€ë¦¬ìì—ê²Œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    showAlert('ì œì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(err => showAlert('ì„œë²„ í†µì‹  ì˜¤ë¥˜'));
    }

    // Event Delegation for Cancel Button
    document.getElementById('historyList').addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-cancel-reservation');
        if (btn) {
            const id = btn.getAttribute('data-id');
            const start = btn.getAttribute('data-start');
            openCancel(id, start);
        }
    });

    // Open Cancel Modal
    window.openCancel = function (id, startStr) {
        if (!id || !startStr) {
            alert('ì˜¤ë¥˜: ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        targetCancelId = id;

        // Date Logic (String Comparison for Robustness)
        const resDateStr = startStr.split(' ')[0]; // YYYY-MM-DD

        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;

        isPenalty = (resDateStr === todayStr);

        // Try to show Modal
        try {
            if (!cancelModal) {
                // Try to init if missing?
                if (typeof bootstrap !== 'undefined') {
                    cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
                } else {
                    throw new Error('Bootstrap missing');
                }
            }

            if (isPenalty) {
                document.getElementById('penaltyWarning').style.display = 'flex';
                document.getElementById('penaltyCheckArea').style.display = 'block';
                document.getElementById('cancelMsg').innerText = "ë‹¹ì¼ ì·¨ì†ŒëŠ” íŒ¨ë„í‹°ê°€ ë¶€ê³¼ë©ë‹ˆë‹¤.\nì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                document.getElementById('btnConfirmCancel').disabled = true;
                document.getElementById('agreePenalty').checked = false;
            } else {
                document.getElementById('penaltyWarning').style.display = 'none';
                document.getElementById('penaltyCheckArea').style.display = 'none';
                document.getElementById('cancelMsg').innerText = "ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                document.getElementById('btnConfirmCancel').disabled = false;
            }

            cancelModal.show();

        } catch (e) {
            // Fallback to native confirm
            let msg = "ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            if (isPenalty) {
                msg = "ë‹¹ì¼ ì·¨ì†ŒëŠ” 30ì¼ê°„ ì˜ˆì•½ì´ ì œí•œë˜ëŠ” íŒ¨ë„í‹°ê°€ ë¶€ê³¼ë©ë‹ˆë‹¤.\në™ì˜í•˜ê³  ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            }

            if (confirm(msg)) {
                cancelReservationApi(targetCancelId, isPenalty);
            }
        }
    };

    // Helper for API call
    function cancelReservationApi(id, penalty) {
        fetch(`/api/reservations/${id}/cancel`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_penalty: penalty })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (cancelModal) {
                        try { cancelModal.hide(); } catch (e) { }
                    }
                    showAlert('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', function () {
                        loadHistory();
                    });
                } else {
                    showAlert('ì˜¤ë¥˜: ' + data.error);
                }
            })
            .catch(err => {
                showAlert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
            });
    }

    document.getElementById('agreePenalty').addEventListener('change', function () {
        document.getElementById('btnConfirmCancel').disabled = !this.checked;
    });

    document.getElementById('btnConfirmCancel').addEventListener('click', function () {
        if (!targetCancelId) return;
        this.disabled = true;
        cancelReservationApi(targetCancelId, isPenalty);
    });
</script>
{% endblock %}