{% extends "base.html" %}

{% block content %}
<div class="row align-items-center mb-4">
    <div class="col">
        <h2 class="fw-bold text-danger"><i class="fas fa-terminal me-2"></i>개발자 콘솔</h2>
        <p class="text-muted mb-0">시스템 상태 및 로그 분석</p>
    </div>
    <div class="col-auto">
        <div class="d-flex align-items-center gap-2">
            <a href="/admin" class="btn btn-outline-primary"><i class="fas fa-user-shield me-2"></i>관리자 페이지</a>
            <div class="vr"></div>
            <a href="/dev/download_logs" class="btn btn-outline-dark"><i class="fas fa-download me-2"></i>로그 DB 다운로드</a>
            <a href="/logout" class="btn btn-outline-danger">로그아웃</a>
        </div>
    </div>
</div>

<!-- Status Cards -->
<div class="row g-4 mb-4">
    <!-- Maintenance Status -->
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body d-flex align-items-center">
                <div class="flex-shrink-0">
                    <div
                        class="rounded-circle p-3 {% if maintenance_mode %}bg-danger bg-opacity-10 text-danger{% else %}bg-success bg-opacity-10 text-success{% endif %}">
                        <i class="fas fa-server fa-lg"></i>
                    </div>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="text-muted text-uppercase small fw-bold mb-1">유지보수 모드 (서버 점검)</h6>
                    <div class="d-flex align-items-center justify-content-between">
                        <h4 class="mb-0 fw-bold" id="maintenanceLabel">
                            {% if maintenance_mode %}활성{% else %}비활성{% endif %}
                        </h4>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="maintenanceSwitch"
                                style="transform: scale(1.4);" {% if maintenance_mode %}checked{% endif %}>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Integrity Status -->
    <div class="col-md-6 col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="text-muted text-uppercase small fw-bold mb-0">시스템 무결성 상태</h6>
                    <button class="btn btn-sm btn-info text-white rounded-pill px-3" id="btnIntegrityCheck">
                        <i class="fas fa-stethoscope me-1"></i>검사 실행
                    </button>
                </div>
                <div id="integrityResult" class="bg-light rounded p-2 small text-muted">
                    <i class="fas fa-info-circle me-1"></i>'검사 실행'을 클릭하여 데이터 불일치 항목을 확인하세요.
                </div>
                <button class="btn btn-sm btn-warning mt-2 w-100 d-none animate__animated animate__fadeIn"
                    id="btnIntegrityFix">
                    <i class="fas fa-magic me-1"></i>문제 자동 해결
                </button>
            </div>
        </div>
    </div>

    <!-- Data Cleanup Card -->
    <div class="col-md-12 col-lg-12">
        <div class="card shadow-sm border-0 bg-light">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-dark fw-bold mb-1"><i class="fas fa-shield-alt text-primary me-2"></i>개인정보 데이터 관리
                        (Retention Policy)</h6>
                    <p class="mb-0 small text-muted">보존 기간(1년)이 지난 개인정보를 파기합니다. (예약 이력은 통계용으로 보존됨)</p>
                </div>
                <button class="btn btn-outline-danger btn-sm rounded-pill px-4" id="btnCleanup">
                    <i class="fas fa-trash-restore me-1"></i>오래된 개인정보 파기
                </button>
            </div>
        </div>
    </div>
</div>

<!-- DB Restore Card -->
<div class="row g-4 mb-4">
    <div class="col-md-12 col-lg-6">
        <div class="card shadow-sm border-0 bg-light">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-dark fw-bold mb-1"><i class="fas fa-database text-warning me-2"></i>데이터베이스 복원</h6>
                    <p class="mb-0 small text-muted">백업 파일(.sqlite)을 업로드하여 복원합니다.</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/admin/backup" class="btn btn-success btn-sm rounded-pill px-3">
                        <i class="fas fa-download me-1"></i>DB 백업
                    </a>
                    <input type="file" id="dbRestoreFile" accept=".sqlite,.db" class="d-none">
                    <button class="btn btn-outline-warning btn-sm rounded-pill px-3" id="btnRestoreDb">
                        <i class="fas fa-upload me-1"></i>DB 복원
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Password Management -->
    <div class="col-md-12 col-lg-6">
        <div class="card shadow-sm border-0 bg-light">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="text-dark fw-bold mb-1"><i class="fas fa-key text-danger me-2"></i>관리자 비밀번호</h6>
                    <small class="text-muted">개발자 전용 - 관리자에게 노출 금지</small>
                </div>
                <div class="input-group input-group-sm" style="width: auto;">
                    <input type="text" class="form-control text-center fw-bold" id="adminPwDisplay"
                        value="{{ settings.get('admin_pw_plaintext', '(해시 전용)') }}" readonly style="min-width: 120px;">
                    <button class="btn btn-outline-secondary" type="button" id="btnCopyAdminPw" title="복사">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Telegram Masking Toggle -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body d-flex align-items-center">
                <div class="flex-shrink-0">
                    <div class="rounded-circle p-3 bg-info bg-opacity-10 text-info">
                        <i class="fas fa-user-shield fa-lg"></i>
                    </div>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="text-muted text-uppercase small fw-bold mb-1">텔레그램 개인정보 마스킹</h6>
                    <div class="d-flex align-items-center justify-content-between">
                        <h4 class="mb-0 fw-bold" id="maskingLabel">
                            {{ '활성' if settings.get('telegram_mask_info', 'true') == 'true' else '해제' }}
                        </h4>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="maskingSwitch"
                                style="transform: scale(1.4);" {{ 'checked' if settings.get('telegram_mask_info', 'true'
                                )=='true' else '' }}>
                        </div>
                    </div>
                    <small class="text-muted">해제 시 텔레그램에 이름/전번 전체 표시</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Developer Telegram Settings -->
    <div class="col-md-6 col-lg-8">
        <div class="card shadow-sm border-0 h-100 border-danger border-opacity-25">
            <div class="card-body">
                <h6 class="text-danger fw-bold mb-3"><i class="fas fa-bell me-2"></i>개발자 감시 알림 설정</h6>
                <div class="row g-2">
                    <div class="col-md-5">
                        <label class="form-label small fw-bold mb-1">Bot Token</label>
                        <input type="text" class="form-control form-control-sm" id="devTelegramToken"
                            value="{{ settings.get('dev_telegram_token', '') }}" placeholder="123456:ABC...">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold mb-1">Chat ID</label>
                        <input type="text" class="form-control form-control-sm" id="devTelegramChatId"
                            value="{{ settings.get('dev_telegram_chat_id', '') }}" placeholder="-100123456789">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-danger btn-sm w-100" id="btnSaveDevTelegram">
                            <i class="fas fa-save me-1"></i>저장
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center mt-3 p-2 bg-light rounded">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="pauseDevAlerts" {% if
                            settings.get('dev_telegram_paused', 'false' )=='true' %}checked{% endif %}>
                        <label class="form-check-label fw-bold text-danger" for="pauseDevAlerts">
                            <i class="fas fa-pause-circle me-1"></i>알림 일시 정지
                        </label>
                    </div>
                    <small class="text-muted ms-3">체크하면 <strong>모든</strong> 개발자 알림이 일시 정지됩니다</small>
                </div>
                <div class="d-flex align-items-center mt-3 p-2 bg-light rounded">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enableRestoreFeature" {% if
                            settings.get('enable_restore_feature', 'false' )=='true' %}checked{% endif %}>
                        <label class="form-check-label fw-bold text-success" for="enableRestoreFeature">
                            <i class="fas fa-undo me-1"></i>취소 해제 기능 활성화
                        </label>
                    </div>
                    <small class="text-muted ms-3">관리자 화면에서 취소된 예약 복원 버튼 표시</small>
                </div>
                <small class="text-muted mt-2 d-block">관리자와 별도 - 로그인 실패, 설정변경 등 감시 알림 수신</small>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-pills mb-4 gap-2" id="devTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active fw-bold rounded-pill" id="access-logs-tab" data-bs-toggle="tab"
            data-bs-target="#access-logs" type="button">
            <i class="fas fa-network-wired me-2"></i>접속 로그
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold rounded-pill" id="admin-logs-tab" data-bs-toggle="tab"
            data-bs-target="#admin-logs" type="button">
            <i class="fas fa-users-cog me-2"></i>관리자 활동
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold rounded-pill" id="error-logs-tab" data-bs-toggle="tab"
            data-bs-target="#error-logs" type="button">
            <i class="fas fa-exclamation-triangle me-2"></i>오류 로그
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold rounded-pill" id="feedback-logs-tab" data-bs-toggle="tab"
            data-bs-target="#feedback-logs" type="button">
            <i class="fas fa-comment-dots me-2"></i>피드백
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold rounded-pill" id="raw-data-tab" data-bs-toggle="tab" data-bs-target="#raw-data"
            type="button">
            <i class="fas fa-database me-2"></i>원본 데이터
        </button>
    </li>
</ul>

<div class="tab-content" id="devTabsContent">

    <!-- Access Logs -->
    <div class="tab-pane fade show active" id="access-logs" role="tabpanel">
        <div class="card shadow border-0">
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 800px;">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>시간</th>
                                <th>메소드</th>
                                <th>경로</th>
                                <th>아이피</th>
                                <th>유저 에이전트</th>
                            </tr>
                        </thead>
                        <tbody class="font-monospace small">
                            {% for log in access_logs %}
                            <tr>
                                <td class="text-nowrap">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td><span class="badge bg-secondary" style="font-family: 'Noto Sans KR', sans-serif;">{{
                                        log.method | translate_method }}</span></td>
                                <td class="text-primary">{{ log.path }}</td>
                                <td>
                                    {{ log.ip_address }}
                                    {% if log.ip_address in ip_name_map %}
                                    <span class="text-primary fw-bold ms-2"
                                        style="font-family: 'Noto Sans KR', sans-serif;">({{ ip_name_map[log.ip_address]
                                        | join(', ') }})</span>
                                    {% endif %}
                                    <span class="badge bg-light text-dark border ms-1">{{ log.user_agent | detect_device
                                        }}</span>
                                </td>
                                <td class="text-truncate" style="max-width: 300px;" title="{{ log.user_agent }}">
                                    {{ log.user_agent | simplify_ua }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Logs -->
    <div class="tab-pane fade" id="admin-logs" role="tabpanel">
        <div class="card shadow border-0">
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 800px;">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-warning bg-opacity-25 sticky-top">
                            <tr>
                                <th>시간</th>
                                <th>유형</th>
                                <th>활동 내용</th>
                                <th>아이피</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in admin_logs %}
                            <tr>
                                <td class="text-nowrap">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>
                                    {% if log.admin_type == 'dev' %}
                                    <span class="badge bg-danger rounded-pill">DEV</span>
                                    {% elif log.admin_type == 'feedback' %}
                                    <span class="badge bg-success rounded-pill">FEEDBACK</span>
                                    {% else %}
                                    <span class="badge bg-primary rounded-pill">ADMIN</span>
                                    {% endif %}
                                </td>
                                <td class="fw-bold">{{ log.action }}</td>
                                <td class="font-monospace text-muted">{{ log.ip_address }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Logs -->
    <div class="tab-pane fade" id="error-logs" role="tabpanel">
        <!-- ... existing error logs ... -->
        <div class="card shadow border-0">
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for log in error_logs %}
                    <div class="list-group-item p-4 border-bottom">
                        <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 text-danger fw-bold"><i class="fas fa-bug me-2"></i>시스템 오류</h6>
                            <small class="text-muted font-monospace">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S')
                                }}</small>
                        </div>
                        <div class="bg-light p-3 rounded mb-3 border text-break font-monospace small">
                            {{ log.error_msg }}
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#trace-{{ log.id }}">
                            <i class="fas fa-code me-1"></i>추적 기록 보기
                        </button>
                        <div class="collapse mt-3" id="trace-{{ log.id }}">
                            <div class="card card-body bg-dark text-white font-monospace small"
                                style="white-space: pre-wrap; font-size: 0.75rem;">{{ log.traceback }}</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                        <p>최근 기록된 오류가 없습니다.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Tab -->
    <div class="tab-pane fade" id="feedback-logs" role="tabpanel">
        <div class="card shadow border-0">
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% set feedback_found = false %}
                    {% set feedback_found = false %}
                    {% for log in feedback_logs %}
                    {% set feedback_found = true %}
                    <div class="list-group-item p-4 border-bottom">
                        <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 text-info fw-bold"><i class="fas fa-comment ms-1 me-2"></i>사용자 피드백
                            </h6>
                            <small class="text-muted font-monospace">{{ log.timestamp.strftime('%Y-%m-%d %H:%M')
                                }}</small>
                        </div>
                        <div class="bg-light p-3 rounded text-break">
                            {{ log.action }}
                        </div>
                        <div class="mt-2 text-end text-muted small">IP: {{ log.ip_address }}</div>
                    </div>
                    {% endfor %}

                    {% if not feedback_found %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                        <p>새로운 피드백이 없습니다.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Data -->
    <div class="tab-pane fade" id="raw-data" role="tabpanel">
        <div class="card shadow border-0">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0">예약 데이터 (원본 조회)</h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-danger" id="btnDeleteSelected">
                        <i class="fas fa-check-square me-1"></i>선택 삭제
                    </button>
                    <button class="btn btn-sm btn-danger" id="btnDeleteAll">
                        <i class="fas fa-trash-alt me-1"></i>전체 삭제
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 800px;">
                    <table class="table table-sm table-bordered mb-0 small">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="text-center" style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" id="checkAllRes">
                                </th>
                                <th>ID</th>
                                <th>상태</th>
                                <th>시작시간</th>
                                <th>종료시간</th>
                                <th>이름</th>
                                <th>전화번호</th>
                                <th>PW</th>
                                <th>생성일</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in reservations %}
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input check-res" value="{{ r.id }}">
                                </td>
                                <td>{{ r.id }}</td>
                                <td>
                                    {% if status_map %}
                                    {{ status_map.get(r.status, r.status) }}
                                    {% else %}
                                    {{ r.status }}
                                    {% endif %}
                                </td>
                                <td>{{ r.start_time }}</td>
                                <td>{{ r.end_time }}</td>
                                <td>{{ r.name }}</td>
                                <td>{{ r.phone }}</td>
                                <td><span class="badge bg-secondary">암호화됨</span></td>
                                <td>{{ r.created_at }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger btn-delete-res" data-id="{{ r.id }}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<!-- Slide to Delete Modal -->
<style>
    .slide-container {
        background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
        position: relative;
    }

    .slide-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, transparent, rgba(231, 74, 59, 0.3), rgba(231, 74, 59, 0.5));
        border-radius: 25px;
        transition: width 0.1s ease;
        z-index: 1;
    }

    .slide-track {
        color: rgba(255, 255, 255, 0.5) !important;
        font-weight: 500;
        letter-spacing: 1px;
        z-index: 2;
        animation: pulse-text 2s ease-in-out infinite;
    }

    @keyframes pulse-text {

        0%,
        100% {
            opacity: 0.4;
        }

        50% {
            opacity: 0.8;
        }
    }

    .slide-button {
        background: linear-gradient(180deg, #e74a3b 0%, #c0392b 100%);
        box-shadow: 0 4px 15px rgba(231, 74, 59, 0.4), 0 0 20px rgba(231, 74, 59, 0.2);
        transition: box-shadow 0.3s ease, transform 0.1s ease;
        z-index: 10;
    }

    .slide-button:hover {
        box-shadow: 0 4px 20px rgba(231, 74, 59, 0.6), 0 0 30px rgba(231, 74, 59, 0.4);
    }

    .slide-button.success {
        background: linear-gradient(180deg, #1cc88a 0%, #17a673 100%) !important;
        box-shadow: 0 4px 20px rgba(28, 200, 138, 0.6), 0 0 30px rgba(28, 200, 138, 0.4) !important;
    }

    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-5px);
        }

        75% {
            transform: translateX(5px);
        }
    }

    .slide-button.shake {
        animation: shake 0.5s ease;
    }
</style>
<div class="modal fade" id="slideDeleteModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);">
            <div class="modal-header border-0" style="background: linear-gradient(90deg, #e74a3b 0%, #c0392b 100%);">
                <h5 class="modal-title fw-bold text-white"><i class="fas fa-exclamation-triangle me-2"></i>⚠️ 전체 삭제 확인
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-database fa-3x text-danger mb-3" style="opacity: 0.8;"></i>
                    <p class="fw-bold text-danger fs-5 mb-2">⚠️ 모든 예약 데이터가 영구 삭제됩니다!</p>
                    <p class="text-white-50 mb-0">이 작업은 되돌릴 수 없습니다.</p>
                </div>

                <div class="slide-container mx-auto"
                    style="width: 300px; height: 56px; border-radius: 28px; overflow: hidden;">
                    <div class="slide-track d-flex align-items-center justify-content-center h-100 position-relative">
                        <i class="fas fa-chevron-right me-2"></i>밀어서 삭제<i class="fas fa-chevron-right ms-2"></i>
                    </div>
                    <div id="slideButton"
                        class="slide-button position-absolute d-flex align-items-center justify-content-center text-white"
                        style="width: 70px; height: 52px; top: 2px; left: 2px; border-radius: 26px; cursor: grab; user-select: none;">
                        <i class="fas fa-trash-alt fa-lg"></i>
                    </div>
                </div>
                <div id="slideProgress" class="text-white-50 small mt-3" style="opacity: 0;">0%</div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-light px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>취소
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Maintenance Toggle
    const mSwitch = document.getElementById('maintenanceSwitch');
    const mLabel = document.getElementById('maintenanceLabel');

    if (mSwitch) {
        mSwitch.addEventListener('change', function () {
            const isChecked = this.checked;
            fetch('/dev/toggle_maintenance', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (data.mode === 'true') {
                            mLabel.innerText = "활성";
                            mLabel.closest('.card-body').querySelector('.rounded-circle').className = "rounded-circle p-3 bg-danger bg-opacity-10 text-danger";
                            showAlert('유지보수 모드가 활성화되었습니다.');
                        } else {
                            mLabel.innerText = "비활성";
                            mLabel.closest('.card-body').querySelector('.rounded-circle').className = "rounded-circle p-3 bg-success bg-opacity-10 text-success";
                            showAlert('유지보수 모드가 비활성화되었습니다.');
                        }
                    } else {
                        mSwitch.checked = !isChecked; // Revert
                        showAlert('상태 변경 실패');
                    }
                })
                .catch(() => {
                    mSwitch.checked = !isChecked;
                    showAlert('서버 통신 오류');
                });
        });
    }

    // Telegram Masking Toggle
    const maskSwitch = document.getElementById('maskingSwitch');
    const maskLabel = document.getElementById('maskingLabel');

    if (maskSwitch) {
        maskSwitch.addEventListener('change', function () {
            const isChecked = this.checked;
            fetch('/dev/toggle_masking', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (data.enabled === 'true') {
                            maskLabel.innerText = "활성";
                            showAlert('텔레그램 개인정보 마스킹이 활성화되었습니다.');
                        } else {
                            maskLabel.innerText = "해제";
                            showAlert('텔레그램 개인정보 마스킹이 해제되었습니다.');
                        }
                    } else {
                        maskSwitch.checked = !isChecked;
                        showAlert('상태 변경 실패');
                    }
                })
                .catch(() => {
                    maskSwitch.checked = !isChecked;
                    showAlert('서버 통신 오류');
                });
        });
    }

    // Integrity Check
    const btnCheck = document.getElementById('btnIntegrityCheck');
    const btnFix = document.getElementById('btnIntegrityFix');
    const resultBox = document.getElementById('integrityResult');

    if (btnCheck) {
        btnCheck.addEventListener('click', function () {
            btnCheck.disabled = true;
            btnCheck.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>검사 중...';

            fetch('/dev/integrity_check', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    btnCheck.disabled = false;
                    btnCheck.innerHTML = '<i class="fas fa-search me-1"></i>검사 실행';

                    if (data.success) {
                        if (data.issues_count > 0) {
                            resultBox.className = "alert alert-danger mb-0 small";
                            let html = `<strong><i class="fas fa-exclamation-circle me-1"></i>${data.issues_count}건의 문제 발견:</strong><ul class="mb-0 ps-3 mt-1">`;
                            data.report.forEach(line => html += `<li>${line}</li>`);
                            html += `</ul>`;
                            resultBox.innerHTML = html;
                            btnFix.classList.remove('d-none');
                        } else {
                            resultBox.className = "alert alert-success mb-0 small";
                            resultBox.innerHTML = '<strong><i class="fas fa-check-circle me-1"></i>시스템 정상</strong><br>무결성 문제가 발견되지 않았습니다.';
                            btnFix.classList.add('d-none');
                        }
                    }
                })
                .catch(err => {
                    btnCheck.disabled = false;
                    btnCheck.innerHTML = '<i class="fas fa-search me-1"></i>검사 실행';
                    showAlert('검사 중 오류 발생');
                });
        });
    }

    // Integrity Fix
    if (btnFix) {
        btnFix.addEventListener('click', function () {
            if (!confirm('발견된 문제를 자동으로 수정하시겠습니까?\n(과거 예약 -> 종료 상태로 변경)')) return;

            btnFix.disabled = true;
            fetch('/dev/integrity_fix', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    btnFix.disabled = false;
                    if (data.success) {
                        showAlert(`${data.fixed_count}건이 수정되었습니다.`, function () {
                            if (btnCheck) btnCheck.click(); // Re-run check
                        });
                    }
                });
        });
    }

    // DB Restore Logic
    const btnRestoreDb = document.getElementById('btnRestoreDb');
    const dbRestoreFile = document.getElementById('dbRestoreFile');

    if (btnRestoreDb && dbRestoreFile) {
        btnRestoreDb.addEventListener('click', function () {
            dbRestoreFile.click();
        });

        dbRestoreFile.addEventListener('change', function () {
            if (!this.files || !this.files[0]) return;

            const file = this.files[0];
            if (!confirm(`"${file.name}" 파일로 데이터베이스를 복원하시겠습니까?\n\n⚠️ 경고: 현재 데이터가 모두 덮어써집니다!`)) {
                this.value = '';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            btnRestoreDb.disabled = true;
            btnRestoreDb.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>복원 중...';

            fetch('/dev/restore_db', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    btnRestoreDb.disabled = false;
                    btnRestoreDb.innerHTML = '<i class="fas fa-upload me-1"></i>DB 복원';
                    this.value = '';

                    if (data.success) {
                        showAlert('데이터베이스가 복원되었습니다. 페이지를 새로고침합니다.', () => location.reload());
                    } else {
                        showAlert('복원 실패: ' + data.error);
                    }
                })
                .catch(() => {
                    btnRestoreDb.disabled = false;
                    btnRestoreDb.innerHTML = '<i class="fas fa-upload me-1"></i>DB 복원';
                    this.value = '';
                    showAlert('서버 통신 오류');
                });
        });
    }

    // Cleanup Logic
    const btnCleanup = document.getElementById('btnCleanup');
    if (btnCleanup) {
        btnCleanup.addEventListener('click', function () {
            if (!confirm('보존 기간(1년)이 지난 개인정보를 파기하시겠습니까?\n(이름/전화번호 등은 삭제되고 통계용 이력만 남습니다.)')) return;

            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>정리 중...';

            fetch('/dev/cleanup', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-trash-restore me-1"></i>오래된 개인정보 파기';

                    if (data.success) {
                        showAlert(`개인정보 파기가 완료되었습니다.\n- 익명화된 예약: ${data.deleted_count}건\n- 삭제된 로그: ${data.deleted_logs}건`);
                    } else {
                        showAlert('정리 실패: ' + data.error);
                    }
                })
                .catch(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-trash-restore me-1"></i>오래된 개인정보 파기';
                    showAlert('서버 통신 오류');
                });
        });
    }

    // Reservation Delete (Event Delegation)
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-delete-res');
        if (!btn) return;

        const id = btn.getAttribute('data-id');
        if (!confirm(`정말 예약 ID ${id}번을 영구 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`)) return;

        // Use closest to find the row to remove
        const row = btn.closest('tr');

        fetch(`/dev/reservations/${id}/delete`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (row) row.remove();
                    showAlert('삭제되었습니다.');
                } else {
                    showAlert('삭제 실패: ' + (data.error || 'Unknown'));
                }
            })
            .catch(err => showAlert('서버 통신 오류'));
    });

    // --- Bulk Delete Logic ---
    const checkAll = document.getElementById('checkAllRes');
    const btnDelSelected = document.getElementById('btnDeleteSelected');
    const btnDelAll = document.getElementById('btnDeleteAll');

    // Select All Toggle
    if (checkAll) {
        checkAll.addEventListener('change', function () {
            const checkboxes = document.querySelectorAll('.check-res');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });
    }

    // Delete Selected
    if (btnDelSelected) {
        btnDelSelected.addEventListener('click', function () {
            const checked = document.querySelectorAll('.check-res:checked');
            if (checked.length === 0) {
                showAlert('삭제할 항목을 선택해주세요.');
                return;
            }

            if (!confirm(`선택한 ${checked.length}개의 예약을 삭제하시겠습니까?\n복구할 수 없습니다.`)) return;

            const ids = Array.from(checked).map(cb => parseInt(cb.value));

            fetch('/dev/reservations/delete_bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: 'selected', ids: ids })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showAlert(`${data.count}건 삭제 완료.`, () => location.reload());
                    } else {
                        showAlert('삭제 실패: ' + data.error);
                    }
                })
                .catch(err => showAlert('서버 통신 오류'));
        });
    }

    // Delete All - Show Slide Modal
    const slideDeleteModal = document.getElementById('slideDeleteModal');
    const slideButton = document.getElementById('slideButton');
    let slideModal = null;

    if (btnDelAll && slideDeleteModal) {
        slideModal = new bootstrap.Modal(slideDeleteModal);
        btnDelAll.addEventListener('click', function () {
            slideModal.show();
        });
    }

    // Slide to Delete Logic
    if (slideButton) {
        let isDragging = false;
        let startX = 0;
        let currentX = 0;
        const maxSlide = 226; // 300 - 70 - 4
        const slideContainer = document.querySelector('.slide-container');
        const slideProgress = document.getElementById('slideProgress');

        function resetSlider() {
            slideButton.style.left = '2px';
            slideButton.classList.remove('success');
            slideButton.classList.add('shake');
            if (slideContainer) slideContainer.style.setProperty('--progress', '0%');
            if (slideProgress) {
                slideProgress.style.opacity = '0';
                slideProgress.textContent = '0%';
            }
            setTimeout(() => slideButton.classList.remove('shake'), 500);
        }

        function updateProgress(x) {
            const percent = Math.round((x / maxSlide) * 100);
            if (slideProgress) {
                slideProgress.style.opacity = '1';
                slideProgress.textContent = percent + '%';
                slideProgress.style.color = percent >= 90 ? '#1cc88a' : 'rgba(255,255,255,0.5)';
            }
            if (slideContainer) {
                slideContainer.style.setProperty('--progress', percent + '%');
                slideContainer.querySelector('::before')?.style?.setProperty('width', percent + '%');
            }
        }

        slideButton.addEventListener('mousedown', function (e) {
            isDragging = true;
            startX = e.clientX - slideButton.offsetLeft;
            slideButton.style.cursor = 'grabbing';
        });

        slideButton.addEventListener('touchstart', function (e) {
            isDragging = true;
            startX = e.touches[0].clientX - slideButton.offsetLeft;
        });

        document.addEventListener('mousemove', function (e) {
            if (!isDragging) return;
            currentX = Math.min(Math.max(2, e.clientX - startX), maxSlide);
            slideButton.style.left = currentX + 'px';
            updateProgress(currentX);

            // Change to success when near end
            if (currentX > maxSlide * 0.8) {
                slideButton.classList.add('success');
            } else {
                slideButton.classList.remove('success');
            }
        });

        document.addEventListener('touchmove', function (e) {
            if (!isDragging) return;
            currentX = Math.min(Math.max(2, e.touches[0].clientX - startX), maxSlide);
            slideButton.style.left = currentX + 'px';
            updateProgress(currentX);

            if (currentX > maxSlide * 0.8) {
                slideButton.classList.add('success');
            } else {
                slideButton.classList.remove('success');
            }
        });

        document.addEventListener('mouseup', function () {
            if (!isDragging) return;
            isDragging = false;
            slideButton.style.cursor = 'grab';

            if (currentX >= maxSlide * 0.9) {
                // Execute delete
                slideButton.innerHTML = '<i class="fas fa-check fa-lg"></i>';
                setTimeout(() => {
                    if (slideModal) slideModal.hide();
                    // 최종 확인
                    if (confirm('⚠️ 정말로 모든 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다!')) {
                        executeDeleteAll();
                    } else {
                        slideButton.innerHTML = '<i class="fas fa-trash-alt fa-lg"></i>';
                        resetSlider();
                    }
                }, 300);
            } else {
                resetSlider();
            }
            currentX = 0;
        });

        document.addEventListener('touchend', function () {
            if (!isDragging) return;
            isDragging = false;

            if (currentX >= maxSlide * 0.9) {
                slideButton.innerHTML = '<i class="fas fa-check fa-lg"></i>';
                setTimeout(() => {
                    if (slideModal) slideModal.hide();
                    // 최종 확인
                    if (confirm('⚠️ 정말로 모든 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다!')) {
                        executeDeleteAll();
                    } else {
                        slideButton.innerHTML = '<i class="fas fa-trash-alt fa-lg"></i>';
                        resetSlider();
                    }
                }, 300);
            } else {
                resetSlider();
            }
            currentX = 0;
        });


        // Reset on modal close
        slideDeleteModal.addEventListener('hidden.bs.modal', resetSlider);
    }

    function executeDeleteAll() {
        fetch('/dev/reservations/delete_bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'all' })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert('모든 데이터가 삭제되었습니다.', () => location.reload());
                } else {
                    showAlert('삭제 실패: ' + data.error);
                }
            })
            .catch(err => showAlert('서버 통신 오류'));
    }

    // Copy Admin Password
    const btnCopyAdminPw = document.getElementById('btnCopyAdminPw');
    if (btnCopyAdminPw) {
        btnCopyAdminPw.addEventListener('click', function () {
            const pwInput = document.getElementById('adminPwDisplay');
            navigator.clipboard.writeText(pwInput.value).then(() => {
                this.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-copy"></i>';
                }, 1500);
            });
        });
    }

    // Save Dev Telegram Settings
    const btnSaveDevTelegram = document.getElementById('btnSaveDevTelegram');
    if (btnSaveDevTelegram) {
        btnSaveDevTelegram.addEventListener('click', function () {
            const token = document.getElementById('devTelegramToken').value;
            const chatId = document.getElementById('devTelegramChatId').value;

            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>저장 중...';

            fetch('/dev/save_telegram', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token, chat_id: chatId })
            })
                .then(res => res.json())
                .then(data => {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-save me-1"></i>저장';
                    if (data.success) {
                        showAlert('개발자 텔레그램 설정이 저장되었습니다.\n테스트 메시지를 확인해주세요.');
                    } else {
                        showAlert('저장 실패: ' + data.error);
                    }
                })
                .catch(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-save me-1"></i>저장';
                    showAlert('서버 통신 오류');
                });
        });
    }

    // Pause toggle handler
    const pauseToggle = document.getElementById('pauseDevAlerts');
    if (pauseToggle) {
        pauseToggle.addEventListener('change', function () {
            const paused = this.checked;
            fetch('/dev/toggle_pause_alerts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paused: paused })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showAlert(paused ? '알림이 일시 정지되었습니다.' : '알림이 재개되었습니다.');
                    }
                })
                .catch(() => showAlert('설정 저장 실패'));
        });
    }

    // Restore feature toggle handler
    const restoreToggle = document.getElementById('enableRestoreFeature');
    if (restoreToggle) {
        restoreToggle.addEventListener('change', function () {
            const enabled = this.checked;
            fetch('/dev/toggle_restore_feature', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showAlert(enabled ? '취소 해제 기능이 활성화되었습니다.' : '취소 해제 기능이 비활성화되었습니다.');
                    }
                })
                .catch(() => showAlert('설정 저장 실패'));
        });
    }
</script>
{% endblock %}