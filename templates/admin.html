{% extends "base.html" %}

{% block content %}
<div class="row align-items-center mb-4">
    <div class="col">
        <h2 class="fw-bold"><i class="fas fa-cogs me-2"></i>관리자 대시보드</h2>
    </div>
    <div class="col-auto">
        <button class="btn btn-outline-dark me-2" data-bs-toggle="modal" data-bs-target="#passwordModal">
            <i class="fas fa-key me-1"></i>비밀번호 변경
        </button>
        <a href="/logout" class="btn btn-outline-danger">로그아웃</a>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active fw-bold text-primary" id="reservations-tab" data-bs-toggle="tab"
            data-bs-target="#reservations" type="button"><i class="fas fa-calendar-check me-1"></i>예약 관리</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold text-secondary" id="settings-tab" data-bs-toggle="tab"
            data-bs-target="#settings" type="button"><i class="fas fa-cog me-1"></i>환경 설정</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold text-info" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback"
            type="button"><i class="fas fa-comments me-1"></i>사용자 피드백</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold text-dark" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup"
            type="button">
            <i class="fas fa-database me-1"></i>백업 및 관리</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold text-danger" id="block-tab" data-bs-toggle="tab" data-bs-target="#block"
            type="button"><i class="fas fa-user-slash me-1"></i>차단 관리</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold text-success" id="email-tab" data-bs-toggle="tab" data-bs-target="#email"
            type="button"><i class="fas fa-envelope me-1"></i>이메일 설정</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold text-warning" id="notification-tab" data-bs-toggle="tab"
            data-bs-target="#notification" type="button"><i class="fas fa-bell me-1"></i>알림 설정</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold text-secondary" id="terms-tab" data-bs-toggle="tab" data-bs-target="#terms"
            type="button"><i class="fas fa-file-alt me-1"></i>약관 관리</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold text-primary" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats"
            type="button"><i class="fas fa-chart-pie me-1"></i>통계</button>
    </li>
</ul>

<div class="tab-content" id="adminTabsContent">
    <!-- Reservations Tab -->
    <div class="tab-pane fade show active" id="reservations" role="tabpanel">
        <div class="card shadow">
            <div
                class="card-header bg-white py-3 d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                <h5 class="mb-0 fw-bold">예약 목록</h5>
                <div class="d-flex gap-2">
                    <div class="btn-group">
                        <button class="btn btn-outline-dark btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-file-pdf me-1"></i>신청서 모음 전송
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showBulkReportModal('week')">지난 1주 (주간)</a>
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="showBulkReportModal('half')">지난 15일 (보름)</a>
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="showBulkReportModal('month')">지난 30일 (월간)</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="showBulkReportModal('custom')">🔍 현재 검색 결과
                                    보내기</a></li>
                        </ul>
                    </div>
                    <a href="#" onclick="downloadExcelWithFilters(); return false;" class="btn btn-success btn-sm"><i
                            class="fas fa-file-excel me-1"></i> 엑셀</a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="p-3 border-bottom bg-light">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted mb-1"><i
                                    class="far fa-calendar-alt me-1"></i>날짜 조회</label>
                            <input type="text" id="filterDate" class="form-control form-control-sm bg-white"
                                placeholder="모든 날짜 보기">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted mb-1"><i class="fas fa-filter me-1"></i>상태
                                필터</label>
                            <select id="filterStatus" class="form-select form-select-sm">
                                <option value="">전체 보기</option>
                                <option value="reserved">예약중</option>
                                <option value="checked_in">이용중</option>
                                <option value="ended">종료됨</option>
                                <option value="cancelled">취소됨</option>
                                <option value="noshow_blocked">노쇼/차단</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted mb-1"><i class="fas fa-search me-1"></i>빠른
                                검색</label>
                            <input type="text" id="filterSearch" class="form-control form-control-sm"
                                list="reservationOptions" placeholder="이름, 전화번호, 상태(예약/취소/종료)">
                            <datalist id="reservationOptions"></datalist>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-secondary btn-sm w-100" onclick="resetFilters()">
                                <i class="fas fa-undo me-1"></i>초기화
                            </button>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="reservationTable">
                        <thead class="table-light">
                            <tr>
                                <th>상태</th>
                                <th>시간</th>
                                <th>예약자</th>
                                <th>사용 목적</th>
                                <!-- Removed Address Column -->
                                <th>메모</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in reservations %}
                            <tr class="reservation-row" data-date="{{ r.start_time.strftime('%Y-%m-%d') }}"
                                data-name="{{ r.name }}" data-phone="{{ r.phone }}"
                                data-status="{% if r.status == 'noshow_penalty' or r.phone in blocked_phones %}noshow_blocked{% else %}{{ r.status }}{% endif %}"
                                data-search="{{ r.name }} {{ r.phone }} {% if r.status == 'reserved' %}예약중 예약됨{% elif r.status == 'checked_in' %}체크인 이용중 입실완료{% elif r.status == 'ended' %}종료 이용완료{% elif r.status == 'cancelled' %}취소 취소됨{% elif r.status == 'noshow_penalty' %}노쇼 차단{% endif %} {% if r.phone in blocked_phones %}노쇼 차단 차단됨{% endif %}">
                                <td>
                                    {% if r.status == 'reserved' %}<span class="badge bg-primary">예약중</span>
                                    {% elif r.status == 'checked_in' %}<span class="badge bg-success">체크인</span>
                                    {% elif r.status == 'ended' %}<span class="badge bg-secondary">종료</span>
                                    {% elif r.status == 'cancelled' %}<span class="badge bg-warning text-dark">취소</span>
                                    {% elif r.status == 'noshow_penalty' %}<span class="badge bg-danger">노쇼</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if r.start_time.date() != r.end_time.date() %}
                                    <div class="fw-bold">{{ r.start_time.strftime('%Y-%m-%d') }} ~ {{
                                        r.end_time.strftime('%Y-%m-%d') }}</div>
                                    <small class="text-muted">{{ r.start_time.strftime('%H:%M') }} ~ {{
                                        r.end_time.strftime('%H:%M') }}</small>
                                    {% else %}
                                    <div class="fw-bold">{{ r.start_time.strftime('%Y-%m-%d') }}</div>
                                    <small class="text-muted">{{ r.start_time.strftime('%H:%M') }} ~ {{
                                        r.end_time.strftime('%H:%M') }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ r.name }}<br>
                                    <small class="text-muted">{{ r.phone }}</small>
                                    {% if r.phone in blocked_phones %}
                                    <span class="badge bg-danger ms-1">차단됨</span>
                                    {% endif %}
                                </td>
                                <td>{{ r.purpose }}</td>
                                <!-- Removed Address Data -->
                                <td>
                                    <div class="input-group input-group-sm" style="width: 280px;">
                                        <input type="text" class="form-control memo-input"
                                            value="{{ r.admin_memo or '' }}" id="memo-{{ r.id }}" placeholder="메모 입력" {%
                                            if r.status=='cancelled' %}disabled{% endif %}>
                                        <button class="btn btn-outline-secondary" onclick="saveMemo({{ r.id }})" {% if
                                            r.status=='cancelled' %}disabled{% endif %}><i
                                                class="fas fa-save"></i></button>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary"
                                        onclick="adminPreviewPdf({{ r.id }})" title="미리보기">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary"
                                        onclick="sendOfficialPdf({{ r.id }}, '{{ r.name }}')" title="담당자(군청) 전송">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                    {% if r.status == 'reserved' %}
                                    <button class="btn btn-sm btn-warning text-dark"
                                        onclick="openCancelModal({{ r.id }}, '{{ r.name }}')" title="예약취소">
                                        취소
                                    </button>
                                    {% elif r.status == 'cancelled' and enable_restore_feature %}
                                    <button class="btn btn-sm btn-outline-success"
                                        onclick="restoreReservation({{ r.id }}, '{{ r.name }}')" title="취소 해제">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    {% endif %}
                                    {% if r.phone in blocked_phones %}
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        차단중
                                    </button>
                                    {% else %}
                                    <button class="btn btn-sm btn-outline-danger"
                                        onclick="blockUser('{{ r.phone }}', '{{ r.name }}')">
                                        차단
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Tab -->
    <div class="tab-pane fade" id="stats" role="tabpanel">
        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-sm btn-outline-primary" onclick="forceReloadStats()">
                <i class="fas fa-sync-alt me-1"></i>데이터 새로고침
            </button>
        </div>
        <div class="row g-4">
            <!-- Pie Chart: Status -->
            <div class="col-md-5">
                <div class="card shadow h-100">
                    <div class="card-header bg-white fw-bold">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>예약 상태 비율
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- Bar Chart: Weekly -->
            <div class="col-md-7">
                <div class="card shadow h-100">
                    <div class="card-header bg-white fw-bold">
                        <i class="fas fa-calendar-week me-2 text-success"></i>요일별 이용 추이 (최근 전체)
                    </div>
                    <div class="card-body">
                        <canvas id="weeklyChart" style="min-height: 320px;"></canvas>
                    </div>
                </div>
            </div>
            <!-- Line Chart: Hourly -->
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-white fw-bold">
                        <i class="fas fa-clock me-2 text-warning"></i>시간대별 이용 분포 (Peak Hours)
                    </div>
                    <div class="card-body">
                        <canvas id="hourlyChart" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <!-- Reservation Control Card -->
        <div class="card shadow border-danger mb-4" style="max-width: 800px; margin: 0 auto;">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0 fw-bold"><i class="fas fa-hand-paper me-2"></i>예약 기능 제어 (비상)</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <h6 class="fw-bold mb-1">예약 일시 중지</h6>
                        <p class="text-muted small mb-0">활성화 시 모든 신규 예약이 차단되며, 설정한 사유가 공지사항에 표시됩니다.</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="pauseSwitch" style="transform: scale(1.5);"
                            {% if settings.reservation_paused %}checked{% endif %}>
                    </div>
                </div>
                <div class="collapse {% if settings.reservation_paused %}show{% endif %}" id="pauseReasonArea">
                    <div class="alert alert-warning border-0 mb-3">
                        <label class="form-label fw-bold">중지 범위 선택</label>
                        <div class="d-flex gap-3 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pauseMode" id="pauseAll" value="all"
                                    {% if not settings.pause_mode or settings.pause_mode=='all' %}checked{% endif %}>
                                <label class="form-check-label" for="pauseAll">전체 중지 (지금부터 계속)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pauseMode" id="pausePartial"
                                    value="partial" {% if settings.pause_mode=='partial' %}checked{% endif %}>
                                <label class="form-check-label" for="pausePartial">특정 기간 중지</label>
                            </div>
                        </div>

                        <div id="dateRangeArea"
                            class="mb-3 {% if settings.pause_mode != 'partial' %}d-none{% endif %} bg-white p-2 rounded">
                            <label class="form-label small text-muted">중지 기간 설정 (최대 10개)</label>
                            <div id="rangesContainer">
                                <!-- Dynamic Inputs will be added here -->
                            </div>
                            <button class="btn btn-sm btn-outline-secondary w-100 mt-2" id="addRangeBtn">
                                <i class="fas fa-plus me-1"></i>기간 추가하기
                            </button>
                        </div>

                        <label class="form-label fw-bold">중지 사유 (공지 표시)</label>
                        <input type="text" class="form-control" id="pauseReason" placeholder="예: 내부 리모델링 공사"
                            value="{{ settings.pause_reason or '' }}">
                    </div>
                    <div class="text-end mt-2">
                        <button class="btn btn-sm btn-danger" id="btnApplyPause">설정 적용</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow" style="max-width: 800px; margin: 0 auto;">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-4">공지 및 시설 정보 설정</h5>
                <form id="settingsForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">메인 화면 공지사항</label>
                        <input type="text" class="form-control" id="setNotice" value="{{ settings.notice_text }}">
                        <div class="form-text">메인 캘린더 상단에 표시됩니다.</div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Wi-Fi 정보</label>
                        <input type="text" class="form-control" id="setWifi" value="{{ settings.wifi_info }}">
                        <div class="form-text">예약자에게만 표시됩니다. (예: ID / PW)</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">출입문 비밀번호</label>
                        <input type="text" class="form-control" id="setDoor" value="{{ settings.door_pw }}">
                        <div class="form-text">예약자에게만 표시됩니다.</div>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="button" class="btn btn-primary btn-lg" id="btnSaveSettings">설정 저장</button>
                    </div>
                </form>

                <hr class="my-5">

                <h5 class="fw-bold mb-4">통합 체크인 QR 코드</h5>
                <div class="text-center bg-light p-4 rounded-3 border">
                    <p class="mb-3 text-muted">
                        이 코드를 인쇄하여 도서관 입구에 부착하세요.<br>
                        <strong>페이지 접속</strong>과 <strong>입실 인증</strong>이 모두 가능한 통합 QR입니다.
                    </p>
                    <div class="bg-white p-3 d-inline-block shadow-sm rounded mb-3">
                        <img src="/admin/qr_code" alt="Check-in QR Code" class="img-fluid" style="max-width: 200px;">
                    </div>
                    <div>
                        <a href="/admin/download_qr_poster" class="btn btn-primary">
                            <i class="fas fa-print me-1"></i>통합 포스터 다운로드 (A4)
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="feedback" role="tabpanel">
        <div class="card shadow">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold"><i class="fas fa-comment-dots me-2 text-info"></i>사용자 피드백 목록</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% if feedbacks %}
                    {% for f in feedbacks %}
                    <div class="list-group-item p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="text-break me-3">{{ f.action }}</div>
                            <small class="text-muted text-nowrap">{{ f.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                        <p>새로운 피드백이 없습니다.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Tab -->
    <div class="tab-pane fade" id="backup" role="tabpanel">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow text-center p-5">
                    <div class="mb-3">
                        <i class="fas fa-database fa-4x text-primary"></i>
                    </div>
                    <h4 class="fw-bold">데이터베이스 백업</h4>
                    <p class="text-muted mb-4">현재까지의 모든 예약 데이터와 설정을 파일로 안전하게 저장합니다.</p>
                    <!-- Backup Tab (Restored) -->
                    <a href="/admin/backup" class="btn btn-dark btn-lg">
                        <i class="fas fa-download me-2"></i>DB 파일 다운로드 (.sqlite)
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="notification" role="tabpanel">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold text-primary"><i class="fab fa-telegram-plane me-2"></i>텔레그램 알림 설정</h5>
                    </div>
                    <div class="card-body">

                        <!-- Beginner Guide Accordion -->
                        <div class="accordion mb-4 shadow-sm" id="telegramGuide">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingGuide">
                                    <button class="accordion-button collapsed fw-bold" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseGuide">
                                        🚀 텔레그램 알림 봇 만들기 (초보자 가이드) - 여기를 눌러보세요!
                                    </button>
                                </h2>
                                <div id="collapseGuide" class="accordion-collapse collapse"
                                    data-bs-parent="#telegramGuide">
                                    <div class="accordion-body bg-light">
                                        <h6 class="fw-bold mb-3">1단계: 텔레그램 봇 만들기</h6>
                                        <ol class="small mb-4" style="line-height: 1.8;">
                                            <li>텔레그램 앱 실행 후 상단 돋보기 <i class="fas fa-search"></i> 아이콘을 누르세요.</li>
                                            <li>검색창에 <code>@BotFather</code>를 입력하고, 파란색 인증 마크(<i
                                                    class="fas fa-check-circle text-primary"></i>)가 있는 공식 계정을 선택하세요.
                                            </li>
                                            <li>채팅방에 들어가서 하단의 <span class="badge bg-secondary">시작(Start)</span> 버튼을
                                                <strong>꼭</strong> 누르세요.
                                            </li>
                                            <li>채팅창에 <code>/newbot</code> 이라고 입력하고 전송하세요.</li>
                                            <li>"이름을 지어달라"고 하면 한글로 편하게 입력하세요 (예: <code>지혜마루 알림</code>).</li>
                                            <li>"아이디(Username)를 지어달라"고 하면 영어로 입력하되, 반드시 끝이 <code>bot</code>으로 끝나야 합니다
                                                (예: <code>jihyemaru_alarm_bot</code>).</li>
                                            <li>성공하면 긴 <strong>API Token</strong>이 나옵니다. 이걸 복사해서 아래 <strong>[봇
                                                    토큰]</strong> 칸에 붙여넣으세요.</li>
                                        </ol>

                                        <h6 class="fw-bold mb-3">2단계: 내 아이디(Chat ID) 알아내기 <span
                                                class="text-danger">(중요!)</span></h6>
                                        <ol class="small mb-0" style="line-height: 1.8;">
                                            <li>방금 만든 내 봇을 검색해서 채팅방에 들어갑니다.</li>
                                            <li><span class="badge bg-success">시작</span> 버튼을 누르고, <code>안녕</code> 이라고
                                                메시지를 하나 보내세요. (메시지를 안 보내면 아이디를 못 찾습니다)</li>
                                            <li>인터넷 브라우저 새 창을 열고 주소창에 다음을 입력하세요:<br>
                                                <code>https://api.telegram.org/bot[토큰]/getUpdates</code><br>
                                                <span class="text-muted" style="font-size: 0.85em;">(※
                                                    <strong>[토큰]</strong> 자리에 아까 복사한 긴 토큰을 붙여넣으세요)</span>
                                            </li>
                                            <li>화면에 복잡한 글자들이 나오면 <code>"chat":{"id":12345...</code> 부분을 찾으세요. 그 옆의 숫자가
                                                본인의 <strong>Chat ID</strong>입니다.</li>
                                            <li>그 숫자를 아래 <strong>[채팅방 ID]</strong> 칸에 붙여넣으세요.</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            <!-- Handover Guide -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingHandover">
                                    <button class="accordion-button collapsed fw-bold text-dark" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseHandover">
                                        👨‍🏫 관리자가 바뀔 때는 어떻게 하나요? (인수인계 방법)
                                    </button>
                                </h2>
                                <div id="collapseHandover" class="accordion-collapse collapse"
                                    data-bs-parent="#telegramGuide">
                                    <div class="accordion-body bg-white">
                                        <p class="small text-muted mb-3">관리자가 변경되어 알림을 받을 사람이 달라질 때 참고하세요.</p>

                                        <h6 class="fw-bold text-primary mb-2">방법 1. 단체 채팅방 사용하기 (추천 👍)</h6>
                                        <ul class="small mb-3 text-muted">
                                            <li>텔레그램에서 <strong>단체방</strong>을 만들고, 봇과 관리자들을 모두 초대하세요.</li>
                                            <li>단체방의 Chat ID를 한 번만 등록해두면, 관리자가 바뀌어도 설정 변경 없이 <strong>초대/나가기</strong>만 하면
                                                됩니다.</li>
                                        </ul>

                                        <h6 class="fw-bold text-success mb-2">방법 2. 설정만 바꾸기</h6>
                                        <ul class="small mb-0 text-muted">
                                            <li>새 관리자가 본인의 텔레그램 Chat ID를 알아냅니다 (위 가이드 2단계 참고).</li>
                                            <li>이 화면에서 <strong>[채팅방 ID]</strong> 칸의 숫자만 새 관리자의 것으로 바꿔서
                                                <strong>저장</strong>하세요.
                                            </li>
                                            <li>(봇 토큰은 바꿀 필요가 없습니다)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Config Form -->
                    <div class="card-body border-top p-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">봇 토큰 (Bot Token)</label>
                            <input type="text" class="form-control" id="telegramToken"
                                placeholder="123456789:ABCdefGHIjkl..." value="{{ settings.telegram_token }}">
                            <div class="form-text">BotFather에게 발급받은 API Token을 입력하세요.</div>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="telegramChatId" placeholder="123456789"
                                value="{{ settings.telegram_chat_id }}">
                            <div class="form-text">알림을 받을 채팅방의 숫자 ID입니다.</div>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-info" id="btnTestTelegram">
                                <i class="fas fa-paper-plane me-1"></i>테스트 발송
                            </button>
                            <button class="btn btn-primary px-4" id="btnSaveTelegram">
                                <i class="fas fa-save me-1"></i>저장
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Tab -->
    <div class="tab-pane fade" id="email" role="tabpanel">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold text-success"><i class="fas fa-envelope me-2"></i>이메일 전송 설정
                            (담당자
                            보고용)
                        </h5>
                    </div>
                    <div class="card-body">

                        <!-- SMTP Guide -->
                        <div class="accordion mb-4 shadow-sm" id="smtpGuide">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingSmtp">
                                    <button class="accordion-button collapsed fw-bold" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseSmtp">
                                        📧 네이버/지메일 연동 가이드 (필독!)
                                    </button>
                                </h2>
                                <div id="collapseSmtp" class="accordion-collapse collapse" data-bs-parent="#smtpGuide">
                                    <div class="accordion-body bg-light">
                                        <div class="alert alert-info border-0 mb-3 small">
                                            <i class="fas fa-shield-alt me-2"></i><strong>보안 및 안정성
                                                팁</strong><br>
                                            입력하신 비밀번호는 서버에 저장되지만, 만약의 경우를 대비하여 <strong>개인 주계정(본인 메일)보다는 알림
                                                전용
                                                부계정</strong>(예: <code>library_alarm@gmail.com</code>)을 새로 하나
                                            만드시는 것을 강력
                                            추천합니다.<br>
                                            전용 계정을 쓰면 개인정보 유출 걱정 없이 훨씬 안전하고 안정적으로 전송할 수 있습니다.
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 border-end">
                                                <h6 class="fw-bold text-success"><i class="fas fa-check me-1"></i>네이버 메일
                                                    (Naver)</h6>
                                                <ol class="small mb-0" style="line-height: 1.6;">
                                                    <li>네이버 메일 접속 -> 하단 [환경설정] 클릭</li>
                                                    <li>[POP3/IMAP 설정] 메뉴 -> [SMTP 사용함] 선택</li>
                                                    <li><strong>SMTP 서버명</strong>:
                                                        <code>smtp.naver.com</code>
                                                    </li>
                                                    <li><strong>SMTP 포트</strong>: <code>587</code></li>
                                                    <li><strong>아이디</strong>: 네이버 아이디 (aaa@naver.com)</li>
                                                    <li><strong>비밀번호</strong>: 네이버 로그인 비밀번호<br>
                                                        <span class="text-muted">(※ 2단계 인증 사용중이면 '애플리케이션
                                                            비밀번호'를
                                                            생성해서
                                                            입력해야 합니다)</span>
                                                    </li>
                                                </ol>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="fw-bold text-danger"><i class="fas fa-check me-1"></i>구글 지메일
                                                    (Gmail)</h6>
                                                <ol class="small mb-0" style="line-height: 1.6;">
                                                    <li>구글 계정 관리 -> [보안] 탭 이동</li>
                                                    <li>[2단계 인증]을 켜야 합니다.</li>
                                                    <li>검색창에 <strong>'앱 비밀번호'</strong> 검색 -> 생성 (이름: 지혜마루 등)
                                                    </li>
                                                    <li><strong>생성된 16자리 비밀번호</strong>를 복사해두세요. (로그인 비번 아님!)
                                                    </li>
                                                    <li><strong>SMTP 서버명</strong>:
                                                        <code>smtp.gmail.com</code>
                                                    </li>
                                                    <li><strong>SMTP 포트</strong>: <code>587</code></li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">보내는 메일 주소 (ID)</label>
                                <input type="email" class="form-control" id="smtpEmail" placeholder="your_id@naver.com"
                                    value="{{ settings.smtp_email or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">메일 비밀번호 (앱 비밀번호)</label>
                                <input type="password" class="form-control" id="smtpPassword"
                                    placeholder="비밀번호 또는 앱 비밀번호 16자리" value="{{ settings.smtp_password or '' }}">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">SMTP 호스트 (서버주소)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="smtpHost" placeholder="smtp.naver.com"
                                        value="{{ settings.smtp_host or '' }}">
                                    <button class="btn btn-outline-secondary" type="button"
                                        onclick="setPreset('naver')">네이버</button>
                                    <button class="btn btn-outline-secondary" type="button"
                                        onclick="setPreset('gmail')">구글</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">SMTP 포트</label>
                                <input type="text" class="form-control" id="smtpPort" placeholder="587"
                                    value="{{ settings.smtp_port or '587' }}">
                            </div>

                            <div class="col-12">
                                <hr>
                                <label class="form-label fw-bold text-primary">받는 담당자 이메일 (신청서 수신용)</label>
                                <input type="email" class="form-control" id="officialEmail"
                                    placeholder="official@gov.kr" value="{{ settings.official_email or '' }}">
                                <div class="form-text">이 주소로 신청서 PDF가 자동 발송됩니다.</div>

                                <hr>
                                <label class="form-label fw-bold text-primary"><i class="fas fa-clock me-1"></i>자동 메일 전송
                                    설정</label>
                                <div class="row g-2 mb-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="autoMailWeekly"
                                                {{ 'checked' if settings.auto_mail_weekly=='true' else '' }}>
                                            <label class="form-check-label" for="autoMailWeekly">
                                                매주 월요일 오전 9시 자동 발송 (주간)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="autoMailMonthly"
                                                {{ 'checked' if settings.auto_mail_monthly=='true' else '' }}>
                                            <label class="form-check-label" for="autoMailMonthly">
                                                매월 1일 오전 9시 자동 발송 (월간)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small fw-bold">자동 발송 파일 형식</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="autoMailFormat"
                                                id="autoFormatMerged" value="merged" {{ 'checked' if
                                                settings.auto_mail_format !='zip' else '' }}>
                                            <label class="form-check-label" for="autoFormatMerged">
                                                <i class="fas fa-file-pdf text-danger me-1"></i>하나의 PDF로 병합
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="autoMailFormat"
                                                id="autoFormatZip" value="zip" {{ 'checked' if
                                                settings.auto_mail_format=='zip' else '' }}>
                                            <label class="form-check-label" for="autoFormatZip">
                                                <i class="fas fa-file-archive text-warning me-1"></i>개별 PDF (ZIP)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text">활성화 시 담당자 이메일로 해당 기간의 신청서 모음이 자동 발송됩니다.</div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button class="btn btn-success px-4" id="btnSaveEmail">
                                <i class="fas fa-save me-1"></i>이메일 설정 저장
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Report Options Modal -->
    <div class="modal fade" id="bulkReportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-file-pdf me-2"></i>신청서 모음 전송</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="bulkReportDesc" class="text-muted mb-3"></p>
                    <label class="form-label fw-bold">파일 형식 선택</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulkFormat" id="formatMerged"
                                value="merged" checked>
                            <label class="form-check-label" for="formatMerged">
                                <i class="fas fa-file-pdf text-danger me-1"></i>하나의 PDF로 병합
                                <div class="text-muted small">파일 크기 작음, 연속 열람</div>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulkFormat" id="formatZip" value="zip">
                            <label class="form-check-label" for="formatZip">
                                <i class="fas fa-file-archive text-warning me-1"></i>개별 PDF (ZIP)
                                <div class="text-muted small">개별 관리/인쇄 편리</div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="sendBulkReportWithOptions()">
                        <i class="fas fa-paper-plane me-1"></i>전송
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Reservation Modal -->
    <div class="modal fade" id="cancelReservationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="fas fa-times-circle me-2"></i>예약 취소</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="cancelReservationId">
                    <p class="mb-3"><strong id="cancelReservationName"></strong> 님의 예약을 취소합니다.</p>

                    <label class="form-label fw-bold">취소 사유 선택</label>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cancelReason" id="reason1" value="시설 점검">
                            <label class="form-check-label" for="reason1">시설 점검</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cancelReason" id="reason2"
                                value="행사 일정 변경">
                            <label class="form-check-label" for="reason2">행사 일정 변경</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cancelReason" id="reason3"
                                value="사용목적 부적합 (도서관 목적 부합하지 않음)">
                            <label class="form-check-label" for="reason3">사용목적 부적합 (도서관 목적에 부합하지 않음)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cancelReason" id="reason4" value="중복 예약">
                            <label class="form-check-label" for="reason4">중복 예약</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cancelReason" id="reason5"
                                value="허위 정보 기재">
                            <label class="form-check-label" for="reason5">허위 정보 기재</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="cancelReason" id="reason6" value="기타"
                                checked>
                            <label class="form-check-label" for="reason6">기타 (직접 입력)</label>
                        </div>
                    </div>

                    <div id="customReasonDiv">
                        <label class="form-label fw-bold">취소 사유 입력</label>
                        <input type="text" class="form-control" id="customCancelReason" placeholder="취소 사유를 입력하세요"
                            disabled>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-warning" onclick="confirmCancelReservation()">
                        <i class="fas fa-times me-1"></i>예약 취소
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Block Management Tab -->
    <div class="tab-pane fade" id="block" role="tabpanel">
        <div class="card shadow">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold text-danger"><i class="fas fa-ban me-2"></i>차단된 사용자 목록</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>이름</th>
                                <th>전화번호</th>
                                <th>차단 사유</th>
                                <th>해제 예정일</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if blocked_users %}
                            {% for b in blocked_users %}
                            <tr>
                                <td class="fw-bold">{{ b.name }}</td>
                                <td>{{ b.phone }}</td>
                                <td class="text-danger small">{{ b.reason }}</td>
                                <td>{{ b.release_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-success"
                                        onclick="unblockUser('{{ b.phone }}', '{{ b.name }}')">
                                        <i class="fas fa-unlock me-1"></i>해제
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="fas fa-user-check fa-3x mb-3 opacity-50"></i>
                                    <p class="mb-0">차단된 사용자가 없습니다.</p>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms Management Tab -->
    <div class="tab-pane fade" id="terms" role="tabpanel">
        <div class="card shadow">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold"><i class="fas fa-file-alt me-2 text-secondary"></i>약관 및 개인정보 처리방침
                    설정
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3 text-end">
                    <input type="file" id="txtFileInput" accept=".txt" style="display: none;">
                    <input type="file" id="htmlFileInput" accept=".html" style="display: none;">

                    <button class="btn btn-outline-secondary btn-sm me-2" id="btnImportTxt">
                        <i class="fas fa-file-upload"></i> TXT 불러오기
                    </button>
                    <button class="btn btn-outline-secondary btn-sm me-2" id="btnExportTxt">
                        <i class="fas fa-file-download"></i> TXT 내보내기
                    </button>

                    <button class="btn btn-outline-primary btn-sm me-2" id="btnImportHtml">
                        <i class="fas fa-file-code"></i> HTML 불러오기
                    </button>
                    <button class="btn btn-outline-primary btn-sm me-2" id="btnExportHtml">
                        <i class="fas fa-file-code"></i> HTML 내보내기
                    </button>

                    <button class="btn btn-outline-secondary btn-sm" id="btnLoadTemplate">기본 양식
                        불러오기</button>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">개인정보 처리방침 내용</label>
                    <textarea class="form-control" id="privacyPolicy"
                        rows="15">{{ settings.privacy_policy or '' }}</textarea>
                    <div class="form-text">예약 시 사용자에게 보여지는 약관 내용입니다. HTML 태그 사용 가능.</div>
                </div>
                <div class="text-end">
                    <button class="btn btn-primary px-4" id="btnSaveTerms">
                        <i class="fas fa-save me-1"></i>약관 저장
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">관리자 비밀번호 변경</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">새 비밀번호</label>
                    <input type="password" class="form-control" id="newAdminPw">
                </div>
                <div class="mb-4">
                    <label class="form-label">새 비밀번호 확인</label>
                    <input type="password" class="form-control" id="confirmAdminPw">
                </div>
                <div class="d-grid">
                    <button type="button" class="btn btn-primary" id="btnChangePw">변경하기</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summernote Lite CSS -->
<style>
    /* Fix Summernote Lite Z-Index Conflict with Bootstrap 5 */
    .note-modal-backdrop {
        display: none !important;
        /* Nuclear option: Hide the backdrop that's covering the modal */
    }

    .note-modal {
        z-index: 2050 !important;
        /* Ensure modal itself is on top */
        display: block;
        /* Ensure it's treated as visible */
    }

    .note-dialog {
        z-index: 2060 !important;
    }

    /* Fix Fullscreen Mode */
    /* Fix Fullscreen Mode */
    .note-editor.note-frame.fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        /* Max Z-index */
        background-color: white !important;
        margin: 0 !important;
        border-radius: 0 !important;
    }

    /* Ensure editable area fills the screen minus toolbar */
    .note-editor.note-frame.fullscreen .note-editable {
        height: calc(100vh - 80px) !important;
        background-color: white !important;
    }

    /* Fix Modal Button Clipping */
    .note-modal-footer {
        box-sizing: content-box !important;
        padding: 20px !important;
        min-height: 60px !important;
    }

    .note-modal-content {
        overflow: visible !important;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<!-- jQuery (required by Summernote) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS removed (already loaded in base.html) -->
<!-- Summernote Lite JS -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
<!-- Summernote Korean Language Pack -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-ko-KR.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    // Stats Logic
    let statsLoaded = false;
    let statusChart = null;
    let weeklyChart = null;
    let hourlyChart = null;

    const statsTab = document.getElementById('stats-tab');

    if (statsTab) {
        statsTab.addEventListener('shown.bs.tab', function (event) {
            loadStats();
        });
    }

    function forceReloadStats() {
        statsLoaded = false;
        loadStats();
    }

    function loadStats() {
        if (statsLoaded) return;

        fetch('/api/admin/stats')
            .then(res => {
                if (res.status === 401) {
                    window.location.replace('/login?next=/admin');
                    // Throw special error to skip next .then
                    throw new Error("REDIRECT_LOGIN");
                }
                if (!res.ok) throw new Error("HTTP " + res.status);
                return res.json();
            })
            .then(data => {
                if (!data) return;
                console.log("[Stats Data]", data);
                renderCharts(data);
                statsLoaded = true;
            })
            .catch(err => {
                if (err.message === "REDIRECT_LOGIN") return; // Ignore Redirect Error
                console.error(err);
                alert('통계 로드 오류: ' + err.message);
            });
    }

    function renderCharts(data) {
        // Destroy old instances
        if (statusChart) statusChart.destroy();
        if (weeklyChart) weeklyChart.destroy();
        if (hourlyChart) hourlyChart.destroy();

        // Register Plugin
        try { Chart.register(ChartDataLabels); } catch (e) { }

        // --- 1. Status Pie (Premium Pastel Palette) ---
        const ctxStatus = document.getElementById('statusChart').getContext('2d');
        const statusMap = {
            'reserved': '예약중', 'checked_in': '이용중', 'ended': '종료',
            'cancelled': '취소', 'noshow_penalty': '노쇼'
        };
        const statusLabels = Object.keys(data.status).map(k => statusMap[k] || k);
        const statusValues = Object.values(data.status);

        // Premium Palette
        const statusColors = ['#4e73df', '#1cc88a', '#858796', '#f6c23e', '#e74a3b'];

        statusChart = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusValues,
                    backgroundColor: statusColors,
                    borderWidth: 0,
                    hoverOffset: 15,
                    borderRadius: 0, // No rounded corners
                    spacing: 0 // No spacing - SOLID ring
                }]
            },
            options: {
                cutout: '60%', // Thicker ring
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 1500,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value, ctx) => {
                            return value > 0 ? value : '';
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: { family: "'Noto Sans KR', sans-serif" }
                        }
                    }
                }
            }
        });

        // --- 2. Weekly Bar (Gradient + Rounded) ---
        const ctxWeekly = document.getElementById('weeklyChart').getContext('2d');
        // Create Gradient
        const gradientWeekly = ctxWeekly.createLinearGradient(0, 0, 0, 400);
        gradientWeekly.addColorStop(0, '#36b9cc'); // Info Color
        gradientWeekly.addColorStop(1, '#4e73df'); // Primary Color

        const days = ['월', '화', '수', '목', '금', '토', '일'];
        const weeklyValues = days.map((d, i) => data.weekly[String(i)] || data.weekly[i] || 0);
        const maxWeekly = Math.max(...weeklyValues);

        weeklyChart = new Chart(ctxWeekly, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: '예약 건수',
                    data: weeklyValues,
                    backgroundColor: gradientWeekly,
                    borderRadius: 10, // More rounded
                    barPercentage: 0.6,
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: maxWeekly + 5, // Add padding for labels
                        grid: { borderDash: [2, 4] },
                        ticks: { stepSize: 1 }
                    },
                    x: { grid: { display: false } }
                },
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#555',
                        font: { weight: 'bold' },
                        formatter: (value) => value > 0 ? value : ''
                    },
                    legend: { display: false }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeOutQuart',
                    delay: (context) => {
                        if (context.type === 'data' && context.mode === 'default') {
                            return context.dataIndex * 200; // Slower wave
                        }
                        return 0;
                    }
                }
            }
        });

        // --- 3. Hourly Line (Smooth + Filled Gradient) ---
        const ctxHourly = document.getElementById('hourlyChart').getContext('2d');
        const gradientHourly = ctxHourly.createLinearGradient(0, 0, 0, 400);
        gradientHourly.addColorStop(0, 'rgba(78, 115, 223, 0.5)');
        gradientHourly.addColorStop(1, 'rgba(78, 115, 223, 0.05)');

        const hours = Array.from({ length: 14 }, (_, i) => i + 9);
        const hourlyValues = hours.map(h => data.hourly[String(h)] || data.hourly[h] || 0);
        const maxHourly = Math.max(...hourlyValues);

        hourlyChart = new Chart(ctxHourly, {
            type: 'line',
            data: {
                labels: hours.map(h => `${h}시`),
                datasets: [{
                    label: '이용',
                    data: hourlyValues,
                    fill: true,
                    backgroundColor: gradientHourly,
                    borderColor: '#4e73df',
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#4e73df',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.4 // Smooth bezier
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: maxHourly + 5, // Padding for labels
                        grid: { borderDash: [2, 4] },
                        ticks: { stepSize: 1 }
                    },
                    x: { grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        align: 'top',
                        color: '#4e73df',
                        backgroundColor: '#fff',
                        borderRadius: 4,
                        font: { weight: 'bold' },
                        formatter: (value) => value > 0 ? value : ''
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    function saveMemo(id) {
        const memo = document.getElementById(`memo-${id}`).value;
        fetch(`/admin/memo/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ memo: memo })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) showAlert('메모가 저장되었습니다.');
            });
    }

    // Old saveAllSettings removed (replaced by saveGenericSettings)

    function setPreset(type) {
        if (type === 'naver') {
            document.getElementById('smtpHost').value = 'smtp.naver.com';
            document.getElementById('smtpPort').value = '587';
        } else if (type === 'gmail') {
            document.getElementById('smtpHost').value = 'smtp.gmail.com';
            document.getElementById('smtpPort').value = '587';
        }
    }

    // Telegram Listeners
    const btnSaveTelegram = document.getElementById('btnSaveTelegram');
    if (btnSaveTelegram) btnSaveTelegram.addEventListener('click', function () {
        const settings = {
            'telegram_token': document.getElementById('telegramToken').value,
            'telegram_chat_id': document.getElementById('telegramChatId').value
        };
        saveGenericSettings(settings, '텔레그램 설정이 저장되었습니다.');
    });

    const btnTestTelegram = document.getElementById('btnTestTelegram');
    if (btnTestTelegram) {
        btnTestTelegram.addEventListener('click', function () {
            const token = document.getElementById('telegramToken').value;
            const chatId = document.getElementById('telegramChatId').value;

            if (!token || !chatId) {
                showAlert('토큰과 채팅 ID를 먼저 입력해주세요.');
                return;
            }

            fetch('/admin/test_telegram', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token, chat_id: chatId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showAlert('테스트 메시지가 성공적으로 전송되었습니다!\n폰을 확인해보세요.');
                    } else {
                        showAlert('전송 실패:\n' + data.error);
                    }
                });
        });
    }
    // Cancel Reservation with Reason
    function openCancelModal(id, name) {
        document.getElementById('cancelReservationId').value = id;
        document.getElementById('cancelReservationName').textContent = name;
        document.getElementById('customCancelReason').value = '';
        document.getElementById('customCancelReason').disabled = true;
        // Reset to '기타' not checked
        document.getElementById('reason1').checked = true;
        new bootstrap.Modal(document.getElementById('cancelReservationModal')).show();
    }

    // Toggle custom reason input based on radio selection
    document.querySelectorAll('input[name="cancelReason"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const customInput = document.getElementById('customCancelReason');
            customInput.disabled = (this.value !== '기타');
            if (this.value !== '기타') {
                customInput.value = '';
            }
        });
    });

    function confirmCancelReservation() {
        const id = document.getElementById('cancelReservationId').value;
        const selectedReason = document.querySelector('input[name="cancelReason"]:checked').value;
        const customReason = document.getElementById('customCancelReason').value.trim();

        const reason = selectedReason === '기타' ? (customReason || '기타') : selectedReason;

        if (!reason) {
            showAlert('취소 사유를 입력해주세요.');
            return;
        }

        fetch(`/admin/cancel/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: reason })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('cancelReservationModal')).hide();
                    showAlert('✅ 예약이 취소되었습니다.\n\n📞 예약자에게 취소 사실을 연락해주세요!', () => location.reload());
                } else {
                    showAlert(data.error || '취소 실패');
                }
            });
    }

    // Restore cancelled reservation
    function restoreReservation(id, name) {
        showConfirm(`${name}님의 취소된 예약을 복원하시겠습니까?`, function () {
            fetch(`/admin/restore/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showAlert('예약이 복원되었습니다.', () => location.reload());
                    } else {
                        showAlert(data.error || '복원 실패');
                    }
                });
        });
    }

    function blockUser(phone, name) {
        showConfirm(`정말 ${name}님을 30일간 차단하시겠습니까?`, function () {
            fetch(`/admin/block/${phone}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showAlert('차단되었습니다.', function () {
                            location.reload();
                        });
                    }
                });
        });
    }

    function unblockUser(phone, name) {
        showConfirm(`${name}님의 차단을 해제하시겠습니까?`, function () {
            fetch(`/admin/unblock/${phone}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showAlert('차단이 해제되었습니다.', function () {
                            location.reload();
                        });
                    } else {
                        showAlert('해제 실패: ' + (data.error || 'Unknown'));
                    }
                });
        });
    }

    document.getElementById('btnChangePw').addEventListener('click', function () {
        const newPw = document.getElementById('newAdminPw').value;
        const confirmPw = document.getElementById('confirmAdminPw').value;

        if (!newPw) {
            showAlert('비밀번호를 입력하세요.');
            return;
        }

        if (newPw !== confirmPw) {
            showAlert('비밀번호가 일치하지 않습니다.');
            return;
        }

        fetch('/admin/change_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ new_password: newPw })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
                    showAlert('비밀번호가 변경되었습니다.\n다시 로그인해주세요.', function () {
                        location.href = '/logout';
                    });
                } else {
                    showAlert('변경 실패: ' + data.error);
                }
            });
    });

    // Pause Control
    const pauseSwitch = document.getElementById('pauseSwitch');
    const pauseReasonArea = document.getElementById('pauseReasonArea');
    const pauseReasonInput = document.getElementById('pauseReason');
    const btnApplyPause = document.getElementById('btnApplyPause');

    // Mode Radios
    const radioAll = document.getElementById('pauseAll');
    const radioPartial = document.getElementById('pausePartial');
    const dateRangeArea = document.getElementById('dateRangeArea');

    function updateDateVisibility() {
        if (radioPartial.checked) {
            dateRangeArea.classList.remove('d-none');
        } else {
            dateRangeArea.classList.add('d-none');
        }
    }
    radioAll.addEventListener('change', updateDateVisibility);
    radioPartial.addEventListener('change', updateDateVisibility);

    // Multiple Ranges Logic
    const rangesContainer = document.getElementById('rangesContainer');
    const addRangeBtn = document.getElementById('addRangeBtn');

    // Load initial ranges from backend (passed via template)
    let currentRanges = {{ settings.pause_ranges | tojson | safe }};
    if (!Array.isArray(currentRanges)) currentRanges = [];

    // Fallback: if empty but we have old fields (handled in backend but useful for UI state if needed, though we rely on ranges mostly now)
    // Actually backend passes 'current_ranges' correctly including fallback.

    function renderRanges() {
        rangesContainer.innerHTML = '';
        currentRanges.forEach((rng, index) => {
            addRangeInput(rng, index);
        });

        // If empty, add one empty
        if (currentRanges.length === 0) {
            addRangeInput(null, 0);
        }
    }

    function addRangeInput(data, index) {
        const row = document.createElement('div');
        row.className = 'input-group mb-2';
        row.innerHTML = `
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-calendar-alt text-muted"></i></span>
                                    <input type="text" class="form-control bg-white range-input" placeholder="기간 선택" readonly>
                                        <input type="text" class="form-control range-reason" placeholder="사유 (선택)" value="${data && data.reason ? data.reason : ''}">
                                            <button class="btn btn-outline-danger btn-remove-range" type="button"><i class="fas fa-times"></i></button>
        `;
        rangesContainer.appendChild(row);

        const input = row.querySelector('.range-input');

        // Init Flatpickr
        flatpickr(input, {
            mode: "range",
            locale: "ko",
            dateFormat: "Y-m-d",
            defaultDate: data ? [data.start, data.end] : [],
            onChange: function (selectedDates, dateStr, instance) {
                // Update internal state or just read from DOM on submit?
                // Reading from DOM on submit is easier for multiple inputs
            }
        });

        // Remove handler
        row.querySelector('.btn-remove-range').addEventListener('click', function () {
            row.remove();
        });
    }

    addRangeBtn.addEventListener('click', function () {
        const count = rangesContainer.querySelectorAll('.range-input').length;
        if (count >= 10) {
            showAlert('최대 10개까지만 설정할 수 있습니다.');
            return;
        }
        addRangeInput(null, count);
    });

    renderRanges();

    pauseSwitch.addEventListener('change', function () {
        if (this.checked) {
            pauseReasonArea.classList.add('show');
            pauseReasonInput.focus();
        } else {
            pauseReasonArea.classList.remove('show');
            if (confirm('예약 중지를 해제하시겠습니까? (공지사항이 복구됩니다)')) {
                togglePause(false, '', 'all', []);
            } else {
                this.checked = true;
            }
        }
    });

    btnApplyPause.addEventListener('click', function () {
        const reason = pauseReasonInput.value;
        const mode = radioPartial.checked ? 'partial' : 'all';

        if (!reason) {
            showAlert('중지 사유를 입력해주세요.');
            return;
        }

        let ranges = [];
        if (mode === 'partial') {
            const inputs = rangesContainer.querySelectorAll('.range-input');
            let hasValid = false;

            inputs.forEach(input => {
                if (input._flatpickr && input._flatpickr.selectedDates.length === 2) {
                    const start = input._flatpickr.formatDate(input._flatpickr.selectedDates[0], "Y-m-d");
                    const end = input._flatpickr.formatDate(input._flatpickr.selectedDates[1], "Y-m-d");
                    // siblings
                    const reason = input.closest('.input-group').querySelector('.range-reason').value;
                    ranges.push({ start: start, end: end, reason: reason });
                    hasValid = true;
                }
            });

            if (!hasValid) {
                showAlert('최소 1개 이상의 유효한 기간을 설정해야 합니다.');
                return;
            }
        }

        togglePause(true, reason, mode, ranges);
    });

    function togglePause(isPaused, reason, mode, ranges) {
        fetch('/admin/toggle_pause', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                pause: isPaused,
                reason: reason,
                mode: mode,
                ranges: ranges
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert(isPaused ? '설정이 적용되었습니다.' : '예약이 재개되었습니다.', function () {
                        location.reload();
                    });
                } else {
                    showAlert('설정 실패: ' + data.error);
                }
            });
    }
    function adminPreviewPdf(id) {
        fetch('/admin/reservations/' + id + '/preview', { method: 'POST' })
            .then(res => {
                if (res.ok) return res.blob();
                throw new Error('Preview Failed');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                window.open(url, '_blank');
            })
            .catch(err => showAlert('미리보기 오류'));
    }

    function sendOfficialPdf(id, name) {
        if (!confirm(name + '님의 신청서를 담당자 이메일로 전송하시겠습니까?')) return;

        fetch('/admin/reservations/' + id + '/send_official', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert('담당자 이메일로 전송되었습니다.');
                } else {
                    showAlert('전송 실패: ' + data.error);
                }
            })
            .catch(err => showAlert('서버 통신 오류'));
    }

    let selectedBulkPeriod = null;

    function showBulkReportModal(period) {
        selectedBulkPeriod = period;
        const map = { 'week': '지난 1주 (주간)', 'half': '지난 15일 (보름)', 'month': '지난 30일 (월간)', 'custom': '현재 검색 결과' };

        if (period === 'custom') {
            const date = document.getElementById('filterDate').value;
            const status = document.getElementById('filterStatus').value;
            const q = document.getElementById('filterSearch').value;

            if (!date && !status && !q) {
                showAlert('날짜, 상태, 또는 검색어를 먼저 입력해주세요.');
                return;
            }

            let filterDesc = [];
            if (date) filterDesc.push(`날짜: ${date}`);
            if (status) filterDesc.push(`상태: ${status}`);
            if (q) filterDesc.push(`검색: ${q}`);
            document.getElementById('bulkReportDesc').innerHTML = `<strong>${map[period]}</strong><br>${filterDesc.join('<br>')}`;
        } else {
            document.getElementById('bulkReportDesc').innerHTML = `<strong>${map[period]}</strong> 신청서를 담당자 이메일로 전송합니다.`;
        }

        const modal = new bootstrap.Modal(document.getElementById('bulkReportModal'));
        modal.show();
    }

    function sendBulkReportWithOptions() {
        const format = document.querySelector('input[name="bulkFormat"]:checked').value;
        const period = selectedBulkPeriod;

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('bulkReportModal')).hide();

        showProgress('📋 예약 데이터 조회 중...');

        // Simulate progress updates
        setTimeout(() => updateProgress('📄 PDF 생성 중...'), 1500);
        setTimeout(() => updateProgress(format === 'zip' ? '📦 ZIP 압축 중...' : '📄 PDF 병합 중...'), 3000);
        setTimeout(() => updateProgress('📧 메일 전송 중...'), 5000);

        let body = { period: period, format: format };

        if (period === 'custom') {
            body.date = document.getElementById('filterDate').value;
            body.status = document.getElementById('filterStatus').value;
            body.q = document.getElementById('filterSearch').value;
        }

        fetch('/admin/stats/report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        })
            .then(res => res.json())
            .then(data => {
                hideProgress();
                if (data.success) {
                    showAlert(`총 ${data.count}건의 신청서가 전송되었습니다.`);
                } else {
                    showAlert('전송 실패: ' + data.error);
                }
            })
            .catch(err => {
                hideProgress();
                showAlert('서버 통신 오류');
            });
    }

    // --- Generic Settings Save ---
    function saveGenericSettings(settingsObj, successMsg) {
        fetch('/api/admin/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ settings: settingsObj })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert(successMsg);
                } else {
                    showAlert('저장 실패: ' + data.error);
                }
            })
            .catch(err => showAlert('서버 통신 오류'));
    }

    // --- DOM Loaded Logic ---
    document.addEventListener('DOMContentLoaded', function () {
        // [CRITICAL] Initialize Search & Filter FIRST (Robustness)
        const searchInput = document.getElementById('filterSearch');
        const statusSelect = document.getElementById('filterStatus');
        const rows = document.querySelectorAll('.reservation-row');

        // 1. Init Flatpickr (Range Mode) - Wrapped in try-catch for CDN failure resilience
        let fp = null;
        try {
            if (typeof flatpickr !== 'undefined') {
                fp = flatpickr("#filterDate", {
                    mode: "range",
                    locale: "ko",
                    dateFormat: "Y-m-d",
                    onChange: function (selectedDates, dateStr) {
                        applyFilters();
                    }
                });
            } else {
                console.warn("Flatpickr CDN not loaded - date filter disabled");
            }
        } catch (e) {
            console.error("Flatpickr init failed:", e);
        }

        // 2. Filter Function
        function applyFilters() {
            const search = searchInput ? searchInput.value.toLowerCase().replace(/[()]/g, '').trim() : '';
            const status = statusSelect ? statusSelect.value : '';

            // Get Dates (only if Flatpickr loaded successfully)
            let start = null;
            let end = null;
            if (fp && fp.selectedDates && fp.selectedDates.length > 0) {
                start = fp.formatDate(fp.selectedDates[0], "Y-m-d");
                end = fp.selectedDates.length > 1
                    ? fp.formatDate(fp.selectedDates[1], "Y-m-d")
                    : start;
            }

            rows.forEach(row => {
                const rowDate = row.dataset.date || '';
                const rowSearch = (row.dataset.search || '').toLowerCase();
                const rowStatus = row.dataset.status || '';

                // Date Check
                let showDate = true;
                if (start && end && rowDate) {
                    if (rowDate < start || rowDate > end) showDate = false;
                }

                // Text Check
                let showText = true;
                if (search && !rowSearch.includes(search)) showText = false;

                // Status Check
                let showStatus = true;
                if (status && rowStatus !== status) showStatus = false;

                row.style.display = (showDate && showText && showStatus) ? '' : 'none';
            });
        }

        // 3. Attach Listeners
        if (searchInput) {
            searchInput.addEventListener('input', applyFilters);
            // Populate Autocomplete
            const datalist = document.getElementById('reservationOptions');
            if (datalist) {
                const uniqueValues = new Set();
                rows.forEach(row => {
                    const name = row.dataset.name;
                    const phone = row.dataset.phone;
                    if (name && phone) uniqueValues.add(`${name} (${phone})`);
                });
                uniqueValues.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    datalist.appendChild(option);
                });
            }
        }
        if (statusSelect) {
            statusSelect.addEventListener('change', applyFilters);
        }

        // Expose reset to window
        window.resetFilters = function () {
            if (fp) fp.clear();
            if (searchInput) searchInput.value = '';
            if (statusSelect) statusSelect.value = '';
            applyFilters();
        }

        // Initial Filter Apply
        if (searchInput) {
            // searchInput.value = ''; // Don't clear on reload, maybe user wants to keep it? actually reset is better for UX
            applyFilters();
        }

        // --- End of Search Logic ---

        // Email Settings Save
        const btnSaveEmail = document.getElementById('btnSaveEmail');
        if (btnSaveEmail) {
            btnSaveEmail.addEventListener('click', function () {
                const settings = {
                    'smtp_email': document.getElementById('smtpEmail').value,
                    'smtp_password': document.getElementById('smtpPassword').value,
                    'smtp_host': document.getElementById('smtpHost').value,
                    'smtp_port': document.getElementById('smtpPort').value,
                    'official_email': document.getElementById('officialEmail').value,
                    'auto_mail_weekly': document.getElementById('autoMailWeekly').checked ? 'true' : 'false',
                    'auto_mail_monthly': document.getElementById('autoMailMonthly').checked ? 'true' : 'false',
                    'auto_mail_format': document.querySelector('input[name="autoMailFormat"]:checked').value
                };
                saveGenericSettings(settings, '이메일 설정이 저장되었습니다.');
            });
        }

        // Main Settings Save
        const btnSaveSettings = document.getElementById('btnSaveSettings');
        if (btnSaveSettings) {
            btnSaveSettings.addEventListener('click', function () {
                const settings = {
                    'notice_text': document.getElementById('setNotice').value,
                    'wifi_info': document.getElementById('setWifi').value,
                    'door_pw': document.getElementById('setDoor').value
                };
                saveGenericSettings(settings, '설정이 저장되었습니다.');
            });
        }

        // Initialize Summernote (Protected)
        try {
            if (typeof $ !== 'undefined' && $.fn.summernote) {
                $('#privacyPolicy').summernote({
                    placeholder: '약관 내용을 입력하세요.',
                    tabsize: 2,
                    height: 400,
                    toolbar: [
                        ['style', ['style']],
                        ['font', ['bold', 'underline', 'clear']],
                        ['color', ['color']],
                        ['para', ['ul', 'ol', 'paragraph']],
                        ['table', ['table']],
                        ['insert', ['link', 'picture']],
                        ['view', ['help']]
                    ],
                    lang: 'ko-KR'
                });
            } else {
                console.warn("Summernote lib missing or jQuery missing.");
            }
        } catch (e) {
            console.error("Summernote init failed:", e);
        }

        // Terms Save
        const btnSaveTerms = document.getElementById('btnSaveTerms');
        if (btnSaveTerms) {
            btnSaveTerms.addEventListener('click', function () {
                const settings = {
                    'privacy_policy': $('#privacyPolicy').val()
                };
                saveGenericSettings(settings, '약관이 저장되었습니다.');
            });
        }

        // Default Terms Template
        const btnLoadTemplate = document.getElementById('btnLoadTemplate');
        if (btnLoadTemplate) {
            btnLoadTemplate.addEventListener('click', function () {
                showConfirm('작성 중인 내용이 사라집니다. 기본 양식을 불러오시겠습니까?', function () {
                    const defaultTerms = `<div class="lh-sm">
    <h5 class="fw-bold text-center mb-4">[이용 약관 및 개인정보 처리방침]</h5>
    <h6 class="fw-bold text-primary"><i class="fas fa-book-reader me-2"></i>제1조 (시설 이용 수칙)</h6>
    <ol class="small text-muted mb-4">
        <li><strong>이용 시간 준수:</strong> 예약 시간 내에 입실 및 퇴실(정리 포함)을 완료해야 합니다.</li>
        <li><strong>정리 정돈:</strong> 퇴실 시 사용한 물품(책상, 의자, 전자기기 등)을 제자리에 정리합니다.</li>
        <li><strong>입실 체크:</strong> 시설 이용 시 반드시 QR 체크인 또는 스마트 체크인을 진행해야 합니다.</li>
        <li><strong>책임:</strong> 시설물 파손, 분실, 훼손 시 원상복구 또는 배상의 책임이 있습니다.</li>
    </ol>
    <h6 class="fw-bold text-danger"><i class="fas fa-exclamation-circle me-2"></i>제2조 (예약 취소 및 노쇼 정책)</h6>
    <ul class="small text-muted mb-4">
        <li>당일 취소 또는 예고 없는 미방문(No-Show) 발생 시, <strong>향후 30일간 예약이 제한</strong>될 수 있습니다.</li>
    </ul>
    <hr class="my-3">
    <h6 class="fw-bold text-success"><i class="fas fa-user-shield me-2"></i>제3조 (개인정보 수집 및 이용 동의)</h6>
    <p class="small fw-bold mt-2">1. 개인정보의 수집 및 이용 목적</p>
    <p class="small text-muted">지혜마루 작은도서관은 시설 예약 및 출입 관리를 위해 아래와 같은 개인정보를 수집합니다.</p>
    <p class="small fw-bold mt-3">2. 수집하는 개인정보의 항목</p>
    <ul class="small text-muted">
        <li>필수항목: 이름, 전화번호, 비밀번호(암호화)</li>
        <li>기타: 예약목적, 전자서명, 출입로그</li>
    </ul>
    <p class="small fw-bold mt-3">3. 개인정보의 보유 및 이용 기간</p>
    <p class="small text-muted mb-1">이용자의 개인정보는 원칙적으로 개인정보의 수집 및 이용목적이 달성되면 지체 없이 파기합니다.</p>
    <p class="small fw-bold mt-3">4. 동의 거부 권리</p>
    <p class="small text-muted">귀하는 개인정보 수집 및 이용에 동의하지 않을 권리가 있습니다. 단, 동의를 거부할 경우 시설 예약 및 이용이 제한될 수 있습니다.</p>
</div>`;
                    $('#privacyPolicy').summernote('code', defaultTerms);
                });
            });
        }

        // Import TXT
        const btnImportTxt = document.getElementById('btnImportTxt');
        const txtFileInput = document.getElementById('txtFileInput');
        if (btnImportTxt && txtFileInput) {
            btnImportTxt.addEventListener('click', () => txtFileInput.click());
            txtFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    const text = e.target.result;
                    const htmlContent = text.replace(/\n/g, '<br>');
                    $('#privacyPolicy').summernote('code', htmlContent);
                    showAlert('TXT 파일을 불러왔습니다.');
                    txtFileInput.value = '';
                };
                reader.readAsText(file, 'UTF-8');
            });
        }

        // Export TXT
        const btnExportTxt = document.getElementById('btnExportTxt');
        if (btnExportTxt) {
            btnExportTxt.addEventListener('click', function () {
                let htmlContent = $('#privacyPolicy').summernote('code');
                let textContent = htmlContent
                    .replace(/<br\s*\/?>/gi, '\n')
                    .replace(/<\/p>/gi, '\n')
                    .replace(/<\/div>/gi, '\n')
                    .replace(/<\/li>/gi, '\n');
                let tmp = document.createElement("DIV");
                tmp.innerHTML = textContent;
                let plainText = tmp.textContent || tmp.innerText || "";
                plainText = plainText.replace(/\n\s*\n/g, '\n\n').trim();
                const blob = new Blob([plainText], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const date = new Date();
                a.download = `지혜마루약관_${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}.txt`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            });
        }

        // Import HTML
        const btnImportHtml = document.getElementById('btnImportHtml');
        const htmlFileInput = document.getElementById('htmlFileInput');
        if (btnImportHtml && htmlFileInput) {
            btnImportHtml.addEventListener('click', () => htmlFileInput.click());
            htmlFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    const htmlContent = e.target.result;
                    $('#privacyPolicy').summernote('code', htmlContent);
                    showAlert('HTML 파일을 불러왔습니다.');
                    htmlFileInput.value = '';
                };
                reader.readAsText(file, 'UTF-8');
            });
        }

        // Export HTML
        const btnExportHtml = document.getElementById('btnExportHtml');
        if (btnExportHtml) {
            btnExportHtml.addEventListener('click', function () {
                let htmlContent = $('#privacyPolicy').summernote('code');
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const date = new Date();
                a.download = `지혜마루약관_${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}.html`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            });
        }
    });

    // Global Function for Excel Download
    function downloadExcelWithFilters() {
        const date = document.getElementById('filterDate').value;
        const status = document.getElementById('filterStatus').value;
        const q = document.getElementById('filterSearch').value;

        const params = new URLSearchParams();
        if (date) params.append('date', date);
        if (status) params.append('status', status);
        if (q) params.append('q', q);

        const queryString = params.toString();
        const url = `/admin/download_excel` + (queryString ? `?${queryString}` : '');

        console.log('[DEBUG] Excel Download URL:', url); // 디버그용
        window.location.href = url;
    }
</script>
{% endblock %}